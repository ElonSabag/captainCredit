"use strict";define("Analytics/Boards/RollupQueries",["require","exports","Analytics/Boards/BoardsQueries/WitFieldUtilities","Analytics/Common/AnalyticsCacheableQueryBase","Analytics/Common/Utilities/QueryUtilities"],(function(e,t,s,r,a){var o,i,n;o=t.Contracts={},(n=t.Contracts.RollupType||(t.Contracts.RollupType={}))[n.Progress=0]="Progress",n[n.Total=1]="Total",(i=t.Contracts.RollupAggregation||(t.Contracts.RollupAggregation={}))[i.Count=1]="Count",i[i.Sum=2]="Sum",function(e){t.RollupQuery={};class i extends r.AnalyticsCacheableQueryBase{constructor(e,t,s,r,a){super(i.commandName,i.generateQueryOptions(e,t,s,r,a)),this.workItemIds=e,this.rollupMetric=t,this.projectId=s,this.backlogWorkItemTypes=r,this.syncDateConditions=a}static generateQueryOptions(e,t,s,r,o){const n=i.getMultiFilterClause("WorkItemId",e),l=`Descendants(${i.getDescendantsApplyClause(t,r)})`;return{entityType:"WorkItems",oDataVersion:a.latestODataVersion,project:s,batchRequestMode:1,$filter:n,$select:"WorkItemId",$expand:l,getProviderSyncDates:!0,expectSinglePage:e.length<i.axServerPageSize,syncDateConditions:o,getBatchResponseInnerHeaders:!!o}}static getMultiFilterClause(e,t){let s="";return t&&t.forEach((t=>{"string"==typeof t&&(t=`'${t}'`),s?s+=` or ${e} eq ${t}`:s=`${e} eq ${t}`})),s}static getDescendantsApplyClause(e,t){const s="WorkItemType";let r="";e.backlogFilter?r=i.getMultiFilterClause(s,t):e.workItemTypeFilter&&(r=i.getMultiFilterClause(s,[e.workItemTypeFilter]));const a="$apply=filter(StateCategory ne null"+(r?` and ${r})`:")"),n=i.getAggregateClause(e);if(e.type===o.RollupType.Progress){return[a,"compute(StateCategory eq 'Completed' as isCompleted)",`groupby((isCompleted), ${n})`].join("/")}return[a,n].join("/")}static getAggregateClause(e){let t="aggregate(";switch(e.aggregation){case o.RollupAggregation.Sum:if(!e.aggregationField)throw new Error("Missing aggregation field");return t+=`${s.WitFieldUtilities.getFieldODataPropertyName(e.aggregationField)} with sum as Sum)`,t;case o.RollupAggregation.Count:default:return t+="$count as Count)",t}}getQueryName(){return`RollupQuery${JSON.stringify(this.workItemIds)}${JSON.stringify(this.rollupMetric)}`}interpretQueryResults(e){const t={results:e.value,syncDates:{}},s="ProviderSyncDates:",r=e["@vsts.warnings"];if(r){let e="";r.some((t=>{if(0===t.indexOf(s))return e=t.substring(s.length),!0}));let a=[],o=null,i=null;try{a=JSON.parse(e)}catch(e){}for(const e of a){const t=Date.parse(e.ProviderSyncDate);"WorkItemRevision"===e.ProviderTableName?o=Math.min(t,o||t):"WorkItemLink"===e.ProviderTableName&&(i=Math.min(t,i||t))}o&&o>0&&(t.syncDates.workItemsChangedUtcTimestamp=o),i&&i>0&&(t.syncDates.workItemLinksChangedUtcTimestamp=i)}return t}inspectResponseFormat(e){e&&e.responseStatus&&"304"===e.responseStatus.StatusCode||super.inspectResponseFormat(e)}}t.RollupQuery.RollupQuery=i,i.commandName="RollupQuery",i.axServerPageSize=1e3}()}),["Contracts","RollupQuery"]),document.dispatchEvent(new CustomEvent("scriptLoaded",{cancelable:!1,detail:{id:"ms.vss-analytics.rollup-queries"}}));