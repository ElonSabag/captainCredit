"use strict";define("Wit/Common/QueryListServices",["require","exports","Tfs/Platform/Page","VSS/Core/Observable","VSS/Platform/Context","VSS/Platform/FPS","VSSUI/Utilities/TreeItemProvider","Wit/Clients/Wit/RestClient/WorkItemTracking","Wit/Common/QueryUtils/ErrorHandlingUtils","Wit/Common/QueryUtils/Models","Wit/Common/QueryUtils/QueriesHubConstants","Wit/Common/QueryUtils/RoutingUtils","VSS/Core/Util/String"],(function(e,t,i,r,s,o,n,a,d,l,u,v,h){var m;m=t.Resources={},t.Resources.ProjectNotFoundError="Project not found",t.Resources.QueryItemNotFoundError="Query item not found",function(e){t.IQueryListService={},t.IQueryListService.c_myFavoritesGroupKey="MY_FAVORITES_GROUP";const c="ms.vss-work-web.query-list-data-provider";class y extends s.VssService{constructor(){super(...arguments),this._isDialogOpen=new r.ObservableValue(!1),this._isLoading=new r.ObservableValue(!0),this._saveQueryDialogProps=new r.ObservableValue({mode:l.QuerySaveDialogMode.NewFolder}),this._queryTree=new n.TreeItemProvider([]),this._favoriteGroups=new r.ObservableArray([]),this._expandedFolders=[],this._queryFolderItem=new r.ObservableValue(void 0),this._queryItemPromisesByPath=new Map,this._queryItemPromisesById=new Map,this.moveQuery=async(e,t,i)=>{var r,s,o,n;const a=await this._moveQuery(e,t,i),d=this._convertQueriesToTreeItems([a],a.depth),l=(null===(s=null===(r=e.parentItem)||void 0===r?void 0:r.underlyingItem.childItems)||void 0===s?void 0:s.length)<=1?[{items:[{data:{isEmptyFolderContext:!0,isLoadingContext:!1}}]}]:void 0;this._queryTree.splice(null===(o=e.parentItem)||void 0===o?void 0:o.underlyingItem,[e.underlyingItem],l);const u=null===(n=t.underlyingItem.childItems)||void 0===n?void 0:n.filter((e=>e.data.isEmptyFolderContext));return this._queryTree.splice(t.underlyingItem,u,[{items:d}]),this._updateFavoriteGroups(e.underlyingItem.data,a),a},this.onDismiss=()=>{this._isDialogOpen.value=!1},this.onNewFolderClick=(e,t,i)=>{this._isDialogOpen.value=!0,this._saveQueryDialogProps.value={mode:l.QuerySaveDialogMode.NewFolder,onDismiss:()=>{this.onDismiss(),null==i||i()},queryItem:t}},this.onRenameItemClick=(e,t,i)=>{this._isDialogOpen.value=!0,this._saveQueryDialogProps.value={mode:t.isFolder?l.QuerySaveDialogMode.RenameFolder:l.QuerySaveDialogMode.RenameQuery,onDismiss:()=>{this.onDismiss(),null==i||i()},queryItem:t}},this.onEditorClick=(e,t,i)=>{const r=this.pageContext.getService("IVssTelemetryService");let s;r&&r.publishEvent("bolt-new-queries","BoltNewQueries.QueryAction",{key:t?"new-query":"edit-query",pivot:e,source:"command-button"}),s=t?(0,v.getEditorUrl)(this.pageContext,void 0,i):(0,v.getEditorUrl)(this.pageContext,i),(0,o.onClickFPS)(this.pageContext,s,!0)},this.onQueryClick=(e,t)=>{const i=(0,v.getQueryUrl)(this.pageContext,t);(0,o.onClickFPS)(this.pageContext,i,!0)},this.toggleTreeItem=async e=>{var t;const i=e.underlyingItem;if(i.data.hasChildren&&!i.data.children){const i=null===(t=e.underlyingItem.childItems)||void 0===t?void 0:t.map((e=>(e.data.isEmptyFolderContext=!0,e.data.isLoadingContext=!0,Object.assign({},e))));this._queryTree.splice(e.underlyingItem,e.underlyingItem.childItems,[{items:i}]),this._updateQueryChildren(e)}if(this._queryTree.toggle(i),i.expanded)this._expandedFolders.push(i.data.id);else{const e=i.data.id,t=this._expandedFolders.indexOf(e);t>-1&&this._expandedFolders.splice(t,1)}},this.searchQueries=async e=>{var t,r;const s=null===(r=null===(t=(0,i.getTFSPageData)(this.pageContext))||void 0===t?void 0:t.project)||void 0===r?void 0:r.id;if(s)return await this._workItemTrackingClient.searchQueries(s,e,u.MaximumQueriesToShow,1);(0,d.reportError)(this.pageContext,"search-queries",m.ProjectNotFoundError)},this._findFavoriteInTree=(e,t)=>{const i=this._queryTree.value.find((t=>!t.underlyingItem.data.isEmptyFolderContext&&t.underlyingItem.data.id===e));i&&!i.underlyingItem.data.isEmptyFolderContext&&(i.underlyingItem.data.isFavoriteObservable.value=t)},this._isExpanded=e=>this._expandedFolders.indexOf(e)>-1,this._updateFavoriteGroups=(e,t)=>{this._favoriteGroups.value.forEach(((i,r)=>{const s=i.items.findIndex((t=>t.id===e.id));-1!==s&&(t?i.items.splice(s,1,t):i.items.splice(s,1),this._favoriteGroups.notify({index:r},"change"))}))}}get isDialogOpen(){return this._isDialogOpen}get isLoading(){return this._isLoading}get queryFolderItem(){return this._queryFolderItem}get queryTree(){return this._queryTree}get favoriteGroups(){return this._favoriteGroups}get saveQueryDialogProps(){return this._saveQueryDialogProps}get rootMyQueriesFolderId(){return this._queryTree.roots[0].data.id}_serviceStart(e){super._serviceStart(e),this._workItemTrackingClient=(0,a.getWorkItemTrackingClient)(e)}addFavorite(e){this._favoriteGroups.value.length>0&&this._favoriteGroups.value.forEach((t=>{let i=t.items.find((t=>t.id===e.id));i?i.isFavoriteObservable.value=!0:i||t.id!==u.MyFavoritesGroupKey||t.items.splice(this._favoriteGroups.length,0,e)})),this._findFavoriteInTree(e.id,!0)}addTeamFavorite(e,t,i){const r=this._favoriteGroups.value.find((e=>e.id===t)),s={id:t,name:i,items:[e]};r?r.items.splice(r.items.length,0,e):this._favoriteGroups.splice(this._favoriteGroups.length,0,s),this._favoriteGroups.notify({index:0,changedItems:[s]},"push")}removeFavorite(e){this._favoriteGroups.value.forEach((t=>{const i=t.items.findIndex((t=>t.id===e.id));-1!=i&&(t.items[i].isFavoriteObservable.value=!1,t.id===u.MyFavoritesGroupKey&&t.items.splice(i,1))})),this._findFavoriteInTree(e.id,!1)}removeTeamFavorite(e,t,i){let r=!1;const s=this._favoriteGroups.value.find((e=>e.id===t));if(s){let t=s.items.findIndex((t=>t.id===e.id));1===s.items.length&&(r=!0),s.items.splice(t,1)}const o=this._favoriteGroups.value.findIndex((e=>e.id===t));o>-1&&r&&this._favoriteGroups.splice(o,1);const n={id:t,name:i,items:[e]};this._favoriteGroups.notify({index:0,changedItems:[n]},"pop")}canDrag(e){return!e.isLoadingContext&&!e.isEmptyFolderContext&&!e.isFolder}getQueries(){const e=this.pageContext.getService("IVssContributionService").getData(c);this.loadQueries(e)}async getQueriesAsync(){this._isLoading.value=!0;const e=this.pageContext.getService("IVssContributionService"),t=await e.getDataAsync(c,{loadAllQueries:!0});this.loadQueries(t)}async getSharedQueriesByProjectIDAsync(e){this._isLoading.value=!0;const t=this.pageContext.getService("IVssContributionService"),i=await t.getDataAsync(c,{loadAllQueries:!0,projectID:e,loadSharedQueries:!0});this.loadQueries(i)}loadQueries(e){const t=this.pageContext.getService("IVssContributionService");if(!e){const e=t.getDataProviderExceptions()[c];e&&(0,d.reportError)(this.pageContext,"New-Queries-Hub",e.message)}if(null==e?void 0:e.allItems){const t=g(e.allItems);t.forEach((e=>{e.children=g(e.children)})),this._queryTree=new n.TreeItemProvider(this._convertQueriesToTreeItems(t,0))}(null==e?void 0:e.queryFavoriteGroups)&&(this._favoriteGroups.value=null==e?void 0:e.queryFavoriteGroups.map((e=>{const t=e.items.map((e=>{var t;return Object.assign(Object.assign({},e),{depth:0,isFavoriteObservable:new r.ObservableValue(null!==(t=e.isFavorite)&&void 0!==t&&t),isEmptyFolderContext:!1,isLoadingContext:!1})}));return{id:e.id,name:e.name,items:t}}))),this._queryFolderItem.value=(null==e?void 0:e.queryItem)||this._queryFolderItem.value,this._isLoading.value=!1}async createQuery(e,t,r){var s,o,n,a;const l=null===(o=null===(s=(0,i.getTFSPageData)(this.pageContext))||void 0===s?void 0:s.project)||void 0===o?void 0:o.id;if(l){const i=await this._workItemTrackingClient.createQuery(e,l,t),s=this._queryTree.value.find((e=>!e.underlyingItem.data.isEmptyFolderContext&&e.underlyingItem.data.path===t));if(s){const e=this._convertQueriesToTreeItems([i],s.depth+1),t=null===(n=null==s?void 0:s.underlyingItem.childItems)||void 0===n?void 0:n.filter((e=>e.data.isEmptyFolderContext));this._queryTree.splice(null==s?void 0:s.underlyingItem,t,[{items:e}]),this._queryFolderItem.value&&this._queryFolderItem.value.id===s.underlyingItem.data.id&&(null===(a=this.queryFolderItem.value)||void 0===a||a.children.unshift(e[0].data),this._queryFolderItem.notify(this._queryFolderItem.value,"add"))}if(r){const e=(0,v.getEditorUrl)(this.pageContext,i.id);(0,v.onClickQuerySaveFPS)(this.pageContext,e,!0)}return i}(0,d.reportError)(this.pageContext,"create-query",m.ProjectNotFoundError)}deleteQuery(e){var t,i,r;const s=this._queryTree.value.find((t=>!t.underlyingItem.data.isEmptyFolderContext&&t.underlyingItem.data.id===e.id));if(s){if(this._queryTree.remove(s.underlyingItem),this._queryFolderItem){const e=null!==(r=null===(i=null===(t=this.queryFolderItem.value)||void 0===t?void 0:t.children)||void 0===i?void 0:i.findIndex((e=>e.id===s.underlyingItem.data.id)))&&void 0!==r?r:void 0;e&&(this._queryFolderItem.value.children.splice(e,1),this._queryFolderItem.notify(this._queryFolderItem.value,"remove"))}this._updateFavoriteGroups(e)}else(0,d.reportError)(this.pageContext,"delete-query",m.QueryItemNotFoundError)}async getQueryByPath(e,t){var r,s;const o=t||(null===(s=null===(r=(0,i.getTFSPageData)(this.pageContext))||void 0===r?void 0:r.project)||void 0===s?void 0:s.id),n=this._queryItemPromisesByPath.get(e);if(n)return n;if(o){const t=this._workItemTrackingClient.getQuery(o,e,1,0);return this._queryItemPromisesByPath.set(e,t),t}(0,d.reportError)(this.pageContext,"loading-query-path",m.ProjectNotFoundError)}async getQueryChildren(e,t){const i=await this.getQueryWithChildren(e.data,t);return this._convertQueriesToTreeItems([i],e.data.depth)[0]}async getQueryWithChildren(e,t){var s,o;const n=null===(o=null===(s=(0,i.getTFSPageData)(this.pageContext))||void 0===s?void 0:s.project)||void 0===o?void 0:o.id;if(n)try{let i=this._queryItemPromisesById.get(e.id);i&&!t||(i=this._workItemTrackingClient.getQuery(n,e.id,1,2),this._queryItemPromisesById.set(e.id,i));const s=await i,o=Object.assign(Object.assign({},s),{depth:e.depth,isLoadingContext:!1,isEmptyFolderContext:!1,isFavoriteObservable:e.isFavoriteObservable}),a=o.children.map((e=>{var t;const i=null===(t=this._favoriteGroups.value.find((e=>e.id===u.MyFavoritesGroupKey)))||void 0===t?void 0:t.items.find((t=>t.id===e.id));return Object.assign(Object.assign({},e),{depth:0,isFavoriteObservable:new r.ObservableValue(!!i),isEmptyFolderContext:!1,isLoadingContext:!1})}));return o.children=a,o}catch(e){(0,d.reportError)(this.pageContext,"loading-query-children",e.message)}return e}async updateQuery(e,t){var r,s,o,n,a,l,u;try{const d=null===(s=null===(r=(0,i.getTFSPageData)(this.pageContext))||void 0===r?void 0:r.project)||void 0===s?void 0:s.id;if(!d)throw new Error(m.ProjectNotFoundError);const u=await this._workItemTrackingClient.updateQuery(e,d,e.id),v=Object.assign(Object.assign({},u),{depth:null!==(o=null==t?void 0:t.underlyingItem.data.depth)&&void 0!==o?o:e.depth,isEmptyFolderContext:!1,isLoadingContext:!1,isFavoriteObservable:null!==(n=null==t?void 0:t.underlyingItem.data.isFavoriteObservable)&&void 0!==n?n:e.isFavoriteObservable});if(v.children=null!==(a=null==t?void 0:t.underlyingItem.data.children)&&void 0!==a?a:e.children,t){const e=this._convertQueriesToTreeItems([v],t.depth);this._queryTree.splice(null===(l=t.parentItem)||void 0===l?void 0:l.underlyingItem,[t.underlyingItem],[{items:e,insertAfter:t.underlyingItem}]),this._updateFavoriteGroups(t.underlyingItem.data,v)}return v}catch(i){return(0,d.reportError)(this.pageContext,"move-queries",i.message),null!==(u=null==t?void 0:t.underlyingItem.data)&&void 0!==u?u:e}}_convertQueriesToTreeItems(e,t){let i=[];if(e){const r=e.sort(((e,t)=>h.localeComparer(e.name,t.name))),s=r.filter((e=>e.isFolder)),o=r.filter((e=>!e.isFolder));s&&s.forEach((e=>{const r=0===t||this._isExpanded(e.id),s={childItems:this._convertQueriesToTreeItems(e.children,t+1),expanded:r,data:Object.assign(Object.assign({},e),{depth:t})};i.push(s)})),o&&o.forEach((e=>{const t=(0,v.getQueryUrl)(this.pageContext,e.id);i.push({data:Object.assign(Object.assign({},e),{linkProps:{href:t}})})}))}else i.push({data:{isEmptyFolderContext:!0,isLoadingContext:!1}});return i}async _updateQueryChildren(e){var t;const i=await this.getQueryChildren(e.underlyingItem);i&&this._queryTree.splice(null===(t=e.parentItem)||void 0===t?void 0:t.underlyingItem,[e.underlyingItem],[{insertAfter:e.underlyingItem,items:[i]}])}async _moveQuery(e,t,r){var s,o;if(t.underlyingItem.data.isEmptyFolderContext)return e.underlyingItem.data;const n=t,a=e.underlyingItem.data.path,l=n.underlyingItem.data.path,u=e.underlyingItem.data.path.endsWith("/")?e.underlyingItem.data.path:e.underlyingItem.data.path+"/";if(a===l||e.underlyingItem.data.isFolder&&0===l.indexOf(u)||e.underlyingItem.data.path===l)return e.underlyingItem.data;const v=n.underlyingItem.data.isPublic;r=r||e.underlyingItem.data.name;const h=Object.assign(Object.assign({},e.underlyingItem.data),{isPublic:v,name:r,path:`${n.underlyingItem.data.path}/${r}`});if(this._queryTree.value.find((e=>{!e.underlyingItem.data.isEmptyFolderContext&&(e.underlyingItem.data.path,h.path)})))throw new Error(m.QueryItemNotFoundError);try{const e=null===(o=null===(s=(0,i.getTFSPageData)(this.pageContext))||void 0===s?void 0:s.project)||void 0===o?void 0:o.id;if(!e)throw new Error(m.ProjectNotFoundError);return await this._workItemTrackingClient.createQuery(h,e,n.underlyingItem.data.id)}catch(t){return(0,d.reportError)(this.pageContext,"move-queries",t.message),e.underlyingItem.data}}}function g(e){return e?e.map((e=>{var t;return Object.assign(Object.assign({},e),{depth:0,isFavoriteObservable:new r.ObservableValue(null!==(t=e.isFavorite)&&void 0!==t&&t),isEmptyFolderContext:!1,isLoadingContext:!1})})):[]}s.Services.add("IQueryListService",{serviceFactory:y})}()}),["Resources","IQueryListService"]),document.dispatchEvent(new CustomEvent("scriptLoaded",{cancelable:!1,detail:{id:"ms.vss-work-web.common-query-list-services"}}));