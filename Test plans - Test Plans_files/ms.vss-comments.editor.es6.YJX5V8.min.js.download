"use strict";define("Comments/Editor",["require","exports","Comments/Common/Resources","react","VSS/Core/Observable","VSS/Platform/Layout","VSSUI/Button","VSSUI/Dialog","VSSUI/Observer","VSSUI/Util"],(function(t,e,i,s,o,r,n,a,l,c){var m,d;m=e.Resources={},e.Resources.ConfirmDiscardCommentDraft="Are you sure you want to discard this draft?",e.Resources.Discard="Discard",e.Resources.Update="Update",e.Resources.DefaultCommentEditorAriaLabel="Comment",function(t){d=e[t]={};const h=["ms.vss-markdown.markdown-editor"],p=["image/*"],u={"image/jpg":"jpg","image/jpeg":"jpg","image/png":"png","image/bmp":"bmp","image/gif":"gif","image/tif":"tif","image/tiff":"tif"};class g extends s.PureComponent{constructor(t){super(t),this._showDiscardDialog=new o.ObservableValue(!1),this._blobUrlToFinalUrlMap={},this._onRenderDefaultEditor=t=>{const{onRenderPreview:e,uploadImageHandler:i,ariaLabel:o}=this.props;return s.createElement(r.WrappedComponent,{dependencies:h,wrappedType:"ms.vss-markdown.markdown-component",wrappedProps:{enableMentions:!0,onTextChanged:t.onChange,isActive:!!e,renderPreview:this._onRenderPreview,autoAdjustHeight:!0,value:this.state.value,autoFocus:!0,showToolbar:!0,className:"comment-markdown-component",addAttachments:i?this._onAddAttachments:void 0,validAttachmentTypes:p,ariaLabel:o||m.DefaultCommentEditorAriaLabel},wrappedRef:this._editorRef})},this._onAddAttachments=async(t,e,i)=>{if(!t||t.length<1)return;const s=t[0],{uploadImageSizeLimitByte:o}=this.props;if(s.size>o)return;const r=s.type?u[s.type]:"png";if(!r)return;const{uploadImageHandler:n}=this.props;if(!n)return;const a=this.state.value,l=a.substring(0,e),c=a.substring(i),m=s.name||`image.${r}`,d=new Blob([s],{type:s.type}),h=URL.createObjectURL(d),p=`${l}${`![${m}](${h})`} ${c}`;this.setState({value:p},(()=>this._onChange(p)));const g=await n(s);this._isDisposing?URL.revokeObjectURL(h):this._blobUrlToFinalUrlMap[h]=g},this._onRenderPreview=t=>{const{onRenderPreview:e}=this.props;return new Promise(((i,o)=>{if(e){const t=this._editor.getValue(!0);t instanceof Promise?t.then((t=>{i(e(t))})):i(e(t))}else i(s.createElement(s.Fragment,null,t))}))},this._onChange=t=>{const{comment:e,onChange:i}=this.props;i&&i(e.id,t),this.setState({isDirty:this._getDirtyState(t),value:t})},this._editorRef=t=>{const{onEditorMounted:e,comment:i}=this.props;if(this._editor=t,t){const s=t.getValue();if(s instanceof Promise)return void s.then((t=>{this._originalValue=void 0!==this.props.originalText?this.props.originalText:t,this.setState({isDirty:this._getDirtyState(t)}),e&&e(i.id)}));this._originalValue=void 0!==this.props.originalText?this.props.originalText:s,this.setState({isDirty:this._getDirtyState(s)}),e&&e(i.id)}},this._renderButtons=()=>{const{updateButtonText:t,infoMessage:e}=this.props;return s.createElement("div",{className:"comment-message-area"},s.createElement("div",{className:"custom-message"},e),s.createElement("div",{className:"actions-area"},s.createElement(n.Button,{className:"editor-cancel-button",text:i.Cancel,onClick:this._onCancelClick,ariaLabel:i.Cancel}),s.createElement(n.Button,{text:t||m.Update,ariaLabel:t||m.Update,disabled:!this.state.isDirty,onClick:this._onUpdateClick,primary:!0})))},this._renderDiscardDraftDialog=()=>{const t="cancel-discard-draft";return s.createElement(l.Observer,{isDialogOpen:this._showDiscardDialog},(e=>e.isDialogOpen&&s.createElement(a.Dialog,{titleProps:{text:m.ConfirmDiscardCommentDraft},onDismiss:this._dismissDiscardDraftDialog,lightDismiss:!1,defaultActiveElement:".cancel-discard-draft",footerButtonProps:[{text:i.Cancel,onClick:this._dismissDiscardDraftDialog,className:t},{text:m.Discard,danger:!0,onClick:this._onConfirmDiscardClick}]})))},this._dismissDiscardDraftDialog=()=>{const{comment:t,onKeepDraft:e}=this.props;if(this._showDiscardDialog.value=!1,!e)return;const i=this._editor.getValue();i instanceof Promise?i.then((i=>e(t.id,i))):e(t.id,i)},this._onConfirmDiscardClick=()=>{const{comment:t,onCancelEdit:e}=this.props,{isDirty:i}=this.state;this.setState({isDirty:!1}),e&&e(t.id,i)},this._onUpdateClick=()=>{const{isDirty:t}=this.state;if(!t)return;const{comment:e,onUpdate:i}=this.props,{text:s}=e;this.setState({isDirty:!1});const o=this._editor.getValue(!0);o instanceof Promise?o.then((t=>i(e.id,this._resolveBlobUrl(t),s))):i(e.id,this._resolveBlobUrl(o),s)},this._onCancelClick=()=>{const{isDirty:t}=this.state;if(t)this._showDiscardDialog.value=!0;else{const{comment:e,onCancelEdit:i}=this.props;i&&i(e.id,t)}},this._originalValue=null!=t.originalText?t.originalText:t.comment.text,this.state={isDirty:this._getDirtyState(t.comment.text),value:t.comment.text}}render(){const{className:t,onRenderEditor:e=this._onRenderDefaultEditor,comment:i,uploadImageHandler:o,ariaLabel:r}=this.props;return s.createElement("div",{className:(0,c.css)("comment-editor",t)},e({ref:this._editorRef,onChange:this._onChange,comment:i,uploadImageHandler:o,ariaLabel:r}),this._renderButtons(),this._renderDiscardDraftDialog())}componentDidUpdate(t,e){const{isDirty:i}=this.state,{comment:s,onDirtyChange:o}=this.props;o&&e.isDirty!==i&&o(s.id,i)}componentWillUnmount(){const{comment:t,onDirtyChange:e}=this.props;this._isDisposing=!0,e&&this.state.isDirty&&e(t.id,!1),this._blobUrlToFinalUrlMap&&(Object.keys(this._blobUrlToFinalUrlMap).forEach((t=>URL.revokeObjectURL(t))),this._blobUrlToFinalUrlMap=null)}_getDirtyState(t){const e=this._editor;return this._originalValue!==t&&!!t&&t.trim().length>0&&(!e||!e.isEmpty())}_resolveBlobUrl(t){if(this.props.onRenderEditor)return t;for(const e in this._blobUrlToFinalUrlMap)t=t.replace(new RegExp(e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),"g"),this._blobUrlToFinalUrlMap[e]);return t.replace(/!\[[^\]]+\]\(blob:[^)]+\)/gi,"")}}e[t].CommentEditor=g,g.defaultProps={uploadImageSizeLimitByte:26214400},r.VssComponent.register("comment-editor",g)}("ComponentsCommentEditor"),e.CommentEditor={},Object.defineProperty(e.CommentEditor,"CommentEditor",{enumerable:!0,get:function(){return d.CommentEditor}})}),["Resources","Components/CommentEditor","CommentEditor"]),document.dispatchEvent(new CustomEvent("scriptLoaded",{cancelable:!1,detail:{id:"ms.vss-comments.editor"}}));