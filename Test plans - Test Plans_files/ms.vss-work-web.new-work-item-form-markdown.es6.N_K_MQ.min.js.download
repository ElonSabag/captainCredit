"use strict";define("Wit/WorkItemFormMarkdown",["require","exports","react","VSS/Core/Observable","VSS/Core/TimerManagement","VSS/Core/Util/String","VSS/Features/MarkdownEditor/Commands/Toolbar","VSS/Features/MarkdownEditor/Components","VSS/Features/MarkdownEditor/Formatting/Common","VSS/Features/PlatformUI/MessageDialog","VSSUI/FileInput","VSSUI/Observer","VSSUI/ProgressBar","Mention/MarkdownWithAutocomplete/Components","VSS/Features/MarkdownEditor/Commands/Shortcut"],(function(e,t,o,r,i,n,a,s,l,d,m,c,u,g,p){var w,h,k;w=t.Resources={},t.Resources.MarkdownEditorInsertFileTitle="Insert a file",t.Resources.MarkdownEditorUploadFileDialogTitle="Upload file",t.Resources.MarkdownEditorUploadFileDialogSubmit="Upload",t.Resources.MarkdownEditorUploadFileError="The file upload has failed. {0}",t.Resources.MarkdownEditorImageExtensionNotSupported="The image extension '{0}' is not supported in the markdown editor. Supported extensions are {1}. If you want to upload the file to the work item, you can upload it as an attachment.",t.Resources.MarkdownEditorImageSizeTooBig="The image size {0}MB is too big, the maximum allowed image size is {1}.",t.Resources.MarkdownEditorImageUploading="[Uploading file {0}...]",t.Resources.MarkdownEditorMentionSomeone="Mention someone",t.Resources.MarkdownEditorMentionWorkItem="Mention work item",t.Resources.MarkdownEditorMentionPullRequest="Mention PR",t.Resources.MarkdownEditorSuggestionMessage="Paste or select files to insert.",h=t.FileUploadUtils={},t.FileUploadUtils.validFileTypeList=["jpg","jpeg","png","bmp","gif"],function(e){k=t[e]={};t[e].WorkItemFormMarkdownToolbar=e=>{var{pageContext:t,uploadImage:r}=e,n=__rest(e,["pageContext","uploadImage"]);const l=o.createElement(s.MarkdownToolbar,Object.assign({commands:[...a.toolbarCommands,new E,new p,new g,new M({pageContext:t,uploadImage:r})],className:"flex-grow work-item-markdown-toolbar"},n)),[d,m]=o.useState(n.hide),c=o.useMemo((()=>new i.TimerManagement),[]),u=o.useMemo((()=>c.debounce((e=>{m(e)}),n.debounceHideMs,{trailing:!0})),[m,c]);return o.useEffect((()=>{n.hide?u(n.hide):(u(!1),m(!1))}),[n.hide]),d?null:l};class g{constructor(){this.someoneCharacter="@",this.id="someone-mention",this.iconProps={iconName:"Accounts"},this.text=w.MarkdownEditorMentionSomeone,this.rank=110,this.formatText=e=>(0,l.insertText)(e,this.someoneCharacter)}}class p{constructor(){this.workItemCharacter="#",this.id="wi-mention",this.iconProps={iconName:"NumberSymbol"},this.text=w.MarkdownEditorMentionWorkItem,this.rank=111,this.formatText=e=>(0,l.insertText)(e,this.workItemCharacter)}}class E{constructor(){this.pullRequestCharacter="!",this.id="pr-mention",this.iconProps={iconName:"BranchPullRequest"},this.text=w.MarkdownEditorMentionPullRequest,this.rank=112,this.formatText=e=>(0,l.insertText)(e,this.pullRequestCharacter)}}t[e].maxFileSize=26214400;class M{constructor(i){this.id="markdown-attachment",this.iconProps={iconName:"Attach"},this.text=w.MarkdownEditorInsertFileTitle,this.rank=113,this.formatText=(i,a)=>{const{pageContext:s,uploadImage:g}=this.props,p=new r.ObservableValue(!1),k=new r.ObservableValue(!1);let E;return new Promise(((r,M)=>{s.getService("IVssLayoutManager").renderCallout((s=>o.createElement(c.Observer,{attachmentsValid:p,isUploading:k},(c=>o.createElement(d.MessageDialog,{lightDismiss:!1,title:w.MarkdownEditorUploadFileDialogTitle,okButtonProps:{disabled:!c.attachmentsValid||c.isUploading,text:w.MarkdownEditorUploadFileDialogSubmit},onClose:async e=>{if(e)try{if(E){k.value=!0;const e=await g(E.result.file);r((0,l.insertText)(i,`![${E.result.name}](${e}) `))}else r((0,l.insertText)(i));a(null)}catch(e){const t=new Error((0,n.format)(w.MarkdownEditorUploadFileError,e.message));a(t),M(e)}finally{k.value=!1}else r((0,l.insertText)(i));s()},message:c.isUploading?o.createElement(u.IndeterminateProgressBar,{loading:!0}):o.createElement(m.FileInput,{allowedFileExtensions:h.validFileTypeList,maximumNumberOfFiles:1,maximumSingleFileSize:t[e].maxFileSize,resultContentType:2,updateHandler:e=>{p.value=e.files.length>0,E=e.files.length>0?e.files[0]:void 0}})})))))}))},this.props=i}}t[e].AttachmentCommand=M}("WorkItemFormMarkdownToolbar"),function(e){t[e]={};class r extends g.MarkdownTextFieldWithAutocomplete{constructor(e){super(e)}getValue(){var e,t;return null!==(t=null===(e=this.getInputElement())||void 0===e?void 0:e.value)&&void 0!==t?t:""}isEmpty(){return""===this.getValue()}setContent(e){const t=this.getInputElement();t&&(t.value=e)}selectAll(){const e=this.getInputElement();e&&e.select()}focus(){const e=this.getInputElement();e&&e.focus()}setEnabled(e){}}t[e].WorkItemFormMarkdownEditor=r,t[e].WorkItemFormMarkdownEditorMemoized=o.forwardRef(((e,t)=>o.useMemo((()=>o.createElement(r,Object.assign({ref:t,shortcutCommands:p.shortcutCommands,onPaste:(t,o)=>i(t,o,e.uploadImage),messageText:w.MarkdownEditorSuggestionMessage},e))),[e.error])));const i=async(e,t,o)=>{if(!t)return;let r=t.getFormattingArgs();if(!r||!e.clipboardData)return;const{files:i,items:n}=e.clipboardData;if(i&&i.length>0)await d(i[0],r,t,o);else if(n&&n.length>0){const e=n[0].getAsFile();e&&await d(e,r,t,o)}},a=e=>Math.round(e/1024/1024*10)/10;let s=0;const d=async(e,t,o,r)=>{const i=e.name.split(".").pop();if(e.type.indexOf("image/")>=0&&h.validFileTypeList.some((e=>e===i)))if(e.size>k.maxFileSize)o.showError(new Error((0,n.format)(w.MarkdownEditorImageSizeTooBig,a(e.size),a(k.maxFileSize))));else{const i=(0,n.format)(w.MarkdownEditorImageUploading,`${e.name}${++s}`),a=()=>{const e=o.getFormattingArgs(),t=e.text.indexOf(i);return{currentFormattingArgs:e,loadingStartPosition:t,loadingEndPosition:t+i.length}};try{o.applyFormatting((0,l.insertText)(t,i));const n=await r(e),{currentFormattingArgs:s,loadingStartPosition:d,loadingEndPosition:m}=a();o.applyFormatting((0,l.insertText)({selectionStart:d,selectionEnd:m,text:s.text},`![${e.name}](${n}) `))}catch(e){o.showError(new Error((0,n.format)(w.MarkdownEditorUploadFileError,e.message)));const{currentFormattingArgs:t,loadingStartPosition:r,loadingEndPosition:i}=a();o.applyFormatting((0,l.insertText)({selectionStart:r,selectionEnd:i,text:t.text}," "))}}else o.showError(new Error((0,n.format)(w.MarkdownEditorImageExtensionNotSupported,i,h.validFileTypeList.join(", "))))}}("WorkItemFormMarkdownEditor")}),["Resources","FileUploadUtils","WorkItemFormMarkdownToolbar","WorkItemFormMarkdownEditor"]),document.dispatchEvent(new CustomEvent("scriptLoaded",{cancelable:!1,detail:{id:"ms.vss-work-web.new-work-item-form-markdown"}}));