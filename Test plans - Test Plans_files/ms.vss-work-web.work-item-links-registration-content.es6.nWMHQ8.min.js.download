"use strict";define("Wit/WorkItemLinksRegistration",["require","exports","Wit/WorkItemModel/OM/index","VSS/Core/Util/String","VSS/Platform/Context","react","VSS/Platform/Layout","Wit/Common/DateUtils","VSSUI/Ago","VSS/Platform/Components/Format/Format"],(function(e,t,i,n,r,s,o,a,l,c){var u,d,k,p,T,m,y,L,g,v;u=t.Resources={},t.Resources.LinkTypeRelated="Related",t.Resources.LinkTypeHyperlink="Hyperlink",t.Resources.LinkTypeChangeset="Changeset",t.Resources.LinkTypeVersionedItem="Versioned Item",t.Resources.LinkTypeCommit="Commit",t.Resources.LinkTypeBranch="Branch",t.Resources.LinkTypeTag="Tag",t.Resources.LinkTypePullRequest="Pull Request",t.Resources.LinkTypeResultAttachment="Result Attachment",t.Resources.LinkTypeTestResult="Test Result",t.Resources.LinkTypeTest="Test",t.Resources.LinkTypeStoryboard="Storyboard",t.Resources.LinkTypeBuild="Build",t.Resources.LinkTypeFoundInBuild="Found in build",t.Resources.LinkTypeIntegratedInBuild="Integrated in build",t.Resources.LinkTypeWikiPage="Wiki page",t.Resources.LinkTypeGitHubPullRequest="GitHub Pull Request",t.Resources.LinkTypeGitHubCommit="GitHub Commit",t.Resources.LinkTypeGitHubIssue="GitHub Issue",t.Resources.LinkTypeReleaseEnvironment="Integrated in release stage",t.Resources.LinkToolTypeCode="Code",t.Resources.LinkToolTypeTest="Test",t.Resources.LinkToolTypeRequirements="Requirements",t.Resources.LinkToolTypeBuild="Build",t.Resources.LinkToolTypeWiki="Wiki",t.Resources.LinkToolTypeGitHub="GitHub",t.Resources.LinkToolTypeWork="Work",t.Resources.LinkToolTypeRemoteWork="Remote Work",t.Resources.LinkUpdatedAtTime="Updated {0}",t.Resources.ErrorLinkCouldNotBeRead="{0} link could not be read",t.Contracts={},d=t.Constants={},Object.defineProperty(t.Constants,"RegisteredLinkTypeNames",{enumerable:!0,get:function(){return i.RegisteredLinkTypeNames}}),t.Constants.ToolIds={VersionControl:"VersionControl",WorkItemTracking:"WorkItemTracking",RemoteWorkItemTracking:"RemoteWorkItemTracking",TeamBuild:"Build",TestManagement:"TestManagement",Requirements:"Requirements",Hyperlink:"Hyperlink",Legacy:"Legacy",CodeSense:"CodeSense",Git:"Git",CodeReview:"CodeReview",ProjectDownload:"ProjectDownload",Wiki:"Wiki",GitHub:"GitHub",ReleaseManagement:"ReleaseManagement"},t.Constants.ArtifactTypeNames={TcmResult:"TcmResult",TcmResultAttachment:"TcmResultAttachment",TcmTest:"TcmTest",Build:"Build",VersionedItem:"VersionedItem",LatestItemVersion:"LatestItemVersion",Changeset:"Changeset",Shelveset:"Shelveset",WorkItem:"WorkItem",Storyboard:"Storyboard",Commit:"Commit",CodeReviewId:"CodeReviewId",CodeReviewSdkId:"ReviewId",PullRequestId:"PullRequestId",ProjectDownloadProject:"Project",Ref:"Ref",WikiPage:"WikiPage",PullRequest:"PullRequest",Issue:"Issue"},t.Constants.LinkTypeFieldIds={Attachment:50,Hyperlink:51,ExternalLink:58,WorkItem:37},function(e){function i(e){switch(e){case d.RegisteredLinkTypeNames.Related:return u.LinkTypeRelated;case d.RegisteredLinkTypeNames.Hyperlink:return u.LinkTypeHyperlink;case d.RegisteredLinkTypeNames.Changeset:return u.LinkTypeChangeset;case d.RegisteredLinkTypeNames.VersionedItem:return u.LinkTypeVersionedItem;case d.RegisteredLinkTypeNames.Commit:return u.LinkTypeCommit;case d.RegisteredLinkTypeNames.Branch:return u.LinkTypeBranch;case d.RegisteredLinkTypeNames.Tag:return u.LinkTypeTag;case d.RegisteredLinkTypeNames.PullRequest:return u.LinkTypePullRequest;case d.RegisteredLinkTypeNames.ResultAttachment:return u.LinkTypeResultAttachment;case d.RegisteredLinkTypeNames.TestResult:return u.LinkTypeTestResult;case d.RegisteredLinkTypeNames.Test:return u.LinkTypeTest;case d.RegisteredLinkTypeNames.Storyboard:return u.LinkTypeStoryboard;case d.RegisteredLinkTypeNames.Build:return u.LinkTypeBuild;case d.RegisteredLinkTypeNames.FoundInBuild:return u.LinkTypeFoundInBuild;case d.RegisteredLinkTypeNames.IntegratedInBuild:return u.LinkTypeIntegratedInBuild;case d.RegisteredLinkTypeNames.WikiPage:return u.LinkTypeWikiPage;case d.RegisteredLinkTypeNames.GitHubPullRequestLinkType:return u.LinkTypeGitHubPullRequest;case d.RegisteredLinkTypeNames.GitHubCommitLinkType:return u.LinkTypeGitHubCommit;case d.RegisteredLinkTypeNames.GitHubIssueLinkType:return u.LinkTypeGitHubIssue;case d.RegisteredLinkTypeNames.ReleaseEnvironment:return u.LinkTypeReleaseEnvironment;default:return e}}k=t.LinkUtils={},t.LinkUtils.getLinkTypeDisplayName=i,t.LinkUtils.getToolDisplayName=function(e,t){switch(e){case d.ToolIds.VersionControl:case d.ToolIds.Git:return u.LinkToolTypeCode;case d.ToolIds.TestManagement:return u.LinkToolTypeTest;case d.ToolIds.Requirements:return u.LinkToolTypeRequirements;case d.ToolIds.TeamBuild:return u.LinkToolTypeBuild;case d.ToolIds.Wiki:return u.LinkToolTypeWiki;case d.ToolIds.GitHub:return u.LinkToolTypeGitHub;default:return t?u.LinkToolTypeRemoteWork:u.LinkToolTypeWork}},t.LinkUtils.isSameLinkIdentifier=function(e,t){return e.FldID===t.FldID&&e.ExtID===t.ExtID&&e.FilePath===t.FilePath&&e.ID===t.ID&&e.OriginalName===t.OriginalName},t.LinkUtils.makePlaceholderForUnresolvedLinkIdentifier=function(e,t,r){var s;const o=e.FldID===d.LinkTypeFieldIds.ExternalLink?e.OriginalName:e.FldID===d.LinkTypeFieldIds.WorkItem?d.RegisteredLinkTypeNames.Related:e.FldID===d.LinkTypeFieldIds.Hyperlink?d.RegisteredLinkTypeNames.Hyperlink:void 0;if(o)return{linkIdentifier:e,icons:[{iconName:"AlertSolid",className:"error-text icon-margin"}],id:e.ID?e.ID.toString():null!==(s=e.FilePath)&&void 0!==s?s:"ID",displayId:e.ID?e.ID.toString():"",title:(0,n.format)(u.ErrorLinkCouldNotBeRead,t||i(o)),tool:e.tool,linkTypeDisplayName:t||i(o),registeredLinkType:o,uri:"#",additionalData:{isPlaceholderForUnresolvedLinkIdentifier:!0},witLinkTypeEnd:r}},t.LinkUtils.isPlaceholderForUnresolvedLinkIdentifier=function(e){var t;return null===(t=e.additionalData)||void 0===t?void 0:t.isPlaceholderForUnresolvedLinkIdentifier}}(),function(e){let i;p=t.ArtifactCache={};class n{constructor(){this.displayDataByKey=new Map}static getInstance(){return i||(i=new n),i}get(e){const t=this.constructCacheKey(e);return this.displayDataByKey.get(t)}set(e,t){if((0,k.isPlaceholderForUnresolvedLinkIdentifier)(t))return;const i=this.constructCacheKey(e);this.displayDataByKey.set(i,t)}clear(e){const t=this.constructCacheKey(e);this.displayDataByKey.delete(t)}constructCacheKey(e){var t,i,n,r,s,o;return`tool:${e.tool}, ID:${null!==(t=e.ID)&&void 0!==t?t:"None"}, ExtID:${e.ExtID}, field:${e.FldID}, linkType:${null!==(i=e.LinkType)&&void 0!==i?i:"None"}, originalName:${null!==(n=e.OriginalName)&&void 0!==n?n:"None"}, filePath:${null!==(r=e.FilePath)&&void 0!==r?r:"None"}, updateDate:${null!==(s=e.LastWriteDate)&&void 0!==s?s:"None"}, comment:${null!==(o=e.Comment)&&void 0!==o?o:"None"}`}}t.ArtifactCache.ArtifactCache=n}(),t.IRegisteredLinkTypeService={},function(e){T=t[e]={};const i=new Map,n=new Map([[d.ToolIds.WorkItemTracking,"work-item-link-type-service"],[d.ToolIds.RemoteWorkItemTracking,"remote-work-item-link-type-service"],[d.ToolIds.GitHub,"github-link-type-service"],[d.ToolIds.TeamBuild,"build-link-type-service"],[d.ToolIds.Git,"git-link-type-service"],[d.ToolIds.TestManagement,"tcm-link-type-service"],[d.ToolIds.VersionControl,"tfvc-link-type-service"],[d.ToolIds.Wiki,"wiki-link-type-service"],[d.ToolIds.Requirements,"requirements-link-type-service"],[d.ToolIds.ReleaseManagement,"release-link-type-service"]]),s=new Map([[d.ToolIds.TeamBuild,"ms.vss-work-web.build-link-type-service"],[d.ToolIds.Git,"ms.vss-work-web.git-link-type-service"],[d.ToolIds.TestManagement,"ms.vss-work-web.tcm-link-type-service"],[d.ToolIds.VersionControl,"ms.vss-work-web.tfvc-link-type-service"],[d.ToolIds.Wiki,"ms.vss-work-web.wiki-link-type-service"],[d.ToolIds.Requirements,"ms.vss-work-web.requirements-link-type-service"],[d.ToolIds.ReleaseManagement,"ms.vss-releaseManagement-web.release-link-type-service"]]),o=new Map([[d.ToolIds.TestManagement,[d.RegisteredLinkTypeNames.Test]]]);t[e].registerLinkTypeService=function(e){i.set(e.getToolId(),e)};class a extends r.VssService{static registerLinkTypeService(e){i.set(e.getToolId(),e)}hasLinkTypeForm(e,t){var i;return n.has(e)&&!(null===(i=o.get(e))||void 0===i?void 0:i.includes(t))}async getRegisteredLinkTypeService(e){const t=i.get(e);if(t)return t;const r=n.get(e);if(!r)return;try{return this.pageContext.getService(r)}catch(e){}const o=s.get(e);if(!o)return;const a=this.pageContext.getService("IVssContributionService");try{return await a.getService(o)}catch(e){return}}}t[e].ILinkTypeRegistryId="link-type-registry",r.Services.add(t[e].ILinkTypeRegistryId,{serviceFactory:a})}("registerLinkTypeService"),m=t[v="ComponentsuseLinkTypeService"]={},t[v].useLinkTypeService=function(e){const t=(0,o.usePageContext)(),i=(0,s.useMemo)((()=>t.getService(T.ILinkTypeRegistryId)),[t]),[n,r]=(0,s.useState)(),a=function(){const e=(0,s.useRef)(!1);return(0,s.useEffect)((()=>(e.current=!1,()=>{e.current=!0})),[]),e}();if((0,s.useEffect)((()=>{(async()=>{r(void 0);const t=await i.getRegisteredLinkTypeService(e);a.current||r(t)})()}),[e]),(null==n?void 0:n.getToolId())===e)return n},function(e){y=t[e]={},t[e].LinkTypeForm=function({tool:e,onArtifactsUpdated:t,linkType:i,workItemLinkTypeEnd:n,isNew:r,onNewArtifactsUpdated:s,originWorkItems:o,linkableWorkItemTypeFilter:a}){const l=(0,m.useLinkTypeService)(e);return l?r&&l.renderNewLinkTypeForm?l.renderNewLinkTypeForm(e,s,i,o,n,a):l.renderLinkTypeForm(e,t,i,o,n,a):null}}("ComponentsLinkTypeForm"),function(e){function i({link:e}){return s.createElement(s.Fragment,null,e.state)}L=t[e]={},t[e].LinkTypeState=function({link:e}){const t=(0,m.useLinkTypeService)(e.tool);return t?t.renderState(e):s.createElement(i,{link:e})},t[e].DefaultLinkTypeState=i}("ComponentsLinkTypeState"),function(e){function i({link:e}){return e.updateDate?s.createElement(c.FormatComponent,{format:u.LinkUpdatedAtTime},s.createElement(l.Ago,{date:(0,a.getDateInUserTimeZone)(e.updateDate),currentDate:(0,a.getDateInUserTimeZone)(),tooltipTimeFormat:a.tooltipTimeFormat})):null}g=t[e]={},t[e].LinkTypeUpdateDate=function({link:e}){const t=(0,m.useLinkTypeService)(e.tool);return t?t.renderUpdateDate(e):s.createElement(i,{link:e})},t[e].DefaultLinkTypeUpdateDate=i}("ComponentsLinkTypeUpdateDate"),t.Componentsindex={},__exportStar(y,t.Componentsindex),__exportStar(L,t.Componentsindex),__exportStar(g,t.Componentsindex),function(e){async function i(e,t,i){const n=r(e,t,i),s=await Promise.all(Object.values(n)),o=[];for(const e of s)for(const t of e)o.push(t);const a=await Promise.all(o);let l=[];for(const e of a)l=l.concat(e);const c=e.filter((e=>!l.find((t=>(0,k.isSameLinkIdentifier)(e,t.linkIdentifier))))).map((e=>(0,k.makePlaceholderForUnresolvedLinkIdentifier)(e))).filter((e=>!!e));return l.concat(c)}t.resolveArtifacts={},t.resolveArtifacts.resolveArtifact=async function(e,t,n){const[r]=await i([e],t,n);return r},t.resolveArtifacts.resolveAllArtifacts=i;const n=new Set;function r(e,t,i){const n=new Map;for(const t of e)n.has(t.tool)?n.get(t.tool).push(t):n.set(t.tool,[t]);const r={};for(const[e,o]of n.entries())r[e]=s(e,o,t,i);return r}async function s(e,t,i,n){const r=p.ArtifactCache.getInstance(),s=[],o=[];for(const e of t){const t=r.get(e);t?o.push(t):s.push(e)}if(0===s.length)return[Promise.resolve(o)];try{const t=await async function(e,t){const i=e.getService(T.ILinkTypeRegistryId),n=await i.getRegisteredLinkTypeService(t).catch((()=>{}));if(!n)return Promise.reject(new Error(`No link type service avaiable for tool ${t}`));return n}(n,e),a=t.resolveArtifacts(s,i);for(const e of a)e.then((e=>{for(const t of e)r.set(t.linkIdentifier,t)}));return[Promise.resolve(o),...a]}catch(e){return console.error("Unable to resolve artifacts: ",t,e),[Promise.resolve(o)]}}t.resolveArtifacts.observeArtifactResolution=function(e,t,i,s,o,a,l){if(n.has(s))return;n.add(s);const c=new Array(e.length).fill(void 0);s.value=c;const u=p.ArtifactCache.getInstance();for(const t of e)!0===o&&t.ID&&u.clear(t);const d=r(e,t,i),T={totalTopLevel:Object.keys(d).length,completedTopLevel:0,totalDisplayData:0,completedDisplayData:0},m=()=>{s.removeAll((e=>!e));const t=e.filter((e=>!s.value.find((t=>(0,k.isSameLinkIdentifier)(e,t.linkIdentifier))))).map((e=>{const t=e.LinkType?null==l?void 0:l.get(e.LinkType):void 0;return(0,k.makePlaceholderForUnresolvedLinkIdentifier)(e,null==t?void 0:t.name,null==t?void 0:t.immutableName)})).filter((e=>!!e));t.length>0&&s.push(...t),n.delete(s),a&&(s.value=s.value.sort(a))};if(0!==Object.values(d).length)for(const e of Object.values(d))e.then((e=>{T.completedTopLevel+=1,T.totalDisplayData+=e.length;for(const t of e)t.then((e=>{T.completedDisplayData+=1;for(const t of e){const e=s.value.findIndex((e=>!e));e>-1&&s.splice(e,1,t)}T.totalTopLevel===T.completedTopLevel&&T.totalDisplayData===T.completedDisplayData&&m()})).catch((()=>{T.completedDisplayData+=1,T.totalTopLevel===T.completedTopLevel&&T.totalDisplayData===T.completedDisplayData&&m()}))})).catch((()=>{T.completedTopLevel+=1,T.totalTopLevel===T.completedTopLevel&&m()}));else m()}}(),function(e){t[e]={};class i extends r.VssService{_serviceStart(e){super._serviceStart(e),(0,T.registerLinkTypeService)(this)}renderState(e){return s.createElement(L.DefaultLinkTypeState,{link:e})}renderUpdateDate(e){return s.createElement(g.DefaultLinkTypeUpdateDate,{link:e})}}t[e].BaseRegisteredLinkTypeService=i}("BaseRegisteredLinkTypeService")}),["Resources","Contracts","Constants","LinkUtils","ArtifactCache","IRegisteredLinkTypeService","registerLinkTypeService","Components/useLinkTypeService","Components/LinkTypeForm","Components/LinkTypeState","Components/LinkTypeUpdateDate","Components/index","resolveArtifacts","BaseRegisteredLinkTypeService"]),document.dispatchEvent(new CustomEvent("scriptLoaded",{cancelable:!1,detail:{id:"ms.vss-work-web.work-item-links-registration-content"}}));