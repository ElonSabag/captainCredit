"use strict";define("Wit/Common/QueryUtils",["require","exports","VSS/Core/Util/String","VSS/Platform/Trace","Wit/Common/DateUtils","Wit/Common/Generated/Constants","Tfs/Platform/Page","VSS/Platform/FPS","VSS/Platform/Location","Wit/Common/WiqlOperators","Wit/Common/WiqlValues"],(function(e,t,r,n,i,o,s,a,u,l,c){var d,p,m,f;d=t.Resources={},t.Resources.AnyOptionText="[Any]",t.Resources.ErrorDateTimeValueOutOfRange="The DateTime value is out of range.",t.Resources.ErrorExpectingBooleanValue="Expecting boolean value.",t.Resources.ErrorExpectingDateTime="Expecting DateTime value.",t.Resources.ErrorExpectingIntegerValue="Expecting integer value.",t.Resources.ErrorExpectingNumericValue="Expecting numeric value.",t.Resources.ErrorExpectingTeam="Expecting team value.",t.Resources.False="False",t.Resources.FieldNotFoundError="Field '{0}' not found",t.Resources.InvalidQuerySyntax="{0} The error is caused by {1}.",t.Resources.OperationFailed="Operation failed: {0}",t.Resources.QueryFilterErrorEmptyValue="The value for row {0} is not filled correctly.",t.Resources.QueryFilterErrorMissingOperator="The operator for row {0} is missing.",t.Resources.QueryFilterInvalidMacro="TF20036: The macro '{0}' is not recognized. Available macros include @Me, @Project, @Today and @CurrentIteration.",t.Resources.True="True",t.Resources.WorkItemLinkTypeEndDoesNotExist="Work item link type end '{0}' does not exist.",p=t.QueriesHubConstants={},t.QueriesHubConstants.FavoritesTab="favorites",t.QueriesHubConstants.FolderView="folder",t.QueriesHubConstants.AllQueriesTab="all",t.QueriesHubConstants.Area="QueriesHub2",t.QueriesHubConstants.FavoriteTabViewed="FavoriteTabViewed",t.QueriesHubConstants.AllTabViewed="AllTabViewed",t.QueriesHubConstants.ChartsTabViewed="ChartsTabViewed",t.QueriesHubConstants.EditorTabViewed="EditorTabViewed",t.QueriesHubConstants.ResultsViewed="ResultsViewed",t.QueriesHubConstants.WorkItemEditViewed="WorkItemEditViewed",t.QueriesHubConstants.QueriesHubViewed="QueriesHubViewed",t.QueriesHubConstants.TelemetryArea="New-Queries-Hub",t.QueriesHubConstants.MoreButtonId="more-button-",t.QueriesHubConstants.FavoriteArtifactScopeType="Project",t.QueriesHubConstants.FavoriteOwnerScope="Team",t.QueriesHubConstants.TeamFavoriteLoadingGroupKey="TEAM_FAVORITES_LOADING",t.QueriesHubConstants.MyFavoritesGroupKey="MY_FAVORITES_GROUP",t.QueriesHubConstants.MaximumQueriesToShow=50,t.QueriesHubConstants.KeywordFilterKey="keyword",t.QueriesHubConstants.QueriesPath="Queries",t.QueriesHubConstants.SplitterDirectionKey=`${t.QueriesHubConstants.QueriesPath}/SplitterDirection`,t.QueriesHubConstants.WorkItemFormSplitterSize=`${t.QueriesHubConstants.QueriesPath}/WorkItemFormSplitterRatio`,t.QueriesHubConstants.EditorTableSplitterSize=`${t.QueriesHubConstants.QueriesPath}/EditorTableSplitterRatio`,t.QueriesHubConstants.SettingsKey="setting",t.ErrorHandlingUtils={},t.ErrorHandlingUtils.reportError=function(e,t,i){const o=e.getService("IGlobalMessagesService");(0,n.traceException)(e,p.TelemetryArea,t,i);const s=i.status||0,a=(0,r.format)(d.OperationFailed,`${i instanceof Error?i.message:i}${s?" ("+s+")":""}`);o.addBanner({message:a,dismissable:!0,level:2},!0)},t.Models={},(f=t.Models.QuerySaveDialogMode||(t.Models.QuerySaveDialogMode={}))[f.NewQuery=0]="NewQuery",f[f.NewFolder=1]="NewFolder",f[f.RenameQuery=2]="RenameQuery",f[f.RenameFolder=3]="RenameFolder",f[f.SaveAs=4]="SaveAs",m=t.QueryTypeConstants={},function(e){function t(t){return(t||e.Unknown)>e.WorkItems}function r(t){return(t||e.Unknown)>=e.LinksRecursive}e.Unknown=0,e.WorkItems=1,e.LinksMustContain=2,e.LinksMayContain=3,e.LinksDoesNotContain=4,e.LinksRecursive=5,e.LinksRecursiveReturnMatchingChildren=6,e.isLinkQuery=t,e.isTreeQuery=r,e.getQueryType=function(e){return r(e)?2:t(e)?3:1}}(t.QueryTypeConstants.LinkQueryMode||(t.QueryTypeConstants.LinkQueryMode={})),function(e){t.QueryUtils={};t.QueryUtils.checkFlag=(e,t)=>(e&t)!==o.FieldFlags.None,t.QueryUtils.convertValueToDisplayString=function(e,t){const r={year:"numeric",month:"numeric",day:"numeric",hour:"numeric",minute:"numeric"};return null!=e?"string"==typeof e?e:e instanceof Date?(0,i.getDateInUserTimeZone)(e).toLocaleString(t,r):"number"==typeof e?t?(0,i.getDateInUserTimeZone)(new Date(e)).toLocaleString(t,r):e.toLocaleString(t,r):"boolean"==typeof e?e?d.True:d.False:"object"==typeof e&&e.distinctDisplayName?e.distinctDisplayName:e.toString():""}}(),function(e){function n(e,n,i,o,a,l){var c,d;const p=null===(d=null===(c=(0,s.getTFSPageData)(e))||void 0===c?void 0:c.project)||void 0===d?void 0:d.name,m={};return m.project=p||"",m.view=n,a?m.tempQueryId=a:l?m.wiql=l:i&&i.length>0?m.id=i:(m.newQuery=(!0).toString(),m.parentId=null!=o?o:(0,r.newGuid)()),{url:(0,u.routeUrl)(e,t.RoutingUtils.queriesRoute,m),routeValues:m}}t.RoutingUtils={},t.RoutingUtils.queriesRoute="ms.vss-work-web.new-queries-hub-route",t.RoutingUtils.workItemFormRoute="ms.vss-work-web.work-items-form-route",t.RoutingUtils.getDeletedUrl=function(e){var r,n;const i={project:(null===(n=null===(r=(0,s.getTFSPageData)(e))||void 0===r?void 0:r.project)||void 0===n?void 0:n.name)||"",view:"deleted"};return(0,u.routeUrl)(e,t.RoutingUtils.queriesRoute,i)},t.RoutingUtils.getEditorUrl=function(e,t,r,i,o){return n(e,"query-edit",t,r,i,o).url},t.RoutingUtils.getChartsUrl=function(e,t,r,i,o){return n(e,"query-charts",t,r,i,o).url},t.RoutingUtils.getImportWorkItemsUrl=function(e){var r,n;const i={project:(null===(n=null===(r=(0,s.getTFSPageData)(e))||void 0===r?void 0:r.project)||void 0===n?void 0:n.name)||"",view:"query",importData:"csv"};return(0,u.routeUrl)(e,t.RoutingUtils.queriesRoute,i)},t.RoutingUtils.getQueryUrl=function(e,t,r,i,o){return n(e,"query",t,r,i,o).url},t.RoutingUtils.getQueryFolderUrl=function(e,r){var n,i;const o=null===(i=null===(n=(0,s.getTFSPageData)(e))||void 0===n?void 0:n.project)||void 0===i?void 0:i.name,a={};return a.project=o||"",r?(a.view="folder",a.path=r):a.view="all",(0,u.routeUrl)(e,t.RoutingUtils.queriesRoute,a)},t.RoutingUtils.getWorkItemEditUrl=function(e,r,n){var i,o;const a={project:(null!=n?n:null===(o=null===(i=(0,s.getTFSPageData)(e))||void 0===i?void 0:i.project)||void 0===o?void 0:o.name)||"",view:"edit",id:String(r)};return{url:(0,u.routeUrl)(e,t.RoutingUtils.workItemFormRoute,a),routeValues:a}},t.RoutingUtils.getContributedTabUrl=function(e,t,r,i,o,s){return n(e,t,r,i,o,s).url},t.RoutingUtils.getViewUrl=n,t.RoutingUtils.onClickQuerySaveFPS=function(e,t,r,n,i={}){const o=Object.assign(i,{isQuerySaveFPS:!0});return(0,a.onClickFPS)(e,t,r,n,o)}}(),function(e){var n;function i(e,t){const r=new Error(t);return r.name=e,r}function s(e,t){return i(n.InvalidQuerySyntaxException,(0,r.format)(d.InvalidQuerySyntax,e,t))}function a(e,t){return i(n.InvalidQueryFilterRowException,(0,r.format)(e,t))}t.WiqlGenerator={},function(e){e.LinkTypeEndDoesNotExistException="VSS.WorkItemTracking.LinkTypeEndDoesNotExistException",e.InvalidQuerySyntaxException="VSS.WorkItemTracking.InvalidQuerySyntaxException",e.InvalidQueryFilterRowException="VSS.WorkItemTracking.InvalidQueryFilterRowException",e.FieldDoesNotExistException="VSS.WorkItemTracking.FieldDoesNotExistException"}(n||(n={})),function(e){let t;const u=[],p=/^-?[0-9]+?$/,f=/^true$/i,g=/^false$/i,y=/^[0-9]+?$/,v=/[\s'"()]+$/,E=/^[\s'"()]+/,T=/\"([^\"]*)\"/i;function Q(e){return e.length>0?"SELECT "+e.map((e=>"["+e+"]")).join(","):"SELECT [System.Id]"}function h(e,n,i){const s=[],u=[];let c,p=e.groups,m=!1;if(e.clauses&&(p=p&&[...p],c=0,e.clauses.forEach((e=>{const t=e.fieldName.trim();if(t){const n=e.operator.trim();if(!n)throw a(d.QueryFilterErrorMissingOperator,e.index+1);if(!e.value.trim()&&((0,l.isFieldComparisonOperator)(n)||(0,r.equals)(l.WiqlOperators.OperatorIn,(0,l.getInvariantOperator)(n),!0)||(0,r.equals)(l.WiqlOperators.OperatorNotIn,(0,l.getInvariantOperator)(n),!0)||C(t)===o.FieldType.Boolean))throw a(d.QueryFilterErrorEmptyValue,e.index+1);s.push(Object.assign(Object.assign({},e),{index:c,originalIndex:e.index})),c++}else p&&p.length&&(p=function(e,t,r){let n,i;if(e&&e.length){if(!r)return n=[],i={},e.forEach((e=>{let r;e.end>=t&&(e.start>t&&(e.start=Math.max(1,e.start-1)),e.end=Math.max(1,e.end-1)),e.start!==e.end&&(r=e.start+"_"+e.end,r in i||(i[r]=!0,n.push(e)))})),n;e.forEach((e=>{e.end>=t&&(e.start>=t&&e.start++,e.end++)}))}return e}(p,c+1,!1))}))),i&&!function(e,t){if(!e||!e.clauses)return!1;let n=!1;return e.clauses.forEach((i=>{const s=(0,l.getInvariantOperator)(i.logicalOperator);if((0,l.isOrOperator)(s,!1)&&S(i,e.groups))return n=!1,!1;(0,l.isOrOperator)(s,!1)||!S(i,e.groups)||(0,l.getInvariantOperator)(i.operator)!==l.WiqlOperators.OperatorEqualTo||R(i.fieldName,!1)!==o.CoreFieldRefNames.TeamProject||!(0,l.isProjectMacro)(i.value,!0)&&0!==(0,r.localeIgnoreCaseComparer)(i.value,t)||(n=!0)})),n}(e,i)){let t,r="";t=(0,l.isProjectMacro)(i,!1)?i:(0,l.quoteString)(i),n&&(r="["+n+"]."),r+="["+o.CoreFieldRefNames.TeamProject+"] = "+t,s.length>0&&(r+=" AND",function(e){if(!e||!e.clauses)return!0;for(const t of e.clauses){const r=(0,l.getInvariantOperator)(t.logicalOperator);if((0,l.isOrOperator)(r,!1)&&S(t,e.groups))return!1}return!0}(e)||(m=!0,r+=" (")),u.push(r)}s.forEach(((e,i)=>{const o=[];let s,a="";i>0&&o.push((0,l.getInvariantOperator)(e.logicalOperator)),p&&p.length&&(p.forEach((t=>{t.start===e.index+1&&(a+="(")})),a&&o.push(a));const c=(e=function(e){if(function(e){const r=t.find((t=>t.name===e));return void 0!==r&&(0,l.isNonNullableField)(r.referenceName)}(e.fieldName))return function(e){let t;if(e.value&&(t=e.value.replace(v,"").replace(E,""),0===(0,r.localeIgnoreCaseComparer)(t,d.AnyOptionText)&&(0,l.getInvariantOperator)(e.operator)===l.WiqlOperators.OperatorEqualTo))return Object.assign(Object.assign({},e),{operator:(0,l.getLocalizedOperator)(l.WiqlOperators.OperatorNotEqualTo),value:""});return e}(e);return e}(e)).fieldName,m=e.operator,f=e.value,g=R(c,!0),y=(0,l.getInvariantOperator)(m);if((0,l.isFieldComparisonOperator)(m)){const e=R(f,!0);s=n?"["+n+"].["+e+"]":"["+e+"]"}else s=y===l.WiqlOperators.OperatorIsEmpty||y===l.WiqlOperators.OperatorIsNotEmpty?"":b(g,y,f);n?o.push("["+n+"].["+g+"]"):o.push("["+g+"]"),o.push(y),o.push(s),p&&p.length&&(a="",p.forEach((t=>{t.end===e.index+1&&(a+=")")})),a&&o.push(a)),u.push(o.join(" "))}));let f=u.join(" ");return m&&(f+=")"),f}function C(e){var r,n;return null!==(n=null===(r=t.find((t=>t.referenceName===e)))||void 0===r?void 0:r.type)&&void 0!==n?n:o.FieldType.String}function R(e,o){const s=t.find((t=>t.name===e));if(s)return s.referenceName;if(o)throw function(e){return i(n.FieldDoesNotExistException,(0,r.format)(d.FieldNotFoundError,e))}(e);return e}function S(e,t){const r=e.index+1;for(const e of t)if(r>e.start&&r<=e.end)return!1;return!0}function k(e){const t=(""+e).toUpperCase();for(const r of u){if(r.id===e)return r;if(r.name.toUpperCase()===t)return r;if(r.immutableName.toUpperCase()===t)return r}throw o=e,i(n.LinkTypeEndDoesNotExistException,(0,r.format)(d.WorkItemLinkTypeEndDoesNotExist,o));var o}function b(e,n,i){let a,u,m,v,E,T,Q,h,R,S,F,O,I="";if(null!=i)if(a=!(i=i.trim()),n===l.WiqlOperators.OperatorIn||n===l.WiqlOperators.OperatorNotIn)u=[],u=(x=e,null!==(N=t.find((e=>e.referenceName!==o.CoreFieldRefNames.Parent&&e.referenceName===x)))&&void 0!==N?N:{}).isIdentity?w(i):i.split(",").filter((e=>!!e)),u=u.map((t=>b(e,"",t))),I="("+u.join(",")+")";else if((0,r.equals)(e,"System.LinkType",!0)){try{R=k(i)}catch(e){throw s(e.message,i)}I=(0,l.quoteString)(R.immutableName)}else if(a)I="''";else if(m=C(e),v=(0,r.startsWith)(i,l.WiqlOperators.MacroStart),v){const e=(0,c.parseCurrentIteration)(i);if(e){if(e.team){const{offset:t,team:r}=e,n=t>0?` + ${t}`:t<0?" - "+-t:"",i=r?`('${r}')`:"";return`${l.WiqlOperators.MacroCurrentIteration}${i}${n}`}throw s(d.ErrorExpectingTeam,i)}const t=(0,c.parseTeamAreas)(i);if(t){if(t.team){const{team:e}=t,r=e?`('${e}')`:"";return`${l.WiqlOperators.MacroTeamAreas}${r}`}throw s(d.ErrorExpectingTeam,i)}const n=(0,c.parseDateMacro)(i);if(n){if(n.invariantMacro){const{invariantMacro:e,modifier:t,offset:r}=n;let i=`${e}`;return t&&(i+=`('${t}')`),r&&(i+=`${r}`),i}throw s(d.ErrorExpectingTeam,i)}if(!(0,l.isValidMacro)(i,!0))throw s((0,r.format)(d.QueryFilterInvalidMacro,i),i);I=(0,l.getInvariantOperator)(i)}else if(E=m===o.FieldType.DateTime,T=m===o.FieldType.Integer,Q=m===o.FieldType.Double,h=m===o.FieldType.Boolean,E){if(F=new Date(Date.parse(i)),void 0===F||Number.isNaN(F))throw s(d.ErrorExpectingDateTime,i);if(O=F.getFullYear(),O<1753||O>9999)throw s(d.ErrorDateTimeValueOutOfRange,i);I=(0,l.quoteString)((0,l.toInvariantDateString)(F))}else if(T){if(!p.test(i))throw s(d.ErrorExpectingIntegerValue,i);I=i}else if(Q){if(S=Number(i),Number.isNaN(S))throw s(d.ErrorExpectingNumericValue,i);I=i.toString()}else if(h)if(f.test(i))I="true";else if(g.test(i))I="false";else{if(!y.test(i))throw s(d.ErrorExpectingBooleanValue,i);I=parseInt(i,10)?"true":"false"}else I=(0,l.quoteString)(i);var x,N;return I}function w(e){if(""===e)return[];const t=e.match(T);return null===t?e.split(","):t&&t.index?w(e.substr(0,t.index-1)).concat([t[1]]).concat(w(e.substr(t.index+t[0].length+1))):[]}function F(e,t){let n=e;return t||e&&e.length&&(n=[],e.forEach((e=>{e.name&&!(0,r.equals)(e.name,"System.Links.LinkType",!0)&&n.push(e)}))),n&&n.length?"ORDER BY "+n.map((e=>"["+e.name+"]"+(e.descending?" DESC":""))).join(","):""}e.generateWiql=function(e,n,i,o,a){const c=[];let p,f,g;return t=e,a.forEach((e=>{u.find((t=>t.id===e.forwardEnd.id))||u.push(e.forwardEnd),u.find((t=>t.id===e.reverseEnd.id))||u.push(e.reverseEnd)})),c.push(Q(i)),n.mode<=m.LinkQueryMode.WorkItems?c.push("FROM WorkItems"):c.push("FROM WorkItemLinks"),p=function(e){if(m.LinkQueryMode.isLinkQuery(e.mode)){const t=m.LinkQueryMode.isTreeQuery(e.mode),n=t?e.treeTargetFilter:e.linkTargetFilter,i=t?e.treeLinkTypes:e.linkTypes,o=[];let a;return a=h(e.sourceFilter,"Source",e.teamProject).trim(),a&&o.push("("+a+")"),a=function(e){let t=[];if(e)for(let n of e.split(",")){let e;if(n=n.trim(),0===(0,r.localeIgnoreCaseComparer)(n,d.AnyOptionText)){t=["[System.Links.LinkType] <> ''"];break}try{e=k(n),t.push("[System.Links.LinkType] = "+(0,l.quoteString)(e.immutableName))}catch(e){throw s(e.message,n)}}return t.join(" OR ")}(i).trim(),a&&o.push("("+a+")"),a=h(n,"Target",e.teamProject).trim(),a&&o.push("("+a+")"),o.join(" AND ")}return h(e.sourceFilter,"",e.teamProject).trim()}(n).trim(),p&&c.push("WHERE "+p),f=F(o,m.LinkQueryMode.isLinkQuery(n.mode)),f&&c.push(f),g=function(e){switch(e){case m.LinkQueryMode.LinksMustContain:return"mode(MustContain)";case m.LinkQueryMode.LinksMayContain:return"mode(MayContain)";case m.LinkQueryMode.LinksDoesNotContain:return"mode(DoesNotContain)";case m.LinkQueryMode.LinksRecursive:return"mode(Recursive)";case m.LinkQueryMode.LinksRecursiveReturnMatchingChildren:return"mode(Recursive, ReturnMatchingChildren)"}return""}(n.mode),g&&c.push(g),c.join(" ")},e.generateSelectClause=Q,e.generateOrderByClause=F}(t.WiqlGenerator.WiqlGenerator||(t.WiqlGenerator.WiqlGenerator={}))}()}),["Resources","QueriesHubConstants","ErrorHandlingUtils","Models","QueryTypeConstants","QueryUtils","RoutingUtils","WiqlGenerator"]),document.dispatchEvent(new CustomEvent("scriptLoaded",{cancelable:!1,detail:{id:"ms.vss-work-web.common-query-utils"}}));