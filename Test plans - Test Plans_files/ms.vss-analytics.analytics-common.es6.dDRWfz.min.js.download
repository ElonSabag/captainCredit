"use strict";define("Analytics/Common",["require","exports","VSS/Platform/Context","VSS/Platform/RestClientBase","VSS/Core/Util/String","VSS/Platform/Util/Url"],(function(e,t,r,n,s,a){var o,i,c,u,l,p,d,y,h;o=t.Resources={},t.Resources.Exception_PublicUserOnlyAllowsSingleProjectQuery="Public and anonymous users are only allowed to query single project",t.Resources.ConnectionErrorText="VS403617: Unable to connect to the Analytics Service. Please check your internet connection and try again.",t.Resources.NoErrorText="No error information was recognized from response.",t.Resources.ODataResponseNotFoundErrorText="OData Response was not found.",t.Resources.ODataHeaderTypeUnrecognizedErrorText="OData POST Response has an unrecognized Content-Type header, the response content cannot be parsed",t.Resources.ODataHeaderNotFoundErrorText="OData Response does not contain a Content-Type header.",t.Resources.ODataPayloadBodyNotFoundErrorText="OData Response payload was empty.",t.Resources.ODataResponseValueElementNotFoundErrorText="OData Response Value Element was missing.",t.Resources.ODataPageContextMissing="Analytics Client did not receive pageContext. Valid OData Batch requests addresses could not be determined.",t.Resources.ODataCollectionContextNotRecognized="Analytics Client could not determine Collection Context of this page.",t.Resources.ODataProjectContextNotRecognized="Analytics Client could not determine Project Context of this page.",t.Resources.ODataPayloadEmptyError="VS403708: A successful OData query unexpectedly had no value information in the results payload. Our Engineering team is investigating this issue. Try refreshing the widget or re-configuring it.  Query Key: ${0}",t.Resources.PermissionDeniedTitleText="Permission Denied",t.Resources.PermissionDeniedDetailText='Using this service requires "View Analytics" permission. Instructions on how to configure it can be found {0}. Changing the permissions requires administrator rights to the associated project.',t.Resources.PermissionDeniedDetailLinkText="here",t.Resources.PermissionDeniedDetailLinkAddress="https://go.microsoft.com/fwlink/?LinkId=786441",function(e){t.RestClientAnalytics={};class s extends n.RestClientBase{constructor(e){super(e)}async getSpaceRequirements(){return this.beginRequest({apiVersion:"4.1-preview.1",routeTemplate:"_apis/Analytics/SpaceRequirements"})}async getState(){return this.beginRequest({apiVersion:"4.1-preview.1",routeTemplate:"_apis/Analytics/State/{state}"})}async updateState(e){return this.beginRequest({apiVersion:"4.1-preview.1",method:"PATCH",routeTemplate:"_apis/Analytics/State/{state}",routeValues:{state:e}})}}t.RestClientAnalytics.AnalyticsClientName="IAnalyticsRestClient",t.RestClientAnalytics.getAnalyticsClient=function(e,r){return e.getRestClient(t.RestClientAnalytics.AnalyticsClientName,r)},r.RestClients.add(t.RestClientAnalytics.AnalyticsClientName,{factory:s,options:{serviceInstanceType:"0000003c-0000-8888-8000-000000000000"}})}(),function(e){var r;function n(e){return null!=e&&void 0!==e.error&&void 0!==e.error.code&&void 0!==e.error.message}i=t[e]={},function(e){e[e.DataNotReady=0]="DataNotReady",e[e.Unknown=1]="Unknown",e[e.MissingAnalyticsPermissions=2]="MissingAnalyticsPermissions",e[e.Disabled=3]="Disabled"}(r=t[e].AnalyticsExceptionType||(t[e].AnalyticsExceptionType={})),t[e].recognizeAnalyticsException=function(e){const t=(e=>((e.serverError||{}).error||{}).message||(e.serverError||{}).message)(e),n=e=>e.search("VS403280")>=0||e.search("VS403454")>=0,s=503===e.status&&n(t),a=e.error&&n(e.error.message);let o;return o=s||a?r.DataNotReady:null!=t&&(t.search("VS403496")>=0||t.search("VS403490")>=0)?r.MissingAnalyticsPermissions:null!=t&&(t.search("VS403514")>=0||t.search("VS403515")>=0||t.search("VS403516")>=0)?r.Disabled:r.Unknown,o},t[e].extractODataError=function(e){let t;if(e&&"undefined"!==e.status&&0===e.status)t=o.ConnectionErrorText;else{if(n(e))t=e.error.message;else if(e&&e.responseText)try{const r=JSON.parse(e.responseText);n(r)&&(t=r.error.message)}catch(e){}null==t&&(t=null==(r=e)?o.NoErrorText:r.message?r.message:r.responseText?r.responseText:"string"==typeof r?r:o.NoErrorText)}var r;return t}}("UtilitiesAnalyticsExceptionUtilities"),c=t[h="UtilitiesBatchRequestUtilities"]={},t[h].generatePostPayload=function(e,t,r){const n="\n";return`--batch_${t}\nContent-Type: application/http\nContent-Transfer-Encoding: binary\n\nGET ${e} HTTP/1.1\n`+(r.getProviderSyncDates?"GetSyncDates: true\n":"")+(r.expectSinglePage?"X-TFS-Prefer: VSTS.Analytics.ExpectSinglePage=true\n":"")+(r.syncDateConditions?`X-TFS-If-SyncDates-Newer: ${JSON.stringify(r.syncDateConditions)}\n`:"")+"Prefer: omit-values=nulls"+n+n+`--batch_${t}`},t[h].getHostContext=function(e){if(!e)throw new Error(o.ODataPageContextMissing);const t=e.getService("IVssPageService").getData();if(4!==t.hostType)throw new Error(o.ODataCollectionContextNotRecognized);const r=e.getService("IVssContributionService").getData("ms.vss-tfs-web.page-data");if(null==r)throw new Error(o.ODataProjectContextNotRecognized);return{isHosted:t.isHosted,project:{name:r.project.name,id:r.project.id},collection:{name:t.hostName,id:t.hostId}}},t[h].sanitizeCollectionInPostPayload=function(e,t){let r=e;if(t&&!t.isHosted){const n=encodeURI(t.collection.name),a=encodeURI(t.project.name),o=t.collection.id;(0,s.equals)(n,a,!0)?(r=e.replace(new RegExp(`/${o}/|/A?${o}/`,"i"),"/"),r=r.replace(`/${n}/${a}/`,`/${a}/`)):r=e.replace(new RegExp(`/${n}/|/A?${o}/`,"i"),"/")}return r},function(e){u=t[e]={},t[e].extractBatchPayloadResult=async function(e,t){if(null==e)throw new Error(o.ODataResponseNotFoundErrorText);const n=function(e){if(null==e)throw new Error(o.ODataHeaderNotFoundErrorText);const t=e.get("Content-Type");if(null==t)throw new Error(o.ODataHeaderNotFoundErrorText);const r=new RegExp("^multipart/mixed; boundary=(.*)","i").exec(t);if(null==r)throw new Error(o.ODataHeaderTypeUnrecognizedErrorText);return r[1]}(e.headers),s=await e.text();if(null==s||""===s)throw new Error(o.ODataPayloadBodyNotFoundErrorText);const a=new r(s,n),i=a.getResponseContent(),c=i?function(e){const t=parseInt(e);return t||JSON.parse(e)}(i):null;if(function(e){if("object"==typeof e&&null!=e&&void 0!==e.error)throw e}(c),t){const e=a.getResponseHeaders(),t=a.getResponseLine();return"object"==typeof c?Object.assign({responseStatus:t,responseHeaders:e},c):{responseStatus:t,responseHeaders:e,value:c}}return c};class r{constructor(e,t){this.position=0,this.content=e,this.batchSeparator=t,this.parseRawResponse()}getResponseLine(){return this.responseLine}getResponseHeaders(){return this.responseHeaders}getResponseContent(){return this.responseContent}readTo(e){const t=this.position,r=this.content.indexOf(e,this.position);return-1===r?"":(this.position=r+e.length,this.content.substring(t,r))}readLine(){return this.readTo("\r\n")}parseRawResponse(){const e=`--${this.batchSeparator}`;this.readTo(e),this.readTo("\r\n\r\n"),this.responseLine=this.readResponseLine(),this.responseHeaders=this.readResponseHeaders(),this.readLine(),this.responseContent=this.readLine()}readResponseLine(){const e=this.position,t=this.readLine(),n=r.ResponseStatusRegex.exec(t);return n?{StatusCode:n[1],StatusText:n[2]}:(this.position=e,null)}readResponseHeaders(){const e={};let t,n,s=this.position;do{s=this.position,t=this.readLine(),n=r.ResponseHeaderRegex.exec(t),null!==n?e[n[1]]=n[2]:this.position=s}while(t&&n);return e}}r.ResponseStatusRegex=/^HTTP\/1\.\d (\d{3}) (.*)/i,r.ResponseHeaderRegex=/^([^()<>@,;:\\"\/[\]?={} \t]+)\s?:\s?(.*)/}("UtilitiesBatchResponseUtilities"),function(e){function r(e){if(!e)return Math.floor(16*Math.random()).toString(16);let t="";for(let n=0;n<e;n++)t+=r();return t}l=t[e]={},t[e].generateGuid=function(){let e=(128+Math.floor(64*Math.random())).toString(16);return r(8)+"-"+r(4)+"-4"+r(3)+"-"+e+r(2)+"-"+r(12)}}("UtilitiesGuidGenerator"),function(e){p=t[e]={};t[e].DateSKParser=class{static parseDateSKAsDateString(e){const t=e.toString();return`${t.substr(0,4)}-${t.substr(4,2)}-${t.substr(6,2)}`}static dateStringToDateSK(e){return+e.split("-").join("")}static convertDateToDateString(e){const t=e.getFullYear(),r=e.getMonth()+1,n=e.getDate();return[t,r<=9?"0"+r:r,n<=9?"0"+n:n].join("-")}static parseDateSKAsDate(e){return new Date(this.parseDateSKAsDateString(e))}}}("UtilitiesDateSKParser"),function(e){d=t[e]={},t[e].latestODataVersion="v4.0-preview";class r{static isInArray(e,t,r=!1){return t.map((t=>r?`${e} eq '${t}'`:`${e} eq ${t}`)).join(" or ")}static parseAnalyticsDateTime(e,t){const r=/^((\d{4}|\+{1}\d{6})-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}(\.\d{1,7})?)(Z|[+-]\d{2}:\d{2})?$/;return t&&(e=e.replace(r,"$1")),new Date(Date.parse(e))}static escapeString(e){return e.split("'").join("''")}static generateDatesClause(e,t){const n=t.sampleDates.map((e=>p.DateSKParser.dateStringToDateSK(e)));if(t.isDailyInterval){return`(${e} ge ${Math.min(...n)} and ${e} le ${Math.max(...n)})`}return r.isInArray(e,n.map((e=>e.toString())),!1)}}t[e].QueryUtilities=r}("UtilitiesQueryUtilities"),function(e){y=t[e]={},t[e].formatRequestUrl=function(e,t,r,n){let s=e+(0,a.replaceRouteValues)(t,r||{});if(n){const e=new a.Uri(s);e.addQueryParams(n),s=e.absoluteUri}return s},t[e].formatODataCommand=function(e){return`vsts-widget-${e}`},t[e].checkODataPageValue=function(e){if(null==e)throw new Error(o.ODataPayloadBodyNotFoundErrorText);if(null==e.value)throw new Error(o.ODataResponseValueElementNotFoundErrorText)},t[e].generateCustomODataHeaders=function(e,t){const r={Accept:`*/*;api-version=${d.latestODataVersion}`,Prefer:"omit-values=nulls"};return e.expectSinglePage?r["X-TFS-Prefer"]="VSTS.Analytics.ExpectSinglePage=true":e.maxPageSize&&(r.Prefer+=`,odata.maxpagesize=${e.maxPageSize}`),t&&(r["Content-Type"]=`multipart/mixed; boundary=batch_${t}`,r.Accept=`text/plain;api-version=${d.latestODataVersion}`),e.getProviderSyncDates&&(r.GetSyncDates="true"),e.syncDateConditions&&(r["X-TFS-If-SyncDates-Newer"]=JSON.stringify(e.syncDateConditions)),r}}("UtilitiesODataClientUtilities"),function(e){t.RestClientAnalyticsODataClient={};class s extends n.RestClientBase{constructor(e){super(e)}async query(e,t){let r;const n=this.generateGetRequestParams(e,t);if(await this.isBatchMode(e,t)){const s=await this.getRootPath(),a=(0,y.formatRequestUrl)(s,n.routeTemplate,n.routeValues,n.queryParams),o=this.generatePostRequestParams(e,t,a);r=this.runRequest(o,!0,t.getBatchResponseInnerHeaders)}else r=this.runRequest(n);return t.followNextLink?this.followNextLinks(e,r,t):r}async runNextLink(e,t,r){let n;if(await this.isBatchMode(e,r)){const s=this.generatePostRequestParams(e,r,t);n=this.runRequest(s,!0,r.getBatchResponseInnerHeaders)}else{const s=this.generateGetRequestParams(e,r);n=this._issueRequest(t,r.oDataVersion,s)}return n}async isBatchMode(e,t){let r=!1;if(null==t.batchRequestMode||0===t.batchRequestMode)r=!1;else if(1===t.batchRequestMode)r=!0;else{const n=this.generateGetRequestParams(e,t),a=await this.getRootPath(),o=(0,y.formatRequestUrl)(a,n.routeTemplate,n.routeValues,n.queryParams);r=2===t.batchRequestMode&&o.length>s.maxAutoGetURLLength}return r}async followNextLinks(e,t,r){const n=await t;if(n&&n[s.nextLinkKey]){(0,y.checkODataPageValue)(n);const t=n[s.nextLinkKey],a=this.runNextLink(e,t,r),o=await this.followNextLinks(e,a,r);(0,y.checkODataPageValue)(n),n.value=n.value.concat(o.value),n[s.nextLinkKey]=void 0}return n}async runRequest(e,t,r){const n=await this.beginRequest(e);try{return this.interpretRequestResult(n,t,r)}catch(e){throw new Error((0,i.extractODataError)(e))}}async interpretRequestResult(e,t,r){if(t){if(null!=e&&e.error)throw new Error((0,i.extractODataError)(e));return(0,u.extractBatchPayloadResult)(e,r)}return e}generateGetRequestParams(e,t){const r=t.oDataVersion;return{apiVersion:r,queryParams:{$apply:t.$apply,$count:t.$count,$expand:t.$expand,$filter:t.$filter,$format:t.$format,$orderby:t.$orderby,$search:t.$search,$select:t.$select,$skip:t.$skip,$top:t.$top},method:"GET",routeTemplate:t.project?`{project}/_odata/{apiVersion}/${t.entityType}`:`_odata/{apiVersion}/${t.entityType}`,routeValues:t.project?{apiVersion:r,project:t.project}:{apiVersion:r},customHeaders:(0,y.generateCustomODataHeaders)(t),command:(0,y.formatODataCommand)(e)}}generatePostRequestParams(e,t,r){const n=t.oDataVersion,s=(0,l.generateGuid)(),a=(0,c.sanitizeCollectionInPostPayload)(r,(0,c.getHostContext)(t.pageContext));return{apiVersion:n,method:"POST",routeTemplate:t.project?"{project}/_odata/{apiVersion}/$batch":"_odata/{apiVersion}/$batch",routeValues:t.project?{apiVersion:n,project:t.project}:{apiVersion:n},isRawData:!0,customHeaders:(0,y.generateCustomODataHeaders)(t,s),body:(0,c.generatePostPayload)(a,s,t),returnRawResponse:!0,command:(0,y.formatODataCommand)(e)}}}s.maxAutoGetURLLength=1024,s.nextLinkKey="@odata.nextLink",r.RestClients.add("IAnalyticsODataClient",{factory:s,options:{serviceInstanceType:"0000003c-0000-8888-8000-000000000000"}})}(),function(e){t[e]={},t[e].CommonFeatureCommandName="CommonQuery";class r{constructor(e,t){this._featureCommandName=e,this._queryOptions=t,this.isAutomationRequest=!1}async runQuery(e){const t=await this.runqueryCore(e);return this.inspectResponseFormat(t),this.interpretQueryResults(t)}async runDataQualityAwareQuery(e){const t=await this.runqueryCore(e);return{data:this.interpretQueryResults(t),dataQualityWarnings:this.extractDataQualityWarnings(t)}}getKey(){const e=Object.assign({},this._queryOptions);return e.pageContext&&delete e.pageContext,this.getQueryName()+JSON.stringify(e)}setAutomationMode(e){return this.isAutomationRequest=!0===e,this}onCacheHit(e){this.isAutomationRequest||function(e,t){const r=e.getService("IVssTelemetryService"),n="Reporting",s="Engagement",a={Scenario:"InProductOData-Cached",EntityType:t};r.publishEvent(n,s,a)}(e,this._queryOptions.entityType)}inspectResponseFormat(e){if(null==e||null==e.value)throw new Error((0,s.format)(o.ODataPayloadEmptyError,this.getKey()))}interpretQueryResults(e){return e.value}extractDataQualityWarnings(e){const t=[];return e["@vsts.warnings"]&&e["@vsts.warnings"].forEach((e=>{e.startsWith("VS1670030")&&t.push(e)})),t}async runqueryCore(e){const t=this._queryOptions;t.pageContext=e;const r=e.getRestClient("IAnalyticsODataClient"),n=await r.query(this.getFeatureCommandName(),t);return this.inspectResponseFormat(n),n}getFeatureCommandName(){return this.isAutomationRequest?this._featureCommandName+r.untrackedWebAutomationToken:this._featureCommandName}}t[e].AnalyticsCacheableQueryBase=r,r.untrackedWebAutomationToken="-untracked"}("AnalyticsCacheableQueryBase"),function(e){t[e]={},function(e){e[e.Internal=0]="Internal",e[e.String=1]="String",e[e.Integer=2]="Integer",e[e.DateTime=3]="DateTime",e[e.PlainText=5]="PlainText",e[e.Html=7]="Html",e[e.TreePath=8]="TreePath",e[e.History=9]="History",e[e.Double=10]="Double",e[e.Guid=11]="Guid",e[e.Boolean=12]="Boolean",e[e.PicklistInteger=14]="PicklistInteger",e[e.PicklistString=15]="PicklistString"}(t[e].WitFieldType||(t[e].WitFieldType={})),function(e){e.NotSpace="NOT",e.OperatorAnd="AND",e.OperatorOr="OR",e.OperatorContains="CONTAINS",e.OperatorNotContains="NOT CONTAINS",e.OperatorContainsWords="CONTAINS WORDS",e.OperatorNotContainsWords="NOT CONTAINS WORDS",e.OperatorIn="IN",e.OperatorNotIn="NOT IN",e.OperatorEver="EVER",e.OperatorNotEver="NOT EVER",e.OperatorUnder="UNDER",e.OperatorNotUnder="NOT UNDER",e.OperatorInGroup="IN GROUP",e.OperatorNotInGroup="NOT IN GROUP",e.OperatorEqualTo="=",e.OperatorNotEqualTo="<>",e.OperatorIsEmpty="IS EMPTY",e.OperatorIsNotEmpty="IS NOT EMPTY",e.OperatorGreaterThan=">",e.OperatorLessThan="<",e.OperatorGreaterThanOrEqualTo=">=",e.OperatorLessThanOrEqualTo="<=",e.MacroStart="@",e.MacroToday="@today",e.MacroMe="@me",e.MacroProject="@project",e.MacroCurrentIteration="@currentIteration",e.MacroTeamAreas="@teamAreas",e.MacroFollows="@follows",e.MacroRecentMentions="@recentMentions",e.MacroMyRecentActivity="@myRecentActivity",e.MacroRecentProjectActivity="@recentProjectActivity",e.MacroStartOfYear="@startOfYear",e.MacroStartOfMonth="@startOfMonth",e.MacroStartOfWeek="@startOfWeek",e.MacroStartOfDay="@startOfDay"}(t[e].WiqlOperators||(t[e].WiqlOperators={}))}("ContractsWorkItemTrackingDataContracts"),function(e){t[e]={},t[e].forceProjectScoping=function(e,t,r){if(!function(e){return e.getService("IVssUserClaimsService").hasClaim("member")}(e)){const e=t.filter(((e,t,r)=>r.indexOf(e)===t));if(!e||1!==e.length)throw o.Exception_PublicUserOnlyAllowsSingleProjectQuery;r.project=e[0]}return r}}("UtilitiesPublicProjectsQueryHelper")}),["Resources","RestClient/Analytics","Utilities/AnalyticsExceptionUtilities","Utilities/BatchRequestUtilities","Utilities/BatchResponseUtilities","Utilities/GuidGenerator","Utilities/DateSKParser","Utilities/QueryUtilities","Utilities/ODataClientUtilities","RestClient/AnalyticsODataClient","AnalyticsCacheableQueryBase","Contracts/WorkItemTrackingDataContracts","Utilities/PublicProjectsQueryHelper"]),document.dispatchEvent(new CustomEvent("scriptLoaded",{cancelable:!1,detail:{id:"ms.vss-analytics.analytics-common"}}));