"use strict";define("Wit/Common/BacklogContentService",["require","exports","VSS/Core/Util/String","VSS/Core/Observable","VSS/Platform/Context","react","Tfs/Platform/Page","VSS/Platform/Layout","VSSUI/List","VSSUI/Utilities/Filter","VSSUI/Utilities/TreeItemProvider","Wit/AgileAnalytics/WorkItemRollupProvider","Wit/Clients/Work/RestClient/Work","Wit/Common/Generated/Constants","Wit/Common/QuerySaveDialog/Components/QuerySaveDialog","Wit/Common/QueryUtils/Models","Wit/Common/QueryUtils/RoutingUtils","Wit/Common/Utils/WorkItemUtils/CommonWorkItemActions","Wit/Common/WorkItemFieldService/IWorkItemFieldService","Wit/Filter/AreaPathHelper","Wit/Identity/Utilities/WorkItemIdentityHelper","Wit/Messages/BoardsMessagesService","VSS/Core/TimerManagement","VSS/Platform/Feature","Wit/Common/Constants/FeatureFlags","Wit/Filter/FilterManager","Wit/UI/Services/WorkItemTypeIconMetadataService","Wit/WorkItemModel/OM/index","Wit/WorkItemModel/WorkItem/Links","Wit/WorkItemModel/WorkItem/WorkItem","VSS/Platform/Location","VSSUI/Link"],(function(e,t,o,i,a,r,l,s,n,c,d,u,m,g,v,h,k,p,I,f,C,y,S,w,T,B,b,F,R,W,P,N){var x,A,L,M,D,O,V,E,H,j,q,U,_;x=t.Resources={},t.Resources.AtMe="@Me",t.Resources.BacklogsZeroDataPrimaryText="Get started with your product backlog",t.Resources.BacklogsZeroDataSecondaryText='Use the "New Work Item" command to create and prioritize work items',t.Resources.BulkSaveErrorMessage="One or more items could not be saved.",t.Resources.ChangesRequireRefresh="You have modified the work item(s) in a way that affects how it appears on the backlog. You must refresh the backlog to reflect the latest changes.",t.Resources.ColumnOptions="Column Options",t.Resources.CreateQuery="Create Query",t.Resources.EmailSubject="{0} - {1}",t.Resources.Forecast_ItemTooBig="Forecast lines cannot be drawn. Based on the velocity you have entered, the first item on your backlog cannot be completed in the remaining iterations.",t.Resources.Forecast_NoBacklog="Forecast lines cannot be drawn. There are no proposed items in your backlog.",t.Resources.Forecast_NoSprints="Forecast lines cannot be drawn. There are no remaining iterations in your schedule.",t.Resources.Forecast_VelocityLabel="Forecasting based on velocity of",t.Resources.MissingRollupCalculationError="Rollup calculation for this field is missing. Please remove the field and try adding it back",t.Resources.NewWorkItem="New Work Item",t.Resources.TotalByAllDescendents="Count of Work Items",t.Resources.TotalByValue="Count of {0}",t.Resources.TotalByFieldName="Sum of {0}",t.Resources.TotalByFilterField="Sum of {0} {1}",t.Resources.ProgressByCompletedDescendents="Progress by all Work Items",t.Resources.ProgressByValue="Progress by {0}",t.Resources.ProgressByFilterField="Progress by {0} {1}",t.Resources.SprintsZeroDataPrimaryText="You do not have any work scheduled yet",t.Resources.SprintsZeroDataScheduleLink="Schedule work",t.Resources.SprintsZeroDataSecondaryText=" from your product backlog or create new work items.",t.Resources.Unassigned="Unassigned",t.Resources.LearnMore="Learn more.",t.Resources.SameCategoryHierarchy_BacklogMessage="There is same category hierarchy on this backlog.",t.Resources.SameCategoryHierarchy_FeaturesBlocked="You cannot reorder work items and some work items may not be shown.",t.Resources.SameCategoryHierarchy_FeaturesBlockedWithWorkItems="You cannot reorder work items and work item(s) {0} are not shown.",t.Resources.SameCategoryHiearchy_ToFix="See work item(s) {0} to either remove the parent to child link or change the link type to 'Related'.",A=t[j="BacklogContentContants"]={},(H=t[j].BacklogColumnSettings||(t[j].BacklogColumnSettings={})).ColumnsOptions="Agile/BacklogsHub/ColumnOptions",H.ColumnsOptionsKey="Agile/BacklogsHub/ColumnOptions/{0}",H.BacklogItems="Backlog items",H.Issues="Issues",H.IssuesKey="ProductBacklogColumnOptions",H.Level="Agile/BacklogsHub/Level",H.LevelKey="Agile/BacklogsHub/Level/{0}",H.Requirements="Microsoft.RequirementCategory",H.TeamScope="WebTeam",H.BacklogId="BacklogId",H.BacklogsHubKey="Agile/BacklogsHub",(E=t[j].SprintsBacklogColumnSettings||(t[j].SprintsBacklogColumnSettings={})).ColumnOptions="Agile/SprintsHub",E.ColumnOptionsKey="Agile/SprintsHub/{0}",E.IterationKey="IterationBacklogColumnOptions",t[j].SprintsFilterKey="Sprints/backlogs/Filter",(V=t[j].AddWorkItemLocations||(t[j].AddWorkItemLocations={})).Top="top",V.Bottom="bottom",V.Selection="selection",(O=t[j].CommonBacklogDataProviders||(t[j].CommonBacklogDataProviders={})).CurrentTeam="ms.vss-tfs-web.team-context-data-provider",O.PageWorkItemsDataProvider="ms.vss-work-web.page-work-items-data-provider",L=t.RollupHelpers={},function(e){e[e.Progress=0]="Progress",e[e.Total=1]="Total"}(U=t.RollupHelpers.RollupType||(t.RollupHelpers.RollupType={})),function(e){e[e.Count=1]="Count",e[e.Sum=2]="Sum"}(_=t.RollupHelpers.RollupAggregation||(t.RollupHelpers.RollupAggregation={})),(q=t.RollupHelpers.BacklogFieldTypes||(t.RollupHelpers.BacklogFieldTypes={}))[q.Effort=1]="Effort",q[q.Order=2]="Order",q[q.RemainingWork=3]="RemainingWork",q[q.Team=4]="Team",q[q.Activity=5]="Activity",q[q.Requestor=6]="Requestor",q[q.ApplicationType=7]="ApplicationType",q[q.ApplicationStartInformation=8]="ApplicationStartInformation",q[q.ApplicationLaunchInstructions=9]="ApplicationLaunchInstructions",q[q.FeedbackNotes=10]="FeedbackNotes",q[q.ClosedDate=11]="ClosedDate",t.RollupHelpers.getRollupColumnReferenceName=function(e,t){let o="System.Backlog.Rollup.";switch(t&&(o+="Custom."),e.type){case U.Progress:o+="ProgressBy.";break;case U.Total:o+="Total."}return e.aggregation===_.Sum&&e.aggregationField&&(o+=e.aggregationField+"."),e.workItemTypeFilter?o+=e.workItemTypeFilter.replace(/\s/g,""):e.backlogFilter?o+=e.backlogFilter.replace(/\s/g,""):o+="AllCompletedDescendants",o},t.RollupHelpers.getRollupColumnDisplayName=function(e,t){var i;return t||(t={backlogName:e.backlogFilter,fieldName:null!==(i=e.aggregationFieldDisplayName)&&void 0!==i?i:e.aggregationField}),e.type===U.Progress?e.workItemTypeFilter?e.aggregation===_.Sum?(0,o.format)(x.ProgressByFilterField,e.workItemTypeFilter,t&&t.fieldName):(0,o.format)(x.ProgressByValue,e.workItemTypeFilter):e.backlogFilter?e.aggregation===_.Sum?(0,o.format)(x.ProgressByFilterField,t&&t.backlogName,t&&t.fieldName):(0,o.format)(x.ProgressByValue,t&&t.backlogName):e.aggregation===_.Sum?(0,o.format)(x.ProgressByValue,t&&t.fieldName):x.ProgressByCompletedDescendents:e.workItemTypeFilter?e.aggregation===_.Sum?(0,o.format)(x.TotalByFilterField,e.workItemTypeFilter,t&&t.fieldName):(0,o.format)(x.TotalByValue,e.workItemTypeFilter):e.backlogFilter?e.aggregation===_.Sum?(0,o.format)(x.TotalByFilterField,t&&t.backlogName,t&&t.fieldName):(0,o.format)(x.TotalByValue,t&&t.backlogName):e.aggregation===_.Sum?(0,o.format)(x.TotalByFieldName,t&&t.fieldName):x.TotalByAllDescendents},t.RollupHelpers.isRollupEqual=function(e,t){return e.aggregation===t.aggregation&&e.aggregationField===t.aggregationField&&e.backlogFilter===t.backlogFilter&&e.type==t.type&&e.workItemTypeFilter==t.workItemTypeFilter},function(e){t[e]={},function(e){e[e.Default=0]="Default",e[e.OneHop=1]="OneHop",e[e.Flat=2]="Flat"}(t[e].BacklogQueryResultType||(t[e].BacklogQueryResultType={}))}("BacklogContentDataProviderTypes"),function(e){M=t[e]={};class o extends i.ObservableValue{constructor(e,t,o){super(o),this.children=[],this.id=e,this.parent=t}async getFlattenedArray(e,t=!0){var o;const i=[];if(t){if(e&&!await e(this))return i;i.push(this)}if(null===(o=this.children)||void 0===o?void 0:o.length){const t=this.children.map((async t=>t.getFlattenedArray(e))),o=await Promise.all(t);null==o||o.forEach((e=>{i.push(...e)}))}return i}}t[e].ObservableBacklogItem=o}("BacklogContentTreeTypes"),function(e){var o;t.BacklogWorkItemConfigurationService={},function(e){e.workItemStateAndColorDataProvider="ms.vss-work-web.work-item-states-color-data-provider",e.workItemTypeColorAndIconsDataProvider="ms.vss-work-web.work-item-type-color-icon-data-provider"}(o||(o={}));class r extends a.VssService{constructor(){super(...arguments),this.observableWorkItemTypeColorAndIcons=new i.ObservableArray([])}getObservableWorkItemTypeColorAndIcons(){return this.observableWorkItemTypeColorAndIcons}async getWorkItemStateAndColorDictionary(){var e;return null!==(e=await this.ensureWorkItemStateAndColorDictionary())&&void 0!==e?e:{}}async getWorkItemTypeColorAndIcons(){var e;return null!==(e=await this.ensureWorkItemTypeColorAndIcons())&&void 0!==e?e:[]}async ensureWorkItemStateAndColorDictionary(){if(!this.workItemStateAndColorDictionaryPromise){const e=this.pageContext.getService("IVssContributionService");if(this.workItemStateAndColorDictionaryPromise=await e.getDataAsync(o.workItemStateAndColorDataProvider),this.workItemStateAndColorDictionaryPromise)for(const e in this.workItemStateAndColorDictionaryPromise){const t=this.workItemStateAndColorDictionaryPromise[e];for(let e=0;e<t.length;e++)t[e].fill=t[e].color}}return this.workItemStateAndColorDictionaryPromise}async ensureWorkItemTypeColorAndIcons(){var e;if(!this.workItemTypeColorAndIconsPromise){const t=this.pageContext.getService("IVssContributionService");this.workItemTypeColorAndIconsPromise=t.getDataAsync(o.workItemTypeColorAndIconsDataProvider),this.observableWorkItemTypeColorAndIcons.value=null!==(e=await this.workItemTypeColorAndIconsPromise)&&void 0!==e?e:[]}return this.workItemTypeColorAndIconsPromise}}a.Services.add("IBacklogWorkItemConfigurationService",{serviceFactory:r})}(),t.IHubContentService={},function(e){D=t[e]={};class S extends a.VssService{constructor(){super(...arguments),this.allIdsToRowsMap=new Map,this.allBacklogLevels=[],this.allBacklogLevelsPerTeam=new Map,this.backlogTree=new i.ObservableValue(void 0),this.backlogWiql=new i.ObservableValue(""),this.backlogWorkItemTypeNames=[],this.displayState=new i.ObservableValue(0),this.exceptionInfo=new i.ObservableValue(void 0),this.filter=new c.Filter,this.treeSelection=new n.ListSelection(!0),this.teamAreaNodesById=new Map,this.parentWorkItems=new Map,this.isRequirementsBacklog=new i.ObservableValue(!1),this.isRootBacklog=new i.ObservableValue(!1),this.orderColumn=1,this.newItemCalloutAnchor=new i.ObservableValue(void 0),this.showFilterHeader=new i.ObservableValue(!1),this.showQueryHeader=new i.ObservableValue(!1),this.shouldShowOrderValues=!0,this.hub="Backlogs",this._serviceStart=e=>{super._serviceStart(e);const t=this.pageContext.getService("IVssContributionService").getData(A.CommonBacklogDataProviders.CurrentTeam),o=this.pageContext.getService("ITeamSettingsService");t&&t.name&&(this.currentTeam=t,o.updateTeamSettings({},this.currentTeam.id),this.teamSettings=o.getTeamSettingsObservable()),this.messagesService=(0,y.getBoardsMessagesService)(e),this.workItemFieldService=(0,I.getWorkItemFieldService)(this.pageContext),this.historyService=this.pageContext.getService("IVssHistoryService")},this._serviceEnd=e=>{super._serviceEnd(e)},this.addRowToIdsMap=e=>{this.allIdsToRowsMap.set(e.id,e)},this.clearErrorMessage=()=>{this.messagesService.dismissMessage()},this.getSelectedProviderItems=e=>{var t;const o=null===(t=this.backlogTree.value)||void 0===t?void 0:t.itemProvider.value,i=[...T(this.getTreeSelection().value.map((e=>{const t=[];for(let i=e.beginIndex;i<=e.endIndex;++i)t.push(o[i]);return t})))];return e&&-1===i.findIndex((t=>t.underlyingItem.data.id===e.underlyingItem.data.id))&&i.push(e),i},this.selectAllItems=()=>{var e;const t=null===(e=this.backlogTree.value)||void 0===e?void 0:e.itemProvider.value;t&&t.length>0&&this.getTreeSelection().select(0,t.length)},this.getSelectedTreeItems=e=>{var t,o;const i=null!==(o=null===(t=this.getSelectedProviderItems())||void 0===t?void 0:t.map((e=>e.underlyingItem)))&&void 0!==o?o:[];return e&&-1===i.findIndex((t=>t.data.id===e.data.id))&&i.push(e),i},this.getSelectedItems=e=>{var t,o;const i=null!==(o=null===(t=this.getSelectedProviderItems())||void 0===t?void 0:t.map((e=>{var t;return null===(t=null==e?void 0:e.underlyingItem)||void 0===t?void 0:t.data})))&&void 0!==o?o:[];return e&&-1===i.findIndex((t=>t.id===e.id))&&i.push(e),i},this.getBacklogCommandBarItems=e=>{var t;const i=this.pageContext.getService("ICurrentDirectoryService");return[{iconProps:{iconName:"Add"},id:"new-work-item",itemType:0,onActivate:(e,t)=>{this.onClickNewWorkitemBtn(t)},rank:1,subtle:!0,text:x.NewWorkItem},{iconProps:{iconName:"Repair"},id:"column-options",itemType:0,onActivate:()=>{this.openDialog((t=>{var o;return r.createElement(s.WrappedComponent,{dependencies:["ms.vss-work-web.backlogs-column-options-panel-container"],wrappedType:"backlogs-column-options-container",wrappedProps:{onDismiss:t,teamId:null===(o=i.getCurrentDirectory().value)||void 0===o?void 0:o.id,hubService:e}})}))},rank:3,subtle:!0,text:x.ColumnOptions},{iconProps:{iconName:"QueryList"},id:"create-query",itemType:0,onActivate:this.handleCreateQueryAction,rank:4,subtle:!0,text:x.CreateQuery},p.getEmailCommandMenuItem(this.pageContext,this.backlogTree.value.visibleColumns,(()=>Object.values(this.backlogTree.value.allRows).map((e=>e.value.coreColumnMap)).filter((e=>e[g.CoreFieldRefNames.Id]))),void 0,"",(0,o.format)(x.EmailSubject,this.currentTeam.name,null===(t=this.allBacklogLevels.find((e=>e.id===this.backlogLevelId)))||void 0===t?void 0:t.name))]},this.getCurrentTeam=()=>this.currentTeam,this.getDisplayState=()=>this.displayState,this.getFilter=()=>this.filter,this.getIsRequirementBacklog=()=>this.isRequirementsBacklog.value,this.getIsRootBacklog=()=>this.isRootBacklog.value,this.getNewItemCalloutAnchor=()=>this.newItemCalloutAnchor,this.getPageContext=()=>this.pageContext,this.getParentWorkItem=e=>this.parentWorkItems.get(e),this.getRecentQueryUrl=()=>this.queryUrl,this.getShouldShowOrderValues=()=>this.shouldShowOrderValues,this.getShowFilterHeader=()=>this.showFilterHeader,this.getShowQueryHeader=()=>this.showQueryHeader,this.getTeamAreaNodes=()=>this.teamAreaNodesById,this.getTeamField=()=>{var e;return null===(e=this.teamSettings.value)||void 0===e?void 0:e.teamFieldName},this.getTreeSelection=()=>this.treeSelection,this.getBacklogWorkItemTypeNames=()=>this.backlogWorkItemTypeNames,this.getBacklogDefaultWorkItemTypeName=async(e,t)=>{const o=await this.getAllBacklogLevels(e),i=null!=t?t:this.getBacklogLevelId(),a=o.find((e=>e.id===i||e.name===i));return null==a?void 0:a.defaultWorkItemType.name},this.processFetchedWorkItems=async(e,t,o)=>{var i,a;const r=null!==(i=this.getRollupColumnProviders())&&void 0!==i?i:[],l=await this.getChildWorkItemTypes(null===(a=this.backlogTree.value)||void 0===a?void 0:a.columnMap,e.data.rows,o),s=[];for(const i of e.data.rows){const{id:a,backlogItemUpdates:l}=await this.parseBacklogItemRowData(i,e.data.columns,t,o);if(r)for(const e of r)e.hasWorkItem(a)||e.checkAndUpdateWorkItemIds([a]);s.push([a,l])}this.setParents([...this.parentWorkItems].filter((([e,t])=>!t.value)).map((([e,t])=>e))),s.forEach((([e,t])=>{var o;null===(o=this.workItemIdsSet)||void 0===o||o.delete(e);const i=this.backlogTree.value,a=i.allRows[e].value;i.allRows[e].value={childWorkItemTypes:l[e],columnValues:this.updateRollupDataForNewItem(e,t.columnValues),coreColumnMap:t.coreColumnMap,isValid:a.isValid,order:a.order,workItemStateAndColor:t.workItemStateAndColor,workItemTypeColorAndIcon:t.workItemTypeColorAndIcon,workItemUrl:a.workItemUrl},this.allIdsToRowsMap.set(e,i.allRows[e])})),this.resetOrderColumn()},this.refreshTree=async e=>{(null==e?void 0:e.keepOpen)||this.clearCache(),(null==e?void 0:e.getData)&&await this.updateBacklogTree(null==e?void 0:e.getData,{updateFiltersOrOrder:!0,ignoreCache:!0,keepOpen:null==e?void 0:e.keepOpen,filterManager:null==e?void 0:e.filterManager})},this.setTeamAreaNodes=e=>{e&&e.teamFieldValues.forEach((e=>this.teamAreaNodesById.set(e.value,e)))},this.settingsServiceGetColumns=async(e,t)=>{var o;const i=this.pageContext.getService("ISettingsService"),a=null!=t?t:this.getBacklogLevelKey(),r=(await i.getEntriesAsync(e,0,A.BacklogColumnSettings.TeamScope,this.getCurrentTeam().id))[a];let l=[];if(!r){return null===(o=this.backlogTree.value)||void 0===o?void 0:o.visibleColumns}return r&&(l=JSON.parse(r)),l},this.settingsServiceSetColumns=async(e,t,i)=>{const a=this.pageContext.getService("ISettingsService"),r=null!=i?i:this.getBacklogLevelKey(),l=(0,o.format)(e,r),s=JSON.stringify(t);await a.setEntries({[l]:s},0,A.BacklogColumnSettings.TeamScope,this.getCurrentTeam().id)},this.settingsServiceResizeColumn=async(e,t,o,i)=>{const a=await this.settingsServiceGetColumns(e);let r=a.findIndex((e=>t===e.id));-1===r&&(r=a.findIndex((e=>t===e.fieldId))),-1!==r&&(a[r].width=o,this.settingsServiceSetColumns(`${e}/{0}`,a,i))},this.showBulkSaveErrorMessage=(e,t)=>{const o=[];e.results&&e.results.forEach((e=>{e.error&&o.push(e.error.message)})),this.messagesService.showMessage((0,y.getErrorMessage)(x.BulkSaveErrorMessage,[...new Set(o)],void 0,t))},this.showErrorMessage=(e,t)=>{this.messagesService.showMessage((0,y.getErrorMessage)(e,void 0,void 0,t))},this.setExceptionInfo=e=>{this.exceptionInfo.value=e},this.setNumberFilteredItems=e=>{this.filteredItems=e},this.teamOwnsWorkItem=e=>{if(!e)return!1;const t=this.getTeamAreaNodes();if(t.has(e))return!0;for(const[o,i]of t.entries())if(i.includeChildren&&e.startsWith(o))return!0;return!1},this.clearCache=()=>{this.backlogContent=void 0,this.allIdsToRowsMap.clear(),this.treeItemProvider&&(this.treeItemProvider.value=void 0),this.backlogWorkItemTypeNames=[],this.workItemIdsSet=void 0},this.getCorrectIdentityData=async e=>{const t=[...new Set(Object.values(e).filter((e=>e.value.coreColumnMap[g.CoreFieldRefNames.AssignedTo])))].map((e=>Number(e.value.coreColumnMap[g.CoreFieldRefNames.Id])));this.pageContext.getService("IWorkItemModelService").getWorkItems(t)},this.getQueryName=e=>{var t;const o=this.historyService.getState();let i=null!==(t=o.backlogLevel)&&void 0!==t?t:o.iteration;i=i.slice(i.lastIndexOf("/")+1);const a=null==e?void 0:e.name;return a?`${a} - ${i}`:""},this.getQuerySaveDialog=(e,t,o)=>{const i={wiql:t,name:this.getQueryName(e),isFolder:!1};return r.createElement(v.QuerySaveDialog,{mode:h.QuerySaveDialogMode.NewQuery,queryItem:i,onDismiss:o,onSave:e=>{this.queryUrl=(0,k.getQueryUrl)(this.pageContext,e),this.showQueryHeader.value=!0}})},this.handleCreateQueryAction=()=>{const e=this.pageContext.getService("ICurrentDirectoryService");this.openDialog((t=>this.getQuerySaveDialog(e.getCurrentDirectory().value,this.backlogWiql.value,t)))},this.onClickNewWorkitemBtn=e=>{this.newItemCalloutAnchor.value=e.currentTarget},this.parseBacklogItemRowData=async(e,t,a,r)=>{var l;const s=t.indexOf(g.CoreFieldRefNames.Id),n=function(e,t){return t.reduce(((t,o,i)=>(t[e[i]]=o,t)),{})}(t,e),{workItemState:c,workItemTags:d,workItemType:u,workItemProject:m}=function(e){var t,o,i,a;return{workItemState:null!==(t=e[g.CoreFieldRefNames.State])&&void 0!==t?t:"",workItemTags:(null!==(o=e[g.CoreFieldRefNames.Tags])&&void 0!==o?o:"").split(";"),workItemType:null!==(i=e[g.CoreFieldRefNames.WorkItemType])&&void 0!==i?i:"",workItemProject:null!==(a=e[g.CoreFieldRefNames.TeamProject])&&void 0!==a?a:""}}(n);let v;const h=[];let k;if(d.forEach((e=>{e.length>0&&h.push(e)})),u){if(v=null===(l=a[u])||void 0===l?void 0:l.find((e=>(0,o.equals)(e.name,c))),k=null==r?void 0:r.find((e=>(0,o.equals)(e.workItemTypeName,u))),!v){const e=this.pageContext.getService("work-item-state-color-metadata-service"),t=await e.getWorkItemStateColor(m,u,c);a[u]&&a[u].push(t),a[u]=[t],v=t}if(!k&&r){const e=this.pageContext.getService("work-item-type-icon-metadata-service"),t=await e.getWorkItemIcon(m,u);r.push(t),k=t}}const p=n[g.CoreFieldRefNames.Parent];p&&!this.parentWorkItems.get(p)&&this.parentWorkItems.set(p,new i.ObservableValue(void 0));return{id:e[s],backlogItemUpdates:{columnValues:e,coreColumnMap:n,workItemStateAndColor:v,workItemTypeColorAndIcon:k}}},this.setParents=async e=>{const t=this.pageContext.getService("IWorkItemModelService");try{if((e=e.filter((e=>e>=0)))&&0===e.length)return;const o=await t.getWorkItems(e);for(const e of o){const t=this.parentWorkItems.get(e.id);t&&(t.value=e)}}catch(e){}},this.updateBacklogTree=async(e,t)=>{((null==t?void 0:t.updateFiltersOrOrder)||(null==t?void 0:t.ignoreCache)||!this.backlogTree.value&&!this.buildBacklogTreePromise)&&(this.buildBacklogTreePromise=this.buildBacklogTree(e,t),this.backlogTree.value=await this.buildBacklogTreePromise,(null==t?void 0:t.updateFiltersOrOrder)&&((null==t?void 0:t.filterManager)&&t.filterManager.dataUpdated(),this.filter.setState(this.filter.getState())),this.buildBacklogTreePromise=void 0)}}async checkCompletedStateAsync(e){const t=await this.getBacklogConfiguration();if(!t)return!1;const o=e.value.coreColumnMap[g.CoreFieldRefNames.State],i=e.value.coreColumnMap[g.CoreFieldRefNames.WorkItemType];return this.pageContext.getService("IWorkItemTypesService").checkCompletedState(o,i,t)}async createNewTreeItem(e,t,o,i,a,r,l){const s=this.pageContext.getService("IBacklogWorkItemConfigurationService"),n=await s.getWorkItemTypeColorAndIcons(),c=n.find((e=>e.workItemTypeName===i)),d=await s.getWorkItemStateAndColorDictionary();let u=Object.entries(t).sort(((e,t)=>e[1]-t[1])).map((e=>{var t;return null!==(t=o[e[0]])&&void 0!==t?t:null}));const m=await this.getBacklogChildrenFromType(i,n);return u=this.updateRollupDataForNewItem(e,u),{data:new M.ObservableBacklogItem(e,l,{childWorkItemTypes:m,coreColumnMap:o,columnValues:u,order:r,isValid:!0,workItemUrl:null!=a?a:"",workItemStateAndColor:d[i][0],workItemTypeColorAndIcon:c})}}filterWorkItems(e,t,o){if(!this.backlogTree.value||!this.backlogTree.value.allRows)return;let i;if(i=o&&!0===o?this.hierarchyFilterBehaviour(e,t):this.flatFilterBehaviour(e,t),this.backlogTree.value){const e=this.getSelectedItems(),t=new d.TreeItemProvider(i);if(e){const o=this.getTreeSelection();o.clear();for(const i of e){const e=null==t?void 0:t.value.findIndex((e=>e.underlyingItem.data.id===i.id));void 0!==e&&-1!==e&&o.select(e,1,!0)}}this.backlogTree.value=Object.assign(Object.assign({},this.backlogTree.value),{itemProvider:t})}}hierarchyFilterBehaviour(e,t){if(!this.backlogTree.value||!this.backlogTree.value.allRows)return;let o;if(t){let t=[];this.backlogTree.value.rows.forEach((o=>{o.data&&(e.some((e=>o.data.id===e))||o.childItems&&this.anyChildContainsId(o.childItems,e))&&t.push(o)})),o=this.madeFilteredTree(t,e,!0)}else o=this.backlogTree.value.rows;return o}madeFilteredTree(e,t,o=!1){if(!e)return;let i=o?[]:void 0;for(let a of e){let e=!1,r=!1;if(a&&(t.find((e=>a.data.id===e))&&(e=!0),a.childItems&&this.anyChildContainsId(a.childItems,t)&&(a.expanded=!0,r=!0,e=!0),e||o)){i||(i=[]);const e=this.makeCopy(a);e.highlighted=!1,e.expanded=r,e.childItems=this.madeFilteredTree(a.childItems,t),i.push(e)}}return i}makeCopy(e){return{childItems:void 0,data:e.data,expanded:e.expanded,id:e.id,text:e.text}}anyChildContainsId(e,t){for(let o of e){if(o.data&&t.some((e=>o.data.id===e)))return!0;if(o.childItems&&this.anyChildContainsId(o.childItems,t))return!0}return!1}flatFilterBehaviour(e,t){var o;let i=[];for(const t of e){const e=this.allIdsToRowsMap.get(Number(t));e&&i.push(e)}if(this.allIdsToRowsMap.keys.length>this.filteredItems&&(this.showFilterHeader.value=!0),!this.backlogTree.value||!this.backlogTree.value.allRows)return;const a=null===(o=this.backlogContent)||void 0===o?void 0:o.targetIds,r=[],l={},s={};i.forEach((e=>{l[e.id]=e})),null==a||a.forEach((e=>{e>=0&&l[e]&&!s[e]&&(s[e]=!0,r.push(l[e]))})),i=a?r:i;return t?i.map((e=>({data:e}))):this.backlogTree.value.rows}async getAllBacklogLevels(e){var t,o;if(e){const o=this.allBacklogLevelsPerTeam.get(e);if(o)return o;{const o=(0,m.getWorkClient)(this.pageContext),i=(0,l.getTFSProject)(this.pageContext),a=(await o.getBacklogs({project:null!==(t=null==i?void 0:i.name)&&void 0!==t?t:"",projectId:null==i?void 0:i.id,team:"",teamId:e})).sort(((e,t)=>t.rank-e.rank));return this.allBacklogLevelsPerTeam.set(e,a),a}}if(!this.allBacklogLevels||0===this.allBacklogLevels.length){const e=(0,m.getWorkClient)(this.pageContext),t=(0,l.getTFSProject)(this.pageContext),i=await e.getBacklogs({project:null!==(o=null==t?void 0:t.name)&&void 0!==o?o:"",projectId:null==t?void 0:t.id,team:"",teamId:this.currentTeam.id});this.allBacklogLevels=i.sort(((e,t)=>t.rank-e.rank))}return this.allBacklogLevels}async getAvailableRollupColumns(e){await this.workItemFieldService.getFieldsAsync();const t=await this.getBacklogConfiguration(),i={type:L.RollupType.Progress,aggregation:L.RollupAggregation.Count},a={type:L.RollupType.Total,aggregation:L.RollupAggregation.Count},r={[L.RollupType.Progress]:[{displayName:x.ProgressByCompletedDescendents,referenceName:(0,L.getRollupColumnReferenceName)(i),rollupCalculation:i}],[L.RollupType.Total]:[{displayName:x.TotalByAllDescendents,referenceName:(0,L.getRollupColumnReferenceName)(a),rollupCalculation:a}]},l=[L.RollupType.Progress,L.RollupType.Total],s=await this.getAllBacklogLevels(),n=e=>{l.forEach((t=>{e&&e.forEach((e=>{const i={type:t,aggregation:L.RollupAggregation.Count,workItemTypeFilter:e},a=t===L.RollupType.Progress?x.ProgressByValue:x.TotalByValue;r[t].push({displayName:(0,o.format)(a,e),referenceName:(0,L.getRollupColumnReferenceName)(i),rollupCalculation:i})}))}))};if(t){if(e.value===t.taskBacklog.name)return[];let i=s.find((t=>e.value==t.name));if(i){const e=i.rank;s.forEach((t=>{t.rank<e&&n(t.workItemTypes.map((e=>e.name)))}))}else s.forEach((e=>{n(e.workItemTypes.map((e=>e.name)))}));const a=L.BacklogFieldTypes.Effort,c=L.BacklogFieldTypes.RemainingWork;[a,c].forEach((e=>{const i=t.backlogFields.typeFields[e],s=this.workItemFieldService.getFieldByReferenceName(i);if(s){const t=s.name;let n=[];switch(e){case c:n=[L.RollupType.Total];break;case a:n=l}n.forEach((e=>{const a={type:e,aggregation:L.RollupAggregation.Sum,aggregationField:i,aggregationFieldDisplayName:t};let l;l=e===L.RollupType.Progress?x.ProgressByValue:x.TotalByFieldName,r[e].push({displayName:(0,o.format)(l,t),referenceName:(0,L.getRollupColumnReferenceName)(a),rollupCalculation:a})}))}}))}return r[L.RollupType.Progress].concat(r[L.RollupType.Total])}async getBacklogConfiguration(){if(!this.backlogConfiguration){const e=this.pageContext.getService("IVssContributionService");this.backlogConfiguration=await e.getDataAsync("ms.vss-work-web.agile-backlog-configuration-data-provider")}return this.backlogConfiguration}getBacklogConfigurationSync(){if(!this.backlogConfiguration){const e=this.pageContext.getService("IVssContributionService");this.backlogConfiguration=e.getData("ms.vss-work-web.agile-backlog-configuration-data-provider")}return this.backlogConfiguration}getBacklogLevelId(){return this.backlogLevelId}getAllParents(e){return[]}getBacklogTree(e,t){return e&&this.updateBacklogTree(e,t),this.backlogTree}getAllIdsToRowsMap(){return this.allIdsToRowsMap}getBacklogWiql(e,t){return this.ensureBacklogContents(e,t),this.backlogWiql}getDataSourceName(){return S.name}getExceptionInfo(){return this.exceptionInfo}getIds(){return Array.from(this.allIdsToRowsMap.keys())}getItemCount(){return this.allIdsToRowsMap.size}getRollupData(e,t){const o=this.getRollupColumnProviders(),a=null==o?void 0:o.find((e=>(0,L.isRollupEqual)(e.getRollupMetric(),t)));return a?(a.checkAndUpdateWorkItemIds([e]),a.getRollupData(e,!0)):new i.ObservableValue(void 0)}getUniqueValues(e){var t;const i=new Set,a=[];if(!this.backlogTree.value)return[];const r=Object.values(this.backlogTree.value.allRows);for(const t of r){const o=t.value.coreColumnMap[e];if(o)if(e===g.CoreFieldRefNames.Tags){o.split(";").forEach((e=>i.add(e.trim())))}else if(e===g.CoreFieldRefNames.AssignedTo){const e=(0,C.createIdentityRefFromDistinctDisplayName)(this.pageContext,o.toString());i.has(e.id)||(a.push(e),i.add(e.id))}else e===g.CoreFieldRefNames.AreaPath?i.add((0,f.getAreaPathLeafNode)(o.toString())):i.add(o.toString())}if(e===g.CoreFieldRefNames.WorkItemType&&this.allBacklogLevels){const e=null===(t=this.allBacklogLevels.find((e=>e.id===this.backlogLevelId)))||void 0===t?void 0:t.rank;e&&this.allBacklogLevels.filter((t=>t.rank<e)).forEach((e=>{e.workItemTypes.forEach((e=>{i.add(e.name)}))}))}return a.length>0?a.sort(((e,t)=>(0,o.localeIgnoreCaseComparer)(e.displayName,t.displayName))):Array.from(i).sort(o.localeIgnoreCaseComparer)}getParentItems(){return Array.from(this.parentWorkItems.values()).filter((e=>e.value&&!e.value.getFieldValueByName(g.CoreFieldRefNames.Parent))).map((e=>({id:e.value.id,title:e.value.getFieldValueByName(g.CoreFieldRefNames.Title)}))).sort()}getParentWorkItems(){return this.parentWorkItems}getValue(e,t){if(!this.backlogTree.value||!this.backlogTree.value.allRows)return;const o=this.allIdsToRowsMap.get(e);return null==o?void 0:o.value.coreColumnMap[t]}getVisibleFields(){var e,t;return null!==(t=null===(e=this.backlogContent)||void 0===e?void 0:e.columns.map((e=>e.name)))&&void 0!==t?t:[]}getQueryType(){var e;return null===(e=this.backlogContent)||void 0===e?void 0:e.backlogQueryResultType}getWorkItemIdsSet(){var e;return this.workItemIdsSet||(this.workItemIdsSet=new Set,this.backlogTree.value&&Object.values(null===(e=this.backlogTree.value)||void 0===e?void 0:e.allRows).filter((e=>!e.value.coreColumnMap[g.CoreFieldRefNames.State])).forEach((e=>{this.workItemIdsSet.add(e.id)}))),this.workItemIdsSet}resetOrderColumn(){var e;let t=1;this.shouldShowOrderValues&&(null===(e=this.backlogTree.value)||void 0===e||e.itemProvider.value.map((e=>{const o=e.underlyingItem.data.value;o.workItemTypeColorAndIcon&&this.backlogWorkItemTypeNames.some((e=>{var t;return e===(null===(t=o.workItemTypeColorAndIcon)||void 0===t?void 0:t.workItemTypeName)}))&&!e.parentItem&&(o.order=t++,e.underlyingItem.data.value=o)})),this.backlogTree.notify(this.backlogTree.value,"change"))}setHubType(e){this.hub=e}setShouldShowOrderValues(e){this.shouldShowOrderValues=e}setDisplayState(e){this.displayState.value=e}reorderBacklogTreeRows(e){var t;const o=null===(t=this.backlogTree.value)||void 0===t?void 0:t.rows;if(!o)return;const i=[];e.forEach((e=>{const t=o.findIndex((t=>t.data.id===e.data.id)),a=o[t];(null==a?void 0:a.data.value.order)&&(i.push(a),o.splice(t,1))})),i.sort(((e,t)=>e.data.value.order-t.data.value.order)),i.forEach((e=>{const t=e.data.value.order-1;o.splice(t,0,e)}))}async updateWorkItemRow(e,t,o){const i=this.getRollupColumnProviders();if(null==i||i.forEach((e=>e.resetWorkItemList(this.backlogTree.value.rows.map((e=>e.data.id))))),o||!t){const o=this.pageContext.getService("IWorkItemModelService");t=await o.getWorkItem(e),await t.refresh()}return this.updateTreeLocally([t],(e=>{const o=e.coreColumnMap;for(const e of Object.keys(o)){const i=null==t?void 0:t.getFieldValueByName(e);i!==o[e]&&(o[e]=i)}}))}async updateTreeLocally(e,t,o,a){const r=this.pageContext.getService("IBacklogWorkItemConfigurationService"),l=await r.getWorkItemStateAndColorDictionary(),s=await r.getWorkItemTypeColorAndIcons(),[n,c]=await Promise.all([l,s]);e.map((e=>{var r,l,s,d,u,m;const v=null===(r=this.backlogTree.value)||void 0===r?void 0:r.itemProvider,h=null==v?void 0:v.value.findIndex((t=>t.underlyingItem.data.id===e.id));if(v&&-1===h&&o&&this.updateTreeChildNodes(e.id,t),v&&-1===h&&a&&this.removeChildNodesFromTree(e,a),v&&void 0!==h&&-1!==h){const e=v.value[h],o=null===(s=null===(l=null==e?void 0:e.underlyingItem)||void 0===l?void 0:l.data)||void 0===s?void 0:s.value,a=null===(d=null==e?void 0:e.parentItem)||void 0===d?void 0:d.underlyingItem;if(o){const a=o.coreColumnMap[g.CoreFieldRefNames.WorkItemType],r=o.coreColumnMap[g.CoreFieldRefNames.State],l=o.coreColumnMap[g.CoreFieldRefNames.Parent];t(o);const s=null===(u=this.backlogTree.value)||void 0===u?void 0:u.columnMap;if(s){const t=[];for(const e of Object.keys(s)){const i=o.coreColumnMap[e],a=s[e];void 0!==a&&(t[a]=i)}o.columnValues=this.updateRollupDataForNewItem(Number(e.underlyingItem.data.id),t)}const d=o.coreColumnMap[g.CoreFieldRefNames.WorkItemType],v=o.coreColumnMap[g.CoreFieldRefNames.State],h=o.coreColumnMap[g.CoreFieldRefNames.Parent];d&&v&&(r!==v||a!==d)&&(o.workItemStateAndColor=null===(m=n[d])||void 0===m?void 0:m.find((e=>e.name===v))),d&&d!==a&&(o.workItemTypeColorAndIcon=c.find((e=>e.workItemTypeName===d))),h&&h!==l&&!this.parentWorkItems.get(h)&&this.parentWorkItems.set(h,new i.ObservableValue(void 0))}v.remove(e.underlyingItem,a),e.underlyingItem.data.value=o;let r=h-1,k=v.value[r];if(e.parentItem===k||e.depth-1===k.depth)v.add(e.underlyingItem,null==k?void 0:k.underlyingItem,void 0);else{for(;k.depth!==e.depth;)r--,k=v.value[r];v.add(e.underlyingItem,a,null==k?void 0:k.underlyingItem)}}})),this.setParents([...this.parentWorkItems].filter((([e,t])=>!t.value)).map((([e,t])=>e)))}updateTreeChildNodes(e,t){var o;const i=null===(o=this.backlogTree.value)||void 0===o?void 0:o.itemProvider,a=i.roots;for(const o of a)this.updateTreeChildNodesInternal(e,t,i,o)}updateTreeChildNodesInternal(e,t,o,i){if(i.childItems)for(const a of i.childItems)(null==a?void 0:a.childItems)&&this.updateTreeChildNodesInternal(e,t,o,a),a.data.id===e&&t(a.data.value)}removeChildNodesFromTree(e,t){var o;const i=null===(o=this.backlogTree.value)||void 0===o?void 0:o.itemProvider;if(i){const o=i.roots;for(const a of o)this.removeChildNodesFromTreeInternal(e,t,i,a)}}removeChildNodesFromTreeInternal(e,t,o,i){var a;if(!i.childItems)return;let r=i.childItems.length;for(;r--;){const l=i.childItems[r];l.childItems&&this.removeChildNodesFromTreeInternal(e,t,o,l);t(e,l.data.value)&&(o.remove(l),null===(a=i.childItems)||void 0===a||a.splice(r,1))}}async buildBacklogTree(e,t){var o,i,a,r,l,s;const n=(null==t?void 0:t.keepOpen)?this.getExpandedItemIds():new Set,c=this.pageContext.getService("IBacklogWorkItemConfigurationService"),u=c.getWorkItemStateAndColorDictionary(),m=c.getWorkItemTypeColorAndIcons();if(await this.ensureBacklogContents(e,t),this.backlogContent){const e=this.backlogContent,t=this.pageContext.getService("IVssLocationService"),c=this.pageContext.getService("ITfsPageService").getData(),v=null!==(i=null===(o=null==c?void 0:c.project)||void 0===o?void 0:o.name)&&void 0!==i?i:"";let h=e.payload.columns.reduce(((e,t,o)=>(e[t]=o,e)),{});const k=e.payload.columns.indexOf(g.CoreFieldRefNames.Id),p=e.payload.rows.reduce(((e,t)=>(e[t[k]]=t,e)),{}),I=await u,f=await m,C=await this.getChildWorkItemTypes(h,e.payload.rows,f),y=null!==(a=this.getRollupColumnProviders(!0))&&void 0!==a?a:[];this.orderColumn=1;const S={ids:e.targetIds.map(((t,o)=>({targetId:t,sourceId:e.sourceIds[o]}))),allRows:{},visibleRows:[]};for(const o of S.ids){const{targetId:i,sourceId:a}=o,s=null!==(r=p[i])&&void 0!==r?r:[],{id:n,backlogItemUpdates:c}=await this.parseBacklogItemRowData(s,e.payload.columns,I,f),d=new M.ObservableBacklogItem(i,a>0?S.allRows[a]:void 0,{childWorkItemTypes:C[i],columnValues:s,coreColumnMap:c.coreColumnMap,isValid:!0,order:this.shouldShowOrderValues&&(null===(l=c.workItemTypeColorAndIcon)||void 0===l?void 0:l.workItemTypeName)&&this.backlogWorkItemTypeNames.some((e=>{var t;return e===(null===(t=c.workItemTypeColorAndIcon)||void 0===t?void 0:t.workItemTypeName)}))&&0===a?this.orderColumn++:void 0,workItemUrl:t.routeUrl("ms.vss-work-web.work-items-form-route",{id:i.toString(),project:v}),workItemStateAndColor:c.workItemStateAndColor,workItemTypeColorAndIcon:c.workItemTypeColorAndIcon});if(y)for(const e of y)e.hasWorkItem(d.id)||e.checkAndUpdateWorkItemIds([d.id]);d.parent?d.parent.children.push(d):S.visibleRows.push(d),S.allRows[i]=d}Object.entries(S.allRows).forEach((([e,t])=>this.allIdsToRowsMap.set(Number(e),t))),this.getCorrectIdentityData(S.allRows);const w=null===(s=this.allBacklogLevels.find((e=>e.id===this.backlogLevelId||e.name===this.backlogLevelId)))||void 0===s?void 0:s.workItemTypes,T=(e,t)=>{t&&w&&(0===e.value.columnValues.length||w.some((t=>t.name===e.value.coreColumnMap[g.CoreFieldRefNames.WorkItemType]))||n.size>0)&&(t=!1);const o=e.children.length>0?e.children.map((e=>T(e,t))):void 0;return{expanded:n.has(e.id)||t,childItems:o,data:e}};await this.getAllBacklogLevels();let B=this.setUnparentedFolderItems(S.visibleRows,T);B=await this.getRowRollupData(y,B);const b=new d.TreeItemProvider(B);this.setParents([...this.parentWorkItems.keys()]),await Promise.all(this.columnPreferences.map((async e=>{var t;e.rollup&&(e.rollupCalculation.aggregationFieldDisplayName=await this.getFieldDefinitionDisplayName(null!==(t=e.rollupCalculation.aggregationField)&&void 0!==t?t:""))})));const F=this.columnPreferences.map((t=>t.rollup?{name:t.fieldName,rollupCalculation:t.rollupCalculation,rollup:t.rollup,text:(0,L.getRollupColumnDisplayName)(t.rollupCalculation),columnIndex:t.columnIndex,width:t.columnWidth}:e.columns.find((e=>e.name===t.fieldName)))).filter((e=>!!e));return{allRows:S.allRows,columnMap:h,itemProvider:b,rows:B,visibleColumns:e.columns,rollupColumns:F}}}async ensureBacklogContents(e,t){var o,i,a,r,l;const s=()=>this.filter.statesAreEqual(this.filter.getDefaultState(),this.filter.getState());if((null==t?void 0:t.ignoreCache)||!this.backlogContent){(null==t?void 0:t.keepOpen)||(this.displayState.value=0);const n=await e(t);if(w(n))this.backlogContent=void 0,this.exceptionInfo.value=n.exceptionInfo;else{this.exceptionInfo.value=void 0,(null==n?void 0:n.initialBacklogFilterJson)&&s()&&this.filter.setState(JSON.parse(n.initialBacklogFilterJson)),s()||(this.showFilterHeader.value=!0),this.backlogContent=n.backlogQueryResults,this.backlogLevelId=n.backlogLevelId,this.backlogWiql.value=n.backlogWiql;for(const e of n.backlogWorkItemTypeNames)this.backlogWorkItemTypeNames.some((t=>t===e))||this.backlogWorkItemTypeNames.push(e);this.columnPreferences=null!==(o=n.columnPreferences)&&void 0!==o?o:[]}const c=null!==(l=null===(r=null===(a=null===(i=this.backlogContent)||void 0===i?void 0:i.payload)||void 0===a?void 0:a.rows)||void 0===r?void 0:r.length)&&void 0!==l?l:0;this.displayState.value=c>0?2:1}}async getBacklogChildrenFromType(e,t){var o,i;await this.getAllBacklogLevels();const a=null===(o=this.allBacklogLevels.find((t=>t.workItemTypes.find((t=>t.name===e)))))||void 0===o?void 0:o.rank;if(a){const e=null===(i=this.allBacklogLevels.find((e=>e.rank<a)))||void 0===i?void 0:i.workItemTypes;if(e){const o=[];for(let i=0;i<e.length;i++){const a=t.find((t=>!t.isDisabled&&t.workItemTypeName===e[i].name));a&&o.push(a)}return o}}return[]}getBacklogLevelKey(){let e;switch(this.backlogLevelId){case A.BacklogColumnSettings.BacklogItems:case A.BacklogColumnSettings.Issues:case A.BacklogColumnSettings.Requirements:e=A.BacklogColumnSettings.IssuesKey;break;default:e=this.backlogLevelId}return e}async getChildWorkItemTypes(e,t,o){let i={};const a=e[g.CoreFieldRefNames.WorkItemType],r=e[g.CoreFieldRefNames.Id];return await this.getAllBacklogLevels(),await Promise.all(t.map((async(e,l)=>{const s=t[l][a],n=t[l][r];i[n]=await this.getBacklogChildrenFromType(s,o)}))),i}async getFieldDefinitionDisplayName(e){await this.workItemFieldService.getFieldsAsync();const t=this.workItemFieldService.getFieldByReferenceName(e);return null==t?void 0:t.name}getRollupColumnProviders(e){var t,o;if(!this.columnPreferences)return;if(this.rollupProviders&&!e)return this.rollupProviders;const i=this.pageContext.getService("ITfsPageService").getData(),a=null!==(o=null===(t=null==i?void 0:i.project)||void 0===t?void 0:t.id)&&void 0!==o?o:"",r=this.columnPreferences.filter((e=>e.rollup)),l=[];for(const e of r)l.push(new u.WorkItemRollupProvider(this.pageContext,e.rollupCalculation,a));return this.rollupProviders=l,l}async getRowRollupData(e,t){for(let o=0;o<t.length;o++){const i=t[o];if(0==i.data.value.columnValues.length)break;for(const t of e){const e=t.getRollupData(i.data.id);i.data.value.columnValues.push(e);const o=i.data.value.columnValues.length-1,a=this.columnPreferences.findIndex((e=>{if(e.rollup)return(0,L.isRollupEqual)(e.rollupCalculation,t.getRollupMetric())}));a&&this.columnPreferences[a]&&(this.columnPreferences[a].columnIndex=o)}}return t}openDialog(e){this.pageContext.getService("IVssLayoutManager").renderCallout((t=>e(t)))}getExpandedItemIds(){var e;const t=new Set;return null===(e=this.backlogTree.value)||void 0===e||e.itemProvider.value.forEach((e=>{e.underlyingItem.expanded&&t.add(e.underlyingItem.data.id)})),t}setUnparentedFolderItems(e,t){var o;const i=this.getBacklogLevelId(),a=this.allBacklogLevels,r=null===(o=a.find((e=>e.id===i)))||void 0===o?void 0:o.name,l="true"===this.historyService.getState().showParents,s=[];let n,c=[];const d=e.length-1;let u,m=l?this.getStartLevelIndex(r,e):1;const g=()=>{var e;if(!n)return;const o=this.getExpandedItemIds(),i={expanded:!(o.size>0&&!o.has(n.id)),childItems:c.map((e=>t(e,!1))),data:n};i.data.children=c,"Backlogs"===this.hub?i.data.value.backlogLevel=a[m].name:i.data.value.backlogLevel="",m++,u&&"Sprints"!==this.hub?null===(e=u.childItems)||void 0===e||e.push(i):s.push(i),u=i,c=[]};for(let o=0;o<e.length;o++){const i=e[o];if(i.id>=0)if(n){const e=a.find((e=>e.workItemTypes.some((e=>{var t;return e.name===(null===(t=i.value.workItemTypeColorAndIcon)||void 0===t?void 0:t.workItemTypeName)}))));"Sprints"===this.hub&&(null==e?void 0:e.id)===A.BacklogColumnSettings.Requirements?(g(),n=void 0,s.push(t(i,!0))):c.push(i)}else s.push(t(i,!0));n&&(i.id<=0||o==d)?(g(),n=i):!n&&i.id<=0&&(n=i)}return s}updateRollupDataForNewItem(e,t){const o=this.getRollupColumnProviders();return o&&o.forEach((o=>{const i=o.getRollupData(e);t.push(i)})),t}getOrAddUnparentedFolder(){var e,t,o,i;const a=this.getBacklogLevelId(),r=this.allBacklogLevels,l=null===(e=r.find((e=>e.id===a)))||void 0===e?void 0:e.name,s=this.getBacklogLevelNameOfFirstItem(),n=null===(t=r.find((e=>!e.isHidden)))||void 0===t?void 0:t.name;let c,d=null===(o=this.backlogTree.value)||void 0===o?void 0:o.rows,u=!1,m=this.getStartLevelIndex(l),g=r[m].name;if(s&&l!==s||l!==g||l!==n){for(;d;){if(d.forEach((e=>{if(e.data.value.backlogLevel){if(e.expanded=!0,u=!0,e.data.value.backlogLevel===l)return;c=e,d=e.childItems}})),u){const e=null==d?void 0:d.findIndex((e=>e.data.value.backlogLevel===l));e>-1&&(c=d[e])}else{const e=m-r.length,t=this.createTempUnparentedFolder(e,g);if(null===(i=this.backlogTree.value)||void 0===i||i.itemProvider.add(t,c,null==d?void 0:d[d.length-1]),l===g)return t;d=t.childItems,c=t}if(m++,u=!1,!(m<r.length))break;g=r[m].name}return c}}getAllVisibleLevels(){return this.allBacklogLevels.filter((e=>!e.isHidden))}getStartLevelIndex(e,t){const o=t?this.getLevelIndexOfItemOrFirst(t[0]):this.getLevelIndexOfItemOrFirst();if(void 0!==o)return this.allBacklogLevels[o].name===e?o:o+1;const i=this.allBacklogLevels.findIndex((e=>!e.isHidden));if(0===i)return this.allBacklogLevels[i].name===e?0:1;let a=0;if(t?a=t.reduce(((e,t)=>t.id<0?++e:e),0):this.allIdsToRowsMap.forEach(((e,t)=>{t<0&&a++})),a>1){return this.allBacklogLevels.findIndex((t=>t.name===e))-a+1}if(-1!==i){return i===this.allBacklogLevels.findIndex((t=>t.name===e))?i:i+1}return 1}getLevelIndexOfItemOrFirst(e){var t,o;const i=e?this.getItemType(e):this.getItemType(null===(o=null===(t=this.backlogTree.value)||void 0===t?void 0:t.rows[0])||void 0===o?void 0:o.data),a=this.allBacklogLevels.findIndex((e=>e.defaultWorkItemType.name===i));if(i&&-1!==a)return a}getBacklogLevelNameOfFirstItem(){var e;const t=this.getItemType(this.getFirstItem());if(t)return null===(e=this.allBacklogLevels.find((e=>e.defaultWorkItemType.name===t)))||void 0===e?void 0:e.name}getItemType(e){var t;return null===(t=null==e?void 0:e.value.coreColumnMap[g.CoreFieldRefNames.WorkItemType])||void 0===t?void 0:t.toString()}getFirstItem(){var e;const t=null===(e=this.backlogContent)||void 0===e?void 0:e.targetIds.find((e=>e>0));if(t){return this.getAllIdsToRowsMap().get(t)}}createTempUnparentedFolder(e,t){return{expanded:!0,childItems:[],data:new M.ObservableBacklogItem(e,void 0,{childWorkItemTypes:[],columnValues:[],coreColumnMap:{},isValid:!0,workItemUrl:"",backlogLevel:t})}}}function w(e){return!!e.exceptionInfo}function T(e){const t=[];for(const o of e)t.push(...o);return t}t[e].isExceptionInfoResult=w,a.Services.add("ICommonBacklogContentService",{serviceFactory:S})}("ICommonBacklogContentService"),function(e){t.IBacklogWorkItemService={};class o extends a.VssService{constructor(){super(...arguments),this.itemsBeingFetched=[],this.itemsToFetch={all:{},waitList:[]},this.timerManagement=new S.TimerManagement,this.reorderedWorkItemIds={},this.insertingFixEnabled=!0,this._serviceStart=e=>{super._serviceStart(e),this.commonBacklogContentService=e.getService("ICommonBacklogContentService"),this.filterManager=new B.FilterManager(this.commonBacklogContentService),this.workItemModelService=e.getService("IWorkItemModelService"),this.debouncedFetchWorkItems=this.timerManagement.debounce(this.doFetchWorkItems,200),this.insertingFixEnabled=!(0,w.isFeatureFlagEnabled)(this.pageContext,T.FeatureFlags.BacklogItemsInsertingFixDisabled,!1)},this._serviceEnd=e=>{super._serviceEnd(e)},this.addWorkItem=async(e,t,o,i)=>{var a,r,l,s,n,c,d,u,m,v,h,k,p,I,f,C,y,S;const w=this.commonBacklogContentService.getBacklogTree(),T=null===(a=this.pageContext.getService("ITfsPageService").getData())||void 0===a?void 0:a.project,B=this.pageContext.getService("ITeamSettingsService").getTeamSettingsObservable().value,b="true"===this.pageContext.getService("IVssHistoryService").getState().showParents,P={projectId:null!==(r=null==T?void 0:T.id)&&void 0!==r?r:"",fields:{},revisions:null,tags:[],files:[],referencedPersons:{},tempId:W.WorkItem.getTempId(),loadTime:new Date,currentExtensions:[],referencedNodes:{areaNodes:[],iterationNodes:[]}},N=await this.workItemModelService.getWorkItemTypeData(null!==(l=null==T?void 0:T.id)&&void 0!==l?l:"",[t]);if(N&&1===N.length){const a=await this.workItemModelService.createWorkItem(N[0],null!==(s=null==T?void 0:T.id)&&void 0!==s?s:"",P);a.setFieldValueByName(g.CoreFieldRefNames.Title,e),(null==B?void 0:B.teamFieldName)===g.CoreFieldRefNames.AreaPath&&a.setFieldValueByName(g.CoreFieldRefNames.AreaPath,B.teamFieldDefaultValue),i&&a.setFieldValueByName(g.CoreFieldRefNames.IterationId,i);const r=null===(n=w.value)||void 0===n?void 0:n.columnMap,l={"System.Title":e,"System.WorkItemType":t,"System.TeamProject":null!==(c=null==T?void 0:T.name)&&void 0!==c?c:"","System.Rev":1},x=await this.commonBacklogContentService.createNewTreeItem(W.WorkItem.getTempId(),r,l,t),L=null!==(d=this.getInsertIndex(o,w,b))&&void 0!==d?d:0;let M,D;const O=L>=0?null===(u=w.value)||void 0===u?void 0:u.itemProvider.value[L]:void 0;M=null==O?void 0:O.underlyingItem;const V=null===(m=w.value)||void 0===m?void 0:m.itemProvider.value[null!==(v=L+1)&&void 0!==v?v:0],E=await this.getBacklogLevels();if(o===A.AddWorkItemLocations.Selection&&V)if(this.insertingFixEnabled){const e=this.getWorkItemBacklogLevel(V,E),t=this.getCurrentBacklogLevel(E);if(e&&t){if(e.rank<=t.rank)if(V.underlyingItem.data.value.backlogLevel)D=V.underlyingItem,M=void 0;else{const e=this.getFirstAppropriateParentItem(E,t,V);D=null===(h=null==e?void 0:e.parentItem)||void 0===h?void 0:h.underlyingItem,M=null==e?void 0:e.underlyingItem}else if(e.rank>t.rank){const e=this.findAppropriateChild(null===(k=w.value)||void 0===k?void 0:k.rows,E,t,V);e&&(D=e,M=void 0)}}else D=void 0,M=V.underlyingItem}else{const e=this.commonBacklogContentService.getBacklogLevelId(),t=await this.commonBacklogContentService.getAllBacklogLevels(),o=t.find((e=>{const t=V.underlyingItem.data.value.backlogLevel;return t?e.name===t:!!e.workItemTypes.find((e=>e.name===V.underlyingItem.data.value.workItemTypeColorAndIcon.workItemTypeName))})),i=t.find((t=>t.id===e||t.name===e));(!o||!i||o.rank<=i.rank&&!V.underlyingItem.data.value.backlogLevel)&&(D=null===(p=V.parentItem)||void 0===p?void 0:p.underlyingItem,M=V.underlyingItem)}else b&&(D=this.commonBacklogContentService.getOrAddUnparentedFolder(),o===A.AddWorkItemLocations.Top&&(M=void 0));this.insertingFixEnabled&&(o===A.AddWorkItemLocations.Bottom&&(M=b?null===(I=null==D?void 0:D.childItems)||void 0===I?void 0:I[D.childItems.length-1]:null===(f=w.value)||void 0===f?void 0:f.rows[w.value.rows.length-1]),o===A.AddWorkItemLocations.Top&&M&&M.data.id>0&&(M=void 0),D&&(null===(C=w.value)||void 0===C||C.itemProvider.expand(D,!0))),null===(y=w.value)||void 0===y||y.itemProvider.add(x,D,M),D&&D.data.id>=0&&a.addLinks([await R.WorkItemLink.create(this.pageContext,F.LinkTypeName.Parent_Link_Name,D.data.id)]),!this.insertingFixEnabled&&M&&M.data.value.coreColumnMap[g.OobFieldRefNames.StackRank]&&a.setFieldValueByName(g.OobFieldRefNames.StackRank,Number(M.data.value.coreColumnMap[g.OobFieldRefNames.StackRank])+10);try{if(await a.isValid()){const e=this.pageContext.getService("IWorkItemSavingService");await e.saveWorkItemsBatchAsync([a]),await this.finalizeItem({workItem:a,item:M,backlogTree:w,parentItem:D,direction:o,columnMapDict:r,placeholderTreeItem:x,witType:t})}else{this.pageContext.getService("IWorkItemFormDialogService").showWorkItemFormDialog(a,(()=>{this.finalizeItem({workItem:a,item:M,backlogTree:w,parentItem:D,direction:o,columnMapDict:r,placeholderTreeItem:x,witType:t})}),{onDismiss:()=>{var e;a.isNew()&&(null===(e=w.value)||void 0===e||e.itemProvider.remove(x))}})}}catch(e){null===(S=w.value)||void 0===S||S.itemProvider.remove(x)}}},this.addChildWorkItem=async(e,t,o)=>{var i,a,r,s,n,c,d;const u=this.commonBacklogContentService.getBacklogTree(),m=null===(i=u.value)||void 0===i?void 0:i.columnMap,g={};for(const t in m)g[t]=e.getFieldValueByName(t);let v=this.getInsertIndex(o,u,!1);const h=(null==t?void 0:t.childItems)?null===(a=null==t?void 0:t.childItems)||void 0===a?void 0:a[t.childItems.length-1]:void 0!==v&&v>=0?null===(r=u.value)||void 0===r?void 0:r.itemProvider.value[v].underlyingItem:void 0,k=this.pageContext.getService("IVssLocationService").routeUrl("ms.vss-work-web.work-items-form-route",{id:e.id.toString(),project:null!==(n=null===(s=(0,l.getTFSProject)(this.pageContext))||void 0===s?void 0:s.name)&&void 0!==n?n:""}),p=h?h.data.value.order:void 0,I=await this.commonBacklogContentService.createNewTreeItem(e.id,m,g,e.getTypeData().name,k,p,null==t?void 0:t.data);if(!this.insertingFixEnabled){const t=null===(c=u.value)||void 0===c?void 0:c.rows;t&&await this.reorderTreeWorkItems(t,o,e.id)}null===(d=u.value)||void 0===d||d.itemProvider.add(I,t,h),null==t||t.data.children.push(I.data),this.updateBacklogTreeRowsAdd(I,t),this.updateFilter(),this.commonBacklogContentService.resetOrderColumn()},this.changeWorkItemParentLink=async(e,t)=>{const o=await this.getWorkItemFromModelService(e);await Promise.all(o.map((async e=>{const o=e.getLinks().find((e=>-2===e.linkData.LinkType));o&&e.removeLinks([o]),t>0&&e.addLinks([await R.WorkItemLink.create(this.pageContext,"System.LinkTypes.Hierarchy-Reverse",t)])}))),await this.commonBacklogContentService.updateTreeLocally(o,(e=>{e.coreColumnMap[g.CoreFieldRefNames.Parent]=t})),await this.saveWorkItems(o)},this.changeWorkItemIteration=async(e,t,o,i,a)=>{const r=await this.getWorkItemFromModelService(e);if(r.length>0){const e=r[0].getFieldValueByName(g.CoreFieldRefNames.IterationPath);r.map((e=>{t&&e.setFieldValueByName(g.CoreFieldRefNames.IterationId,t),e.setFieldValueByName(g.CoreFieldRefNames.IterationPath,i)})),await this.commonBacklogContentService.updateTreeLocally(r,(e=>{t&&(e.coreColumnMap[g.CoreFieldRefNames.IterationId]=t),e.coreColumnMap[g.CoreFieldRefNames.IterationPath]=i}),!0,((t,o)=>{const i=null!=a&&!0===a,r=o.coreColumnMap[g.CoreFieldRefNames.IterationPath],l=o.coreColumnMap[g.CoreFieldRefNames.Id],s=!!l&&t.id===l;return i&&s&&e!=r}))}return this.saveWorkItems(r)},this.clearCache=()=>{this.itemsToFetch={all:{},waitList:[]}},this.deleteWorkItem=e=>{const t=this.commonBacklogContentService.getBacklogTree();if(t.value){const o=t.value,i=e.reduce(((e,t)=>(e[t.value.coreColumnMap[g.CoreFieldRefNames.Id]]=t,e)),{}),a=e=>e.data.value.coreColumnMap[g.CoreFieldRefNames.Id],r=e=>e.filter((e=>(e.data.parent&&i[e.data.parent.value.coreColumnMap[g.CoreFieldRefNames.Id]]&&(i[a(e)]=e.data),!i[a(e)]))),l=r(o.rows);let s=o.allRows;for(const e in i)delete s[e];const n=e=>{if(!e)return;const t=r(e);return t.forEach((e=>{e.childItems=n(e.childItems)})),t},c=n(o.itemProvider.value.filter((e=>0===e.depth)).map((e=>e.underlyingItem)));t.value=Object.assign(Object.assign({},t.value),{allRows:s,rows:l,itemProvider:new d.TreeItemProvider(c)}),0===t.value.itemProvider.length&&this.commonBacklogContentService.setDisplayState(1),this.updateBacklogTreeRowsDelete(o.itemProvider.value.filter((e=>i[e.underlyingItem.data.id])))}this.updateFilter()},this.fetchWorkItem=e=>{e>=0&&!this.itemsToFetch.all[e]&&(this.itemsToFetch.all[e]=e,this.itemsToFetch.waitList.unshift(e),this.debouncedFetchWorkItems())},this.getFilterManager=()=>this.filterManager,this.pageMoreItems=e=>{var t;const o=this.commonBacklogContentService.getWorkItemIdsSet();if(null===(t=this.commonBacklogContentService.getBacklogTree().value)||void 0===t?void 0:t.allRows)for(;e>0&&o.size>0;){const t=o.values().next().value;if(!t)break;this.pageContext.getService("IBacklogWorkItemService").fetchWorkItem(t),o.delete(t),e--}},this.reorderWorkItem=async(e,t,o,i,a)=>{var r;if(null===(r=this.commonBacklogContentService.getBacklogTree().value)||void 0===r?void 0:r.itemProvider.value){let r=!1,l=null;const s=await this.getWorkItemFromModelService(e);if(await Promise.all(s.map((async e=>{l=e.getFieldValueByName(g.CoreFieldRefNames.IterationPath);const o=e.getLinks().find((e=>-2===e.linkData.LinkType));o?o.linkData.ID!=(null==t?void 0:t.id)&&(r=!0):(null==t?void 0:t.id)&&(r=!0)}))),t&&r){if(await this.changeWorkItemParentLink(e,t.id),t.children.length>1){const r=await this.reorderBacklogWorkItems(e,o,i,t,l,null==a?void 0:a.identifier);this.updateWorkItemsRevision(r,s),this.setReorderedWorkItemIds(e,!0)}}else{const r=await this.reorderBacklogWorkItems(e,o,i,t,l,null==a?void 0:a.identifier);this.updateWorkItemsRevision(r,s),this.setReorderedWorkItemIds(e,!0)}}},this.updateBacklogTreeRowsDelete=e=>{var t;const o=this.commonBacklogContentService.getBacklogTree().value;if(!o)return;const i=this.commonBacklogContentService.getAllIdsToRowsMap(),a=o.allRows;for(const r of e)if(o.itemProvider.splice(null===(t=r.parentItem)||void 0===t?void 0:t.underlyingItem,[r.underlyingItem]),i.delete(r.underlyingItem.data.id),delete a[r.underlyingItem.data.id],r.parentItem){const e=o.itemProvider.value.find((e=>e.underlyingItem.data.id===r.parentItem.underlyingItem.data.id));e&&(e.underlyingItem.data.children=e.underlyingItem.data.children.filter((e=>e.id!==r.underlyingItem.data.id)),o.allRows[r.parentItem.underlyingItem.data.id]=e.underlyingItem.data,i.set(r.parentItem.underlyingItem.data.id,e.underlyingItem.data))}},this.updateWorkItems=async(e,t)=>{const o=this.commonBacklogContentService.getBacklogTree(),i=this.pageContext.getService("IWorkItemSavingService"),a=e.map((e=>({workItem:e,updates:e.getFieldUpdates()})));try{await i.saveWorkItemsBatchAsync(e),this.commonBacklogContentService.clearErrorMessage()}catch(t){return e.map((e=>this.updateIsValid(e,!1))),void this.commonBacklogContentService.showBulkSaveErrorMessage(t)}if(e.map((e=>this.updateIsValid(e,!0))),o.value){const e=o.value,i=t.reduce(((e,t)=>(e[t.value.coreColumnMap[g.CoreFieldRefNames.Id]]=t,e)),{});a.forEach((async t=>{var o,a;const{workItem:r,updates:s}=t,n=i[r.id];if(n&&(Object.keys(s).forEach((e=>{var t;const o=null===(t=r.getFieldById(parseInt(e)))||void 0===t?void 0:t.fieldDefinition.referenceName;o&&(n.value.coreColumnMap[o]=s[parseInt(e)])})),n.value.columnValues=e.visibleColumns.map((e=>n.value.coreColumnMap[e.name])),s[g.DalFields.WorkItemTypeId])){const e=null!==(a=null===(o=(0,l.getTFSProject)(this.pageContext))||void 0===o?void 0:o.id)&&void 0!==a?a:"",t=this.pageContext.getService(b.WorkItemTypeIconMetadataServiceId),i=await t.getWorkItemIcon(e,s[g.DalFields.WorkItemTypeId]);n.value=Object.assign(Object.assign({},n.value),{workItemTypeColorAndIcon:i}),this.commonBacklogContentService.showErrorMessage(x.ChangesRequireRefresh,"Warning")}}));const r=e.itemProvider.value.filter((e=>0===e.depth)).map((e=>e.underlyingItem));o.value=Object.assign(Object.assign({},o.value),{itemProvider:new d.TreeItemProvider(r)}),this.updateFilter()}},this.doFetchWorkItems=async()=>{const e=this.commonBacklogContentService.getBacklogTree().value;if(this.itemsBeingFetched.length>0||!e)return;const t=this.pageContext.getService("IBacklogWorkItemConfigurationService"),o=t.getWorkItemStateAndColorDictionary(),i=t.getWorkItemTypeColorAndIcons();if(this.itemsBeingFetched=this.itemsToFetch.waitList.splice(0,200),0==this.itemsBeingFetched.length)return;const a=this.pageContext.getService("IVssContributionService"),[r,l,s]=await Promise.all([await a.getDataAsync(A.CommonBacklogDataProviders.PageWorkItemsDataProvider,{fields:Object.keys(e.columnMap).join(","),workItemIds:this.itemsBeingFetched.join(",")},!0),o,i]);r&&r.errorMessage?this.commonBacklogContentService.setExceptionInfo({exceptionMessage:r.errorMessage}):r&&(this.itemsBeingFetched=[],this.itemsToFetch.waitList.length>0&&this.debouncedFetchWorkItems(),await this.commonBacklogContentService.processFetchedWorkItems(r,l,s),this.updateFilter())},this.getInsertIndex=(e,t,o)=>{var i,a,r,l;if(e===A.AddWorkItemLocations.Bottom||o&&e===A.AddWorkItemLocations.Top){const e=null===(r=null===(a=null===(i=t.value)||void 0===i?void 0:i.itemProvider)||void 0===a?void 0:a.value)||void 0===r?void 0:r.length;return e?e-1:void 0}if(e===A.AddWorkItemLocations.Selection){const e=this.commonBacklogContentService.getTreeSelection();return(null===(l=null==e?void 0:e.value[0])||void 0===l?void 0:l.beginIndex)-1}},this.getWorkItemFromModelService=async(e,t)=>this.workItemModelService.getWorkItems(e,void 0,void 0,void 0,t),this.getFirstAppropriateParentItem=(e,t,o)=>{var i;return o&&o.parentItem&&(null===(i=this.getWorkItemBacklogLevel(o,e))||void 0===i?void 0:i.rank)!==t.rank?this.getFirstAppropriateParentItem(e,t,o.parentItem):o},this.findRoot=e=>e.parentItem?this.findRoot(e.parentItem):e,this.saveWorkItems=async e=>{const t=this.pageContext.getService("IWorkItemSavingService");try{await t.saveWorkItemsBatchAsync(e),this.commonBacklogContentService.clearErrorMessage()}catch(t){return e.map((e=>this.updateIsValid(e,!1))),this.commonBacklogContentService.showBulkSaveErrorMessage(t),!1}return e.map((e=>this.updateIsValid(e,!0))),this.filterManager.dataUpdated(),!0}}async finalizeItem({workItem:e,item:t,backlogTree:o,parentItem:i,direction:a,columnMapDict:r,placeholderTreeItem:s,witType:n}){var c,d,u,m;const v=null===(c=o.value)||void 0===c?void 0:c.rows;if(v){const c=this.insertingFixEnabled||!i?await this.reorderTreeWorkItems(v,a,e.id,i,o.value,t):void 0,h={};for(const t in r)t===g.CoreFieldRefNames.Id?h[t]=e.id:t===g.OobFieldRefNames.StackRank?h[t]=c&&c[0]&&c[0].order?c[0].order:null:t===g.CoreFieldRefNames.Rev?h[t]=e.revision.value:h[t]=e.getFieldValueByName(t);this.commonBacklogContentService.resetOrderColumn();const k=this.pageContext.getService("IVssLocationService").routeUrl("ms.vss-work-web.work-items-form-route",{id:e.id.toString(),project:null!==(u=null===(d=(0,l.getTFSProject)(this.pageContext))||void 0===d?void 0:d.name)&&void 0!==u?u:""}),p=await this.commonBacklogContentService.createNewTreeItem(e.id,r,h,n,k,s.data.value.order);null===(m=o.value)||void 0===m||m.itemProvider.splice(i,[s],[{items:[p],insertAfter:s}]),(null==i?void 0:i.childItems)&&(i.data.children=i.childItems.map((e=>e.data))),this.updateBacklogTreeRowsAdd(p,i),1===this.commonBacklogContentService.getDisplayState().value&&this.commonBacklogContentService.setDisplayState(2),this.updateFilter()}}async getBacklogLevels(){return this.backlogLevels||(this.backlogLevels=await this.commonBacklogContentService.getAllBacklogLevels()),this.backlogLevels}updateWorkItemsRevision(e,t){if(!e||0===e.length||!t||0===t.length)return;t.filter((t=>e.some((e=>e.id===t.id)))).forEach((e=>{e.revision.value++}))}async reorderBacklogWorkItems(e,t,o,i,a,r){var l,s,n,c;const d=(0,m.getWorkClient)(this.pageContext),u=this.pageContext.getService("ITfsPageService").getData();if(r){const n=i&&i.id>0?i.id:0;return await d.reorderIterationWorkItems({ids:e,iterationPath:a||"",nextId:o||0,previousId:t||0,parentId:n},{projectId:null!==(s=null===(l=null==u?void 0:u.project)||void 0===l?void 0:l.id)&&void 0!==s?s:"",teamId:this.commonBacklogContentService.getCurrentTeam().id},r||"")}return await d.reorderBacklogWorkItems({ids:e,iterationPath:a||"",nextId:o||0,previousId:t||0,parentId:(null==i?void 0:i.id)||0},{projectId:null!==(c=null===(n=null==u?void 0:u.project)||void 0===n?void 0:n.id)&&void 0!==c?c:"",teamId:this.commonBacklogContentService.getCurrentTeam().id})}async reorderTreeWorkItems(e,t,o,i,a,r){var l,s,n,c,d,u,m,g,v,h,k,p;if(!this.insertingFixEnabled){let i;if(t===A.AddWorkItemLocations.Top){const t=null===(s=null===(l=e[0])||void 0===l?void 0:l.data)||void 0===s?void 0:s.id;t&&(i=await this.reorderBacklogWorkItems([o],null,t))}else if(t===A.AddWorkItemLocations.Selection){const t=this.commonBacklogContentService.getTreeSelection(),a=(null===(n=null==t?void 0:t.value[0])||void 0===n?void 0:n.endIndex)-1;if(a>=0){const t=null!==(u=null===(d=null===(c=e[a-1])||void 0===c?void 0:c.data)||void 0===d?void 0:d.id)&&void 0!==u?u:null,r=null===(g=null===(m=e[a])||void 0===m?void 0:m.data)||void 0===g?void 0:g.id;i=await this.reorderBacklogWorkItems([o],t,r)}}return i}let I;if(t===A.AddWorkItemLocations.Top){let t=null===(h=null===(v=e[0])||void 0===v?void 0:v.data)||void 0===h?void 0:h.id;if(!t)return I;if(!i&&t<0){const o=await this.getBacklogLevels();t=this.getNextFirstSuitableItemId(e,o,0)}else i&&(t=(null===(k=i.data.children[0])||void 0===k?void 0:k.id)||0);I=await this.reorderBacklogWorkItems([o],null,t)}else if(t===A.AddWorkItemLocations.Selection)if(i&&a){if(!r){const e=0,t=(null===(p=i.data.children[0])||void 0===p?void 0:p.id)||0;return 0===t?I:await this.reorderBacklogWorkItems([o],e,t,i.data)}const e=r.data.id,t=i.data.children.findIndex((t=>t.id===e));if(t>=0){const e=i.data.children[t].id>0?i.data.children[t].id:null,a=i.data.children[t+1],r=a&&a.id>0?a.id:null;I=await this.reorderBacklogWorkItems([o],e,r,i.data)}}else{const t=e.findIndex((e=>e.data.id===(null==r?void 0:r.data.id)));if(t>=0){const i=e[t],a=i.data.id>0?i.data.id:null,r=e[t+1],l=(null==r?void 0:r.data.id)>0?r.data.id:null;I=await this.reorderBacklogWorkItems([o],a,l)}}return I}getCurrentBacklogLevel(e){const t=this.commonBacklogContentService.getBacklogLevelId();return e.find((e=>e.id===t||e.name===t))}getWorkItemBacklogLevel(e,t){var o,i;let a,r;if("underlyingItem"in e?(a=null===(o=e.underlyingItem.data.value.workItemTypeColorAndIcon)||void 0===o?void 0:o.workItemTypeName,r=e.underlyingItem.data.value.backlogLevel):(a=null===(i=e.value.workItemTypeColorAndIcon)||void 0===i?void 0:i.workItemTypeName,r=e.value.backlogLevel),a||r)return t.find((e=>r?e.name===r:e.workItemTypes.some((e=>e.name===a))))}getNextFirstSuitableItemId(e,t,o){const i=this.getCurrentBacklogLevel(t);if(i)for(let t=o+1;t<e.length;t++)if(i.workItemTypes.some((o=>{var i;return(null===(i=e[t].data.value.workItemTypeColorAndIcon)||void 0===i?void 0:i.workItemTypeName)===o.name})))return e[t].data.id;return e[o].data.id}doFindAppropriateChild(e,t,o){var i;const a=this.getWorkItemBacklogLevel(o.data,e);if(a)return o.data.id>0&&a.rank-t.rank==1||a.rank<=t.rank?o:(null===(i=o.childItems)||void 0===i?void 0:i[0])?this.doFindAppropriateChild(e,t,o.childItems[0]):void 0}findInsertPlaceAmongNextNeighbours(e,t,o,i){for(let a=e.findIndex((e=>e.data.id===i.data.id))+1;a<e.length;a++){const i=this.doFindAppropriateChild(t,o,e[a]);if(i)return i}}findAppropriateChild(e,t,o,i){var a;if(e){const r=this.doFindAppropriateChild(t,o,i.underlyingItem);if(r)return r;if(null===(a=i.parentItem)||void 0===a?void 0:a.underlyingItem.childItems){const e=this.findInsertPlaceAmongNextNeighbours(i.parentItem.underlyingItem.childItems,t,o,i.underlyingItem);if(e)return e}return this.findInsertPlaceAmongNextNeighbours(e,t,o,this.findRoot(i).underlyingItem)}}updateFilter(){this.filterManager.dataUpdated();const e=this.commonBacklogContentService.getFilter();e.setState(e.getState())}updateBacklogTreeRowsAdd(e,t){const o=this.commonBacklogContentService.getBacklogTree().value;o.allRows[e.data.id]=e.data,this.commonBacklogContentService.addRowToIdsMap(e.data),o.rows=o.itemProvider.roots,t&&(o.allRows[t.data.id]=t.data)}updateIsValid(e,t){var o;const i=this.commonBacklogContentService.getBacklogTree();if(i.value){const a=null===(o=i.value.itemProvider.value.find((t=>t.underlyingItem.data.id===e.id)))||void 0===o?void 0:o.underlyingItem.data.value;a&&(a.isValid=t)}this.commonBacklogContentService.updateWorkItemRow(e.id,e)}setReorderedWorkItemIds(e,t){e.forEach((e=>{this.reorderedWorkItemIds[e]=t}))}async updateWorkItemsByIdIfWereReordered(e){const t=e.filter((e=>this.reorderedWorkItemIds[e]));if(!t.length)return;const o=await this.getWorkItemFromModelService(t,!0);await this.saveWorkItems(o),this.setReorderedWorkItemIds(t,!1)}}a.Services.add("IBacklogWorkItemService",{serviceFactory:o})}(),function(e){t.IBacklogsHubContentService={};const r="Agile/BacklogsHub";class l extends a.VssService{constructor(){super(...arguments),this.forecastSettings=new i.ObservableValue(void 0),this.isRequirementsBacklog=new i.ObservableValue(!1),this.isRootBacklog=new i.ObservableValue(!1),this.isReorderDisabled=!1,this.getBacklogLevel=()=>this.backlogLevel,this.getColumnPreferences=()=>this.columnPreferences,this.getFilterKey=()=>(0,o.format)("Backlogs/backlog/{0}/Filter",this.backlogLevel.value),this.getForecastSettings=()=>this.forecastSettings,this.getIsRequirementBacklog=()=>this.isRequirementsBacklog.value,this.getIsRootBacklog=()=>this.isRootBacklog.value,this.getZeroDataPrimaryText=()=>x.BacklogsZeroDataPrimaryText,this.getZeroDataSecondaryText=()=>x.BacklogsZeroDataSecondaryText,this.settingsServiceGetColumns=async()=>this.commonBacklogContentService.settingsServiceGetColumns(A.BacklogColumnSettings.ColumnsOptions),this.settingsServiceSetColumns=async e=>this.commonBacklogContentService.settingsServiceSetColumns(A.BacklogColumnSettings.ColumnsOptionsKey,e),this.settingsServiceResizeColumn=async(e,t)=>this.commonBacklogContentService.settingsServiceResizeColumn(A.BacklogColumnSettings.ColumnsOptions,e,t),this.updateBacklogLevel=async()=>{const e=this.commonBacklogContentService.getCurrentTeam().id,t=this.pageContext.getService("ISettingsService"),o=(await t.getEntriesAsync(`${A.BacklogColumnSettings.BacklogsHubKey}/${A.BacklogColumnSettings.BacklogId}`,0,A.BacklogColumnSettings.TeamScope,e))[e];if(o&&this.backlogLevel.value!==o){const e=this.pageContext.getService("IVssHistoryService"),t=e.getState();t.backlogLevel=o,e.pushState(t),this.backlogLevel.value=o}},this.updateForecastEffortData=e=>{var t;(null===(t=this.forecastSettings)||void 0===t?void 0:t.value)&&(this.forecastSettings.value.effortData=e)},this.updateForecastVelocityAndLines=e=>{var t;(null===(t=this.forecastSettings)||void 0===t?void 0:t.value)&&this.forecastSettings.value.effortData&&(this.forecastSettings.value.velocity.value!==e&&(this.forecastSettings.value.velocity.value=e,this.settingsServiceSetVelocity()),this.updateForecastLines())},this.getBacklogContents=async e=>{var t,o,a,r,l,s,n,c,d,u,m,g,v,h,k,p,I;const f=this.pageContext.getService("IVssContributionService"),C=await f.getDataAsync("ms.vss-work-web.new-backlogs-hub-backlog-data-provider",{},null==e?void 0:e.ignoreCache);if((0,D.isExceptionInfoResult)(C))return C;{if(this.isRequirementsBacklog.value=!!(null===(t=null==C?void 0:C.backlogPayload)||void 0===t?void 0:t.isRequirementBacklog),this.isRootBacklog.value=!!(null===(o=null==C?void 0:C.backlogPayload)||void 0===o?void 0:o.isRootBacklog),this.columnPreferences=null!==(a=null==C?void 0:C.backlogPayload.columnPreferences)&&void 0!==a?a:[],null==C?void 0:C.backlogPayload.forecastSettings){const e=Object.assign(Object.assign({},C.backlogPayload.forecastSettings),{velocity:new i.ObservableValue(C.backlogPayload.forecastSettings.velocity)});this.forecastSettings.value=e,await this.settingsServiceGetVelocity()}else C&&!C.backlogPayload.forecastSettings&&(null===(r=this.forecastSettings)||void 0===r?void 0:r.value)&&(this.forecastSettings.value=void 0);let e=null!==(n=null!==(l=null==C?void 0:C.activeWorkItemTypes)&&void 0!==l?l:null===(s=null==C?void 0:C.backlogPayload)||void 0===s?void 0:s.backlogContextWorkItemTypeNames)&&void 0!==n?n:[];return this.ignoreActiveWorkItemTypesInBacklogsHubContentService()&&(e=null!==(d=null===(c=null==C?void 0:C.backlogPayload)||void 0===c?void 0:c.backlogContextWorkItemTypeNames)&&void 0!==d?d:[]),{backlogLevelId:null!==(g=null===(m=null===(u=null==C?void 0:C.backlogPayload)||void 0===u?void 0:u.cumulativeFlowDiagramSettings)||void 0===m?void 0:m.backlogLevelId)&&void 0!==g?g:"",backlogQueryResults:null===(v=null==C?void 0:C.backlogPayload)||void 0===v?void 0:v.queryResults,backlogWiql:null!==(p=null===(k=null===(h=null==C?void 0:C.backlogPayload)||void 0===h?void 0:h.queryResults)||void 0===k?void 0:k.wiql)&&void 0!==p?p:"",backlogWorkItemTypeNames:e,initialBacklogFilterJson:null!==(I=null==C?void 0:C.initialBacklogFilterJson)&&void 0!==I?I:"",columnPreferences:this.columnPreferences}}},this.ignoreActiveWorkItemTypesInBacklogsHubContentService=()=>(0,w.isFeatureFlagEnabled)(this.pageContext,T.FeatureFlags.IgnoreActiveWorkItemTypesInBacklogsHubContentService,!1),this.getWorkItemIdsForForecasting=e=>{var t,o,i;const a=this.commonBacklogContentService.getBacklogTree(),r=null===(t=a.value)||void 0===t?void 0:t.rows.map((e=>Number(e.data.id)));if(r&&r.length>0){const t=new Set;for(const o of r)e.hasOwnProperty(o)&&t.add(o);for(const e of r)if(t.has(e)){const r=null===(i=null===(o=a.value)||void 0===o?void 0:o.allRows[e])||void 0===i?void 0:i.children;if(!r)continue;for(const o of r)if(t.has(o.id)){t.delete(e);break}}return r.filter((e=>t.has(e)))}return[]},this.resetForecastSettings=()=>{this.commonBacklogContentService.clearErrorMessage(),this.forecastSettings.value=void 0,this.resetIterations()},this.updateForecastLines=()=>{var e,t;this.resetIterations();const o=null===(e=this.pageContext.getService("ITeamSettingsService").getTeamSettingsObservable().value)||void 0===e?void 0:e.futureIterations,i=null==o?void 0:o.length;let a;const r={},l=this.forecastSettings.value.effortData;for(let e=0,t=l.ids.length;e<t;e++)r[l.ids[e]]=l.efforts[e];const s=this.getWorkItemIdsForForecasting(r);0===i||void 0===i?a=x.Forecast_NoSprints:0===s.length&&(a=x.Forecast_NoBacklog);let n=this.forecastSettings.value.velocity.value,c=0,d=0,u=0,m=0,g=0;for(;c<i&&u<s.length;)if(r.hasOwnProperty(s[u]))if(d=r[s[u]]||0,d+g<=n)g+=d,m=s[u],u+=1;else{const e=null===(t=this.commonBacklogContentService.getBacklogTree().value)||void 0===t?void 0:t.allRows[s[u-1]];e&&(e.iteration=o[c].name,e.value=e.value),m=0,n=n-g+this.forecastSettings.value.velocity.value,c+=1,g=0}else u+=1;a||0!==u||(a=x.Forecast_ItemTooBig),c<i&&g<=n&&m&&(c+=1),a?this.commonBacklogContentService.showErrorMessage(a):this.commonBacklogContentService.clearErrorMessage()},this.resetIterations=()=>{var e,t;Object.entries(null!==(t=null===(e=this.commonBacklogContentService.getBacklogTree().value)||void 0===e?void 0:e.allRows)&&void 0!==t?t:{}).forEach((([e,t])=>{t.iteration&&(t.iteration=void 0,t.value=t.value)}))},this.settingsServiceGetVelocity=async()=>{var e;const t=this.pageContext.getService("ISettingsService"),o=(await t.getEntriesAsync(r,0,A.BacklogColumnSettings.TeamScope,this.commonBacklogContentService.getCurrentTeam().id)).SprintForecastVelocity;o&&(null===(e=this.forecastSettings)||void 0===e?void 0:e.value)&&(this.forecastSettings.value.velocity.value=o)},this.settingsServiceSetVelocity=async()=>{const e=this.pageContext.getService("ISettingsService");await e.setEntries({"Agile/BacklogsHub/SprintForecastVelocity":this.forecastSettings.value.velocity.value},0,A.BacklogColumnSettings.TeamScope,this.commonBacklogContentService.getCurrentTeam().id)},this.refreshTree=async e=>{this.pageContext.getService("IBacklogWorkItemService").clearCache();const t=this.pageContext.getService("ISettingsService"),o=this.commonBacklogContentService.getCurrentTeam().id,i=`${A.BacklogColumnSettings.BacklogsHubKey}/${A.BacklogColumnSettings.BacklogId}`;await t.setEntries({[i]:this.backlogLevel.value},0,A.BacklogColumnSettings.TeamScope,o),this.commonBacklogContentService.refreshTree({getData:()=>this.getBacklogContents({ignoreCache:!0}),keepOpen:null==e?void 0:e.keepOpen,filterManager:null==e?void 0:e.filterManager})}}_serviceStart(e){super._serviceStart(e);const t=this.pageContext.getService("IVssHistoryService").getState().backlogLevel;this.backlogLevel=new i.ObservableValue(t),this.commonBacklogContentService=this.pageContext.getService("ICommonBacklogContentService"),this.commonBacklogContentService.setHubType("Backlogs"),this.backlogLevel.subscribe((()=>this.refreshTree()))}_serviceEnd(e){super._serviceEnd(e),this.backlogLevel.unsubscribe((()=>this.refreshTree()))}onIterationChange(){}}a.Services.add("IBacklogsHubContentService",{serviceFactory:l})}(),function(e){t.ISprintsHubContentService={};var i;!function(e){e.IterationKey="Iteration",e.NavigationKey="Agile/SprintsHub/Navigation",e.ProjectKey="Project",e.SprintsFilterKey="Sprints/backlog/Filter"}(i||(i={}));class s extends a.VssService{constructor(){super(...arguments),this.isReorderDisabled=!1,this.workItemsBlockingReorder=[],this.missingWorkItems=[],this.getBacklogContents=async e=>{var t,o,i,a,r;const l=this.pageContext.getService("IVssContributionService"),s=await l.getDataAsync("ms.vss-work-web.sprints-hub-backlog-data-provider",{},null==e?void 0:e.ignoreCache);return(0,D.isExceptionInfoResult)(s)?s:{backlogQueryResults:null==s?void 0:s.backlogQueryResults,backlogLevelId:null!==(t=null==s?void 0:s.backlogContext.levelName)&&void 0!==t?t:"",backlogWiql:null!==(o=null==s?void 0:s.backlogQueryResults.wiql)&&void 0!==o?o:"",backlogWorkItemTypeNames:null!==(i=null==s?void 0:s.activeWorkItemTypes)&&void 0!==i?i:[],initialBacklogFilterJson:null!==(a=null==s?void 0:s.initialBacklogFilterJson)&&void 0!==a?a:"",columnPreferences:null!==(r=null==s?void 0:s.columnPreferences)&&void 0!==r?r:[]}},this.getFilterKey=()=>i.SprintsFilterKey,this.getZeroDataPrimaryText=()=>x.SprintsZeroDataPrimaryText,this.getZeroDataSecondaryText=()=>r.createElement("div",null,r.createElement(N.Link,{className:"flex-center",href:this.getBacklogUrl()},x.SprintsZeroDataScheduleLink),r.createElement("span",null,x.SprintsZeroDataSecondaryText)),this.getCurrentIteration=()=>this.currentIteration,this.onIterationChange=e=>{e=e.filter((e=>{var t,o;const i=e.underlyingItem.data.value.coreColumnMap[g.CoreFieldRefNames.IterationId]!==(null===(t=this.currentIteration)||void 0===t?void 0:t.id),a=e.underlyingItem.data.children,r=null===(o=e.underlyingItem.data.children)||void 0===o?void 0:o.map((e=>e.value.coreColumnMap[g.CoreFieldRefNames.IterationId])),l=null==r?void 0:r.find((e=>{var t;return e===(null===(t=this.currentIteration)||void 0===t?void 0:t.id)}));return i&&(!a||!l)}));const t=this.pageContext.getService("IBacklogWorkItemService");t.updateBacklogTreeRowsDelete(e),t.getFilterManager().dataUpdated(),this.commonBacklogContentService.resetOrderColumn()},this.refreshTree=async e=>{var t,o,a,r;this.commonBacklogContentService.getAllIdsToRowsMap().clear();this.pageContext.getService("IBacklogWorkItemService").clearCache(),await this.getIteration();const s=this.pageContext.getService("ISettingsService"),n=null!==(a=null===(o=null===(t=(0,l.getTFSPageData)(this.pageContext))||void 0===t?void 0:t.project)||void 0===o?void 0:o.id)&&void 0!==a?a:"",c=`${i.NavigationKey}/${i.IterationKey}`;await s.setEntries({[c]:null===(r=this.currentIteration)||void 0===r?void 0:r.identifier},0,i.ProjectKey,n),await this.commonBacklogContentService.refreshTree({getData:()=>this.getBacklogContents({ignoreCache:!0}),keepOpen:null==e?void 0:e.keepOpen,filterManager:null==e?void 0:e.filterManager}),this.updateReorderRequirementStatus()},this.settingsServiceGetColumns=async()=>this.commonBacklogContentService.settingsServiceGetColumns(A.SprintsBacklogColumnSettings.ColumnOptions,A.SprintsBacklogColumnSettings.IterationKey),this.settingsServiceSetColumns=async e=>this.commonBacklogContentService.settingsServiceSetColumns(A.SprintsBacklogColumnSettings.ColumnOptionsKey,e,A.SprintsBacklogColumnSettings.IterationKey),this.settingsServiceResizeColumn=async(e,t)=>this.commonBacklogContentService.settingsServiceResizeColumn(A.SprintsBacklogColumnSettings.ColumnOptions,e,t,A.SprintsBacklogColumnSettings.IterationKey),this.getBacklogUrl=()=>{var e,t;const o={};return o.team=this.commonBacklogContentService.getCurrentTeam().name,o.project=(null===(t=null===(e=(0,l.getTFSPageData)(this.pageContext))||void 0===e?void 0:e.project)||void 0===t?void 0:t.name)||"",(0,P.routeUrl)(this.pageContext,"ms.vss-work-web.new-backlogs-route",o)},this.getIteration=async()=>{var e,t;const o=this.pageContext.getService("IWorkItemNodeService"),i=await o.getIterationNodes(null!==(t=null===(e=(0,l.getTFSProject)(this.pageContext))||void 0===e?void 0:e.id)&&void 0!==t?t:""),a=this.pageContext.getService("IVssHistoryService").getState().iteration;i&&(this.allIterationNodes=n(i),this.currentIteration=this.allIterationNodes.find((e=>e.name===a.slice(a.lastIndexOf("/")+1))))},this._isParentRequirement=(e,t)=>t.requirementBacklog.workItemTypes.some((t=>(0,o.equals)(t,e,!0))),this._isParentTask=(e,t)=>t.taskBacklog.workItemTypes.some((t=>(0,o.equals)(t,e,!0)))}async _serviceStart(e){super._serviceStart(e),this.commonBacklogContentService=this.pageContext.getService("ICommonBacklogContentService"),this.commonBacklogContentService.setHubType("Sprints"),await this.getIteration()}_serviceEnd(e){super._serviceEnd(e)}async updateReorderRequirementStatus(){var e;this.missingWorkItems=[],this.isReorderDisabled=!1,this.workItemsBlockingReorder=[];const t=await this.commonBacklogContentService.getBacklogConfiguration();if(!t)return;const i=this.commonBacklogContentService.getAllIdsToRowsMap();this.isReorderDisabled=!1;const a=await this.getParentsMapping(i,t);for(const[o,r]of i.entries())if(o>0){const l=Number(null!==(e=r.value.coreColumnMap[g.CoreFieldRefNames.Parent])&&void 0!==e?e:0),s=null==a?void 0:a.get(l);if(s&&(this._isParentRequirement(s,t)||this._isParentTask(s,t))){const e=this._isWorkItemOfRequirementType(i,t,o);if(e||!e&&i.get(l)&&!this._isWorkItemOfRequirementType(i,t,l)){this.isReorderDisabled=!0,this.workItemsBlockingReorder.push(o);const e=i.has(l);-1!==this.missingWorkItems.indexOf(l)||e||this.missingWorkItems.push(l)}}}if(this.isReorderDisabled){const e=this.workItemsBlockingReorder.join(", "),t=this.missingWorkItems.join(", "),i=t?(0,o.format)(x.SameCategoryHierarchy_FeaturesBlockedWithWorkItems,t):x.SameCategoryHierarchy_FeaturesBlocked,a=()=>r.createElement(r.Fragment,null,r.createElement("span",null,x.SameCategoryHierarchy_BacklogMessage),r.createElement("span",{className:"padding-left-4 font-weight-heavy"},i),r.createElement("span",{className:"padding-left-4"},(0,o.format)(x.SameCategoryHiearchy_ToFix,e)),r.createElement(N.Link,{className:"padding-left-4",href:"https://go.microsoft.com/fwlink/?linkid=2007013",target:"_blank",rel:"noopener noreferrer"},x.LearnMore)),l=(0,y.getBoardsMessagesService)(this.pageContext);l.dismissMessage(),l.showMessage({renderMessage:a,severity:"Warning"})}}async getParentsMapping(e,t){var o,i,a,r;if(!this.parentItems){const s=null!==(i=null===(o=(0,l.getTFSProject)(this.pageContext))||void 0===o?void 0:o.id)&&void 0!==i?i:"",n=null!==(r=null===(a=this.pageContext.getService("ITfsPageService").getHorizontalNavigationTeamData())||void 0===a?void 0:a.id)&&void 0!==r?r:"",c=Array.from(e.keys()).filter((e=>e>=0));if(!c.length)return;const d=(0,m.getWorkClient)(this.pageContext),u=await d.getBoardMappingParentItems({teamId:n,projectId:s},t.requirementBacklog.id,c);this.parentItems=new Map;for(const e of u)this.parentItems.set(e.id,e.workItemTypeName)}return this.parentItems}_isWorkItemOfRequirementType(e,t,i){var a,r;const l=e.get(i),s=null!==(r=null===(a=null==l?void 0:l.value.workItemTypeColorAndIcon)||void 0===a?void 0:a.workItemTypeName)&&void 0!==r?r:"";return t.requirementBacklog.workItemTypes.some((e=>(0,o.equals)(e,s,!0)))}}function n(e){const t=[e];return e.children&&e.children.forEach((e=>{const o=n(e);t.push(...o)})),t}a.Services.add("ISprintsHubContentService",{serviceFactory:s})}()}),["Resources","BacklogContentContants","RollupHelpers","BacklogContentDataProviderTypes","BacklogContentTreeTypes","BacklogWorkItemConfigurationService","IHubContentService","ICommonBacklogContentService","IBacklogWorkItemService","IBacklogsHubContentService","ISprintsHubContentService"]),document.dispatchEvent(new CustomEvent("scriptLoaded",{cancelable:!1,detail:{id:"ms.vss-work-web.common-backlog-content-service-content"}}));