"use strict";define("Wit/Common/WorkItemControls",["require","exports","VSS/Core/Observable","react","VSSUI/Components/Dropdown/Dropdown","VSSUI/Dropdown","VSSUI/EditableDropdown","VSSUI/ListBox","VSSUI/Table","VSSUI/TooltipEx","VSSUI/TreeEx","VSSUI/Util","VSSUI/Utilities/DropdownSelection","Tfs/Platform/Page","VSS/Platform/Layout","VSSUI/DatePicker","VSSUI/Dialog","Wit/Common/DateUtils","VSS/Platform/Util/Storage","VSSUI/Button","VSSUI/Callout","VSSUI/Spinner","VSSUI/SplitButton","VSSUI/TextField","Wit/UI/WorkItemTypeIcon","VSS/Features/Identities/IdentityPickerProvider","VSSUI/IdentityPicker","Wit/Common/Generated/Constants","Wit/Common/WiqlOperators","Wit/Common/WITMeMacroPeoplePickerProvider","Wit/Common/WorkItemFieldService/IWorkItemFieldService","Wit/Identity/Utilities/WorkItemIdentityHelper"],(function(e,t,o,n,a,r,l,i,s,c,d,u,m,v,p,f,I,g,b,y,w,S,h,C,N,T,x,D,k,E,P,O){var V,A,W,F,R,U,j;V=t.Resources={},t.Resources.AddAtSelection="Add at selection",t.Resources.AddToBottom="Add to bottom",t.Resources.AddToTop="Add to top",t.Resources.Cancel="Cancel",t.Resources.ChangeDestination="Change destination",t.Resources.NewWorkItemDropdownAriaLabel="Select new work item type.",t.Resources.Ok="OK",t.Resources.SelectDate="Select Date",t.Resources.SuggestionsHeader="Suggestions",A=t.Constants={},t.Constants.FutureDate=new Date(2533707648e5),function(e){W=t[e]={};t[e].NodeTreeItemProvider=class{constructor(e,t){this.itemCollection=new o.ObservableCollection,this.itemCollection.push(e),this.itemCollection.push(t)}get length(){return this.itemCollection.length}get value(){return this.itemCollection.value}subscribe(e,t){return this.itemCollection.subscribe(e,t)}unsubscribe(e,t){return this.itemCollection.unsubscribe(e,t)}}}("NodeTreeItemProvider"),function(e){F=t.NodeUtils={},t.NodeUtils.convertNodesToListBoxItems=function e(a,r){const l={id:a.identifier,data:a,parent:r,text:n(a.path)},i=[l];if(a.hasChildren){const n=0===a.structureType?o:t.NodeUtils.compareIterations,r=[...a.children].sort(n);for(const t of r)i.push(...e(t,l))}return i};const o=(e,t)=>e.name.localeCompare(t.name);function n(e,t="\\"){if(!e)return"";e.startsWith(t)&&(e=e.substring(1));const o=e.split("\\");return o.splice(1,1),o.join(t)}t.NodeUtils.compareIterations=(e,t)=>{const o=e.attributes&&e.attributes.startDate||A.FutureDate,n=t.attributes&&t.attributes.startDate||A.FutureDate;return o!==n?o.getTime()-n.getTime():e.name.localeCompare(t.name)},t.NodeUtils.normalizePath=n,t.NodeUtils.isEmpty=function(e){return!e||Object.getPrototypeOf(e)===Object.prototype&&0===Object.keys(e).length}}(),function(e){R=t.NodeTreeDropdown={},t.NodeTreeDropdown.NodeTreeDropdown=n.forwardRef(((e,t)=>{const{additionalColumns:s,items:c,mruNodes:d,onSetPath:u,onValueChange:p,selectedText:f}=e,I=__rest(e,["additionalColumns","items","mruNodes","onSetPath","onValueChange","selectedText"]),y=e.additionalColumns?[...v,...e.additionalColumns]:v,[w]=(0,o.useObservableArray)(g(c.value,null==d?void 0:d.value)),S=n.useRef(new W.NodeTreeItemProvider(w,c)),h=n.useRef(new Map),C=n.useRef(new m.DropdownSelection),N=e=>{const t=S.current.value.filter((e=>(0,i.isListBoxItemVisible)(e))).findIndex((t=>!b(t)&&t.text===e));t>-1&&C.current.select(t)},T=()=>{if(!f)return;const e=o.ObservableLike.getValue(f),t=c.value.find((t=>t.text===e));let n=null==t?void 0:t.parent;for(;n;)n.expanded=!0,h.current.set(n.id,!0),n=n.parent;N(e)},x=()=>{w.value=g(c.value,null==d?void 0:d.value);for(const e of c.value){const t=h.current.get(e.id);void 0!==t&&(e.expanded=t)}T()};return n.useEffect((()=>{const e=c.subscribe(x),t=null==d?void 0:d.subscribe(x),n=o.ObservableLike.isObservable(f)&&f.subscribe(T);return()=>{c.unsubscribe(e),d&&t&&d.unsubscribe(t),n&&o.ObservableLike.isObservable(f)&&f.unsubscribe(n)}}),[c,d,f]),n.useEffect(T,[f]),n.createElement(l.EditableDropdown,Object.assign({allowClear:!1,allowTextSelection:!0,className:"node-tree-dropdown",columns:y,filterMatchedItem:e=>(0,a.filterMatchedItemByListboxType)(e)&&!b(e),items:S.current,onToggle:(e,t)=>{if(t.expanded=!t.expanded,h.current.set(t.id,t.expanded),!f)return;const n=o.ObservableLike.getValue(f);N(n)},onValueChange:e=>{if(u)if((0,F.isEmpty)(null==e?void 0:e.data))(null==e?void 0:e.text)?u(null==e?void 0:e.text):u("");else{const t=e.data.path;u((0,F.normalizePath)(t))}p&&p(e)},ref:t,renderCallout:e=>n.createElement(r.DropdownCallout,Object.assign({},e,{containerClassName:"node-tree-dropdown-callout"})),renderExpandable:e=>{const t=Object.assign({autoSelect:!0},e);return n.createElement(r.DropdownExpandableTextField,Object.assign({},t))},selectedText:f,selection:C.current,showTree:!0,minCalloutWidth:400},I))}));const v=[{id:"title",width:new o.ObservableValue(-100),renderCell:function(e,t,o,a){if(3===a.underlyingItem.data.type)return n.createElement(s.SimpleTableCell,{className:(0,u.css)(a.className,o.className),contentClassName:"divider-cell",columnIndex:t,colspan:2,key:a.underlyingItem.id,tableColumn:o},n.createElement("div",{className:"bolt-list-box-divider flex-grow"}));const r=a.underlyingItem,l=(0,F.isEmpty)(r.data.data)||b(r.data)?r.text:r.data.data.name;return n.createElement(d.ExpandableTreeCell,{className:(0,u.css)(a.className,o.className),columnIndex:t,key:`title-cell-${e}-${t}`,treeColumn:o,treeItem:a},n.createElement(c.Tooltip,{overflowOnly:!0},n.createElement("span",{className:"text-ellipsis"},l)))}}];const p={id:"suggestions-header",text:V.SuggestionsHeader,type:2},f={id:"suggestions-divider",type:3},I="mru-items";function g(e,t){if(!(null==t?void 0:t.length)||!e.length)return[];const o=[];for(const n of t){const t=e.find((e=>!(0,F.isEmpty)(null==e?void 0:e.data)&&e.data.id===n)),a=null==t?void 0:t.data;a&&o.push({id:`mru-${n}`,data:a,text:(0,F.normalizePath)(a.path),groupId:I})}return[p,...o,f]}function b(e){return e.groupId===I}}(),U=t.AreaPathDropdown={},t.AreaPathDropdown.AreaPathDropdown=n.forwardRef(((e,t)=>{var a;const{items:r,macros:l,onSetPath:s,onValueChange:c,projectId:d,selectDefaultValue:u}=e,m=__rest(e,["items","macros","onSetPath","onValueChange","projectId","selectDefaultValue"]),{pageContext:f}=(0,p.useComponentContext)(),I=(0,v.getTFSPageData)(f),g=n.useRef([]),b=l&&((0,i.wrapListBoxItems)(l)||l),y=o.ObservableLike.isObservable(r)?r:new o.ObservableArray(null!==(a=r)&&void 0!==a?a:b),[w]=(0,o.useObservableArray)([]),S=n.useRef(new o.ObservableArray(y.value.concat(g.current)));return n.useEffect((()=>{S.current.value=y.value.concat(g.current)}),[y.length]),n.useEffect((()=>{r?u&&y.length&&y.value[0].text&&(null==s||s(y.value[0].text)):(async()=>{var e;const t=null!=d?d:null===(e=null==I?void 0:I.project)||void 0===e?void 0:e.id;if(!r&&t){const e=f.getService("IWorkItemNodeService"),o=await e.getAreaPathNodes(t);o&&(g.current=(0,F.convertNodesToListBoxItems)(o),S.current.value=y.value.concat(g.current),u&&(null==s||s((0,F.normalizePath)(o.path))))}})(),(async()=>{var e;const t=null!=d?d:null===(e=null==I?void 0:I.project)||void 0===e?void 0:e.id;if(t){const e=f.getService("IWorkItemNodeService");w.value=await e.getMruAreaPaths(t)}})()}),[d]),n.createElement(R.NodeTreeDropdown,Object.assign({allowFreeform:!!l,items:r?y:S.current,mruNodes:w,onValueChange:async e=>{var t;c&&c(e),null==s||s((null==e?void 0:e.text)||"");const o=null!=d?d:null===(t=null==I?void 0:I.project)||void 0===t?void 0:t.id;if(!o||(0,F.isEmpty)(null==e?void 0:e.data))return;const n=e.data,a=f.getService("IWorkItemNodeService");w.value=await a.updateMruAreaPaths(o,[n.id])},ref:t},m))})),t.DatePickerDialog={},t.DatePickerDialog.DatePickerDialog=function(e){const[t,o]=(0,n.useState)();return n.createElement(I.Dialog,{titleProps:{text:V.SelectDate},onDismiss:()=>e.onDismiss,footerButtonProps:[{text:V.Cancel,onClick:()=>e.onDismiss()},{text:V.Ok,onClick:()=>e.onDismiss(t),primary:!0}]},n.createElement("div",{className:"scroll-auto flex-grow flex-row"},n.createElement(f.DatePicker,{containerClassName:"full-width",onChange:e=>{o(e)},value:t})))},function(e){j=t.IterationDropdown={},t.IterationDropdown.IterationDropdown=n.forwardRef(((e,t)=>{var r;const{items:l,macros:s,onValueChange:c,projectId:d}=e,u=__rest(e,["items","macros","onValueChange","projectId"]),{pageContext:m}=(0,p.useComponentContext)(),f=(0,v.getTFSPageData)(m),I=n.useRef([]),g=s&&((0,i.wrapListBoxItems)(s)||s),b=o.ObservableLike.isObservable(l)?l:new o.ObservableArray(null!==(r=l)&&void 0!==r?r:g),[y]=(0,o.useObservableArray)([]),w=n.useRef(new o.ObservableArray(b.value.concat(I.current)));return n.useEffect((()=>{w.current.value=b.value.concat(I.current)}),[b.length]),n.useEffect((()=>{l||(async()=>{var e;const t=null!=d?d:null===(e=null==f?void 0:f.project)||void 0===e?void 0:e.id;if(!l&&t){const e=m.getService("IWorkItemNodeService"),o=await e.getIterationNodes(t);o&&(I.current=(0,F.convertNodesToListBoxItems)(o),w.current.value=b.value.concat(I.current))}})(),(async()=>{var e;const t=null!=d?d:null===(e=null==f?void 0:f.project)||void 0===e?void 0:e.id;if(t){const e=m.getService("IWorkItemNodeService");y.value=await e.getMruIterations(t)}})()}),[d]),n.createElement(R.NodeTreeDropdown,Object.assign({allowFreeform:!!s,additionalColumns:a,items:l?b:w.current,mruNodes:y,onValueChange:async e=>{var t;c&&c(e);const o=null!=d?d:null===(t=null==f?void 0:f.project)||void 0===t?void 0:t.id;if(!o||(0,F.isEmpty)(null==e?void 0:e.data))return;const n=e.data,a=m.getService("IWorkItemNodeService");y.value=await a.updateMruIterations(o,[n.id])},ref:t},u))}));const a=[{id:"iteration-dates",width:new o.ObservableValue(-50),renderCell:function(e,t,o,a){var l;const i=null===(l=a.underlyingItem.data.data)||void 0===l?void 0:l.attributes,d=`iteration-dates-cell-${e}-${t}`;let m=null;if(i){const e=i.startDate,t=i.finishDate;if(e&&t){const o=`${r.format((0,g.getDateInUTC)(e))} - ${r.format((0,g.getDateInUTC)(t))}`;m=n.createElement(c.Tooltip,{overflowOnly:!0},n.createElement("span",{className:"text-ellipsis"},o))}}return n.createElement(s.SimpleTableCell,{className:(0,u.css)(o.className,a.className),columnIndex:t,contentClassName:"justify-end",key:d,tableColumn:o},m)}}],r=new Intl.DateTimeFormat(void 0,{year:"numeric",month:"numeric",day:"numeric"})}(),function(e){t.NewItemCallout={};const a="backlogStackRankDirection";function l(e){const{colorAndIcons:t,selectedType:o}=e,a=__rest(e,["colorAndIcons","selectedType"]),l=t.map((e=>({iconProps:{render:()=>n.createElement(N.WorkItemTypeIcon,{className:"margin-horizontal-8",data:e,suppressTooltip:!0})},id:e.workItemTypeName,text:e.workItemTypeName}))),i=new m.DropdownSelection,s=l.findIndex((e=>e.text===o.value));return s>-1&&i.select(s),n.createElement(r.Dropdown,Object.assign({ariaLabel:V.NewWorkItemDropdownAriaLabel,items:l,selection:i},a))}t.NewItemCallout.NewItemCallout=function({allowedPositions:e,anchor:t,colorAndIcons:r,getLocalStorageKeyForWorkItemType:i,getBacklogDefaultWorkItemTypeNameFetcher:s,onAddItem:c,onDismiss:d,keepOpenAfterAddingItem:u}){if(0===r.length)return null;const[m]=(0,o.useObservable)("");let v=(0,b.tryGetLocalStorageValue)(a);(null==e?void 0:e.length)&&!e.some((e=>e===v))&&(v=e[0]);const p=e=>{g(e.id),(0,b.trySetLocalStorageValue)(a,e.id)},f=n.useMemo((()=>{const t=[];return e&&!e.some((e=>"top"===e))||t.push({id:"top",text:V.AddToTop,onActivate:p}),e&&!e.some((e=>"bottom"===e))||t.push({id:"bottom",text:V.AddToBottom,onActivate:p}),e&&!e.some((e=>"selection"===e))||t.push({id:"selection",text:V.AddAtSelection,onActivate:p}),t}),[e]),[I,g]=n.useState((()=>v||"top")),T=i?i():"new-item-callout-witType",x=(0,b.tryGetLocalStorageValue)(T),D=r.find((e=>e.workItemTypeName===x)),[k,E]=n.useState();n.useEffect((()=>{var e;if(D)E(D.workItemTypeName);else if(s){const{teamId:t,backlog:o}=null!==(e=s.context)&&void 0!==e?e:{};s.service.getBacklogDefaultWorkItemTypeName(t,o).then((e=>{E(r.find((t=>t.workItemTypeName===e))&&e||r[0].workItemTypeName)})).catch((()=>{E(r[0].workItemTypeName)}))}else E(r[0].workItemTypeName)}),[]);const P=e=>n.createElement(w.Callout,{anchorElement:t,anchorOrigin:{horizontal:"end",vertical:"end"},className:"new-item-callout",contentClassName:"flex-row flex-center padding-8 subtle-border depth-8",escDismiss:!0,focuszoneProps:{circularNavigation:!0,defaultActiveElement:".new-item-name-textbox",direction:1,focusOnMount:!0,handleTabKey:!0},lightDismiss:!0,onDismiss:d},e);if(!k)return P(n.createElement(S.Spinner,{size:"small"}));const O=new o.ObservableValue(k),A=()=>{null==c||c(m.value,O.value,I),u||d(),m.value=""},W={text:"top"===I?V.AddToTop:"bottom"===I?V.AddToBottom:V.AddAtSelection,onClick:A};return P(n.createElement(n.Fragment,null,1===r.length?n.createElement(N.WorkItemTypeIcon,{className:"margin-right-8",data:r[0],size:1}):n.createElement(l,{className:"margin-right-8",colorAndIcons:r,onSelect:(e,t)=>{O.value=t.text,(0,b.trySetLocalStorageValue)(T,t.text)},selectedType:O,width:150}),n.createElement(C.TextField,{autoFocus:!0,className:"new-item-name-textbox margin-right-8",value:m,onChange:(e,t)=>m.value=t,onKeyPress:e=>"Enter"===e.key&&A()}),f.length>1?n.createElement(h.SplitButton,{primary:!0,buttonProps:W,menuButtonProps:{ariaLabel:V.ChangeDestination,contextualMenuProps:{menuProps:{id:"directionMenu",items:f}}}}):n.createElement(y.Button,Object.assign({primary:!0},W))))},t.NewItemCallout.WorkItemDropdown=l}(),function(e){t[e]={};t[e].WorkItemFieldControl=e=>{const{className:t,disabled:o,fieldName:l,includeIterationMacros:i,initialValue:c,onChange:d}=e,u=(0,p.usePageContext)(),m=(0,P.getWorkItemFieldService)(u),[v,f]=n.useState(!1),[I,g]=n.useState((()=>{var t,o;let n=null!==(t=e.fieldEntry)&&void 0!==t?t:null===(o=e.field)||void 0===o?void 0:o.fieldDefinition;return!n&&l&&(n=m.getFieldByReferenceName(l)),n}));if(n.useEffect((()=>{if(!I&&l){(async()=>{f(!0),await m.getFieldsAsync();const e=m.getFieldByReferenceName(l);g(e),f(!1)})()}})),n.useEffect((()=>{e.fieldEntry&&g(e.fieldEntry)}),[e.fieldEntry]),v)return n.createElement(S.Spinner,null);const b=Object.assign(Object.assign({},e),{fieldEntry:I});return(null==I?void 0:I.isIdentity)?n.createElement(a,Object.assign({},b)):(null==I?void 0:I.type)===D.FieldType.DateTime?n.createElement(r,Object.assign({},b)):(null==I?void 0:I.referenceName)===D.CoreFieldRefNames.AreaPath?n.createElement(U.AreaPathDropdown,{className:t,disabled:o,onSetPath:e=>{d&&d(e,e!==c)},selectedText:null==c?void 0:c.toString()}):(null==I?void 0:I.referenceName)===D.CoreFieldRefNames.IterationPath?n.createElement(j.IterationDropdown,{className:t,disabled:o,macros:i?k.IterationPathMacros:void 0,onSetPath:e=>{d&&d(e,e!==c)},selectedText:null==c?void 0:c.toString()}):n.createElement(s,Object.assign({},b))};const a=({className:e,disabled:t,field:a,initialValue:r,onChange:l,useMacroMePickerProvider:i})=>{var s,c;const{pageContext:d}=(0,p.useComponentContext)(),u=function(e,t){if(!t)return;"string"==typeof t&&(t=(0,O.convertWorkItemIdentityRefFromFieldValue)(e,t));return(0,O.isWorkItemIdentityRef)(t)?(0,O.convertWorkItemIdentityRefToIIdentity)(e,t):(0,O.isIdentityRef)(t)?(0,O.convertIdentityRefToIIdentity)(e,t):void 0}(d,r),[m]=(0,o.useObservable)(u),v=n.useRef(new T.PeoplePickerProvider(d,{identityTypes:(null===(s=null==a?void 0:a.filterByScope)||void 0===s?void 0:s.excludeGroups)?["user"]:["user","group"]})),f=n.useRef(new E.WITMeMacroPeoplePickerProvider(d,{identityTypes:(null===(c=null==a?void 0:a.filterByScope)||void 0===c?void 0:c.excludeGroups)?["user"]:["user","group"]}));return n.createElement(x.IdentityPickerDropdown,{className:e,disabled:t,onChange:e=>{if(m.value=e,l){const t=e&&(0,O.convertIIdentityToWorkItemIdentityRef)(d,e),o=u&&(0,O.convertIIdentityToWorkItemIdentityRef)(d,u);l(t,(null==t?void 0:t.distinctDisplayName)!==(null==o?void 0:o.distinctDisplayName))}},pickerProvider:i?f.current:v.current,value:m})};const r=({className:e,datePickerExpandOnMount:t,datePickerOnCollapse:a,disabled:r,initialValue:l,onChange:i})=>{const s=l instanceof Date?(0,g.getDateInUserTimeZone)(l):void 0,[c]=(0,o.useObservable)(s);return n.createElement(f.DatePicker,{className:e,disabled:r,expandOnMount:t,showClear:!0,value:c,onChange:e=>{const t=(0,g.getDateInClientTimeZone)(e);c.value=t,i&&i(t,(null==t?void 0:t.getTime())!==(null==s?void 0:s.getTime()))},onCollapse:a})},s=({allowFreeform:e,allowedValues:t,autoSelect:a,className:r,disabled:s,fieldEntry:c,inputType:d,initialValue:u,onChange:m})=>{var v;const[p]=(0,o.useObservableArray)(null!==(v=(0,i.wrapListBoxItems)(null!=t?t:[]))&&void 0!==v?v:[]),f=null==u?void 0:u.toString(),[I]=(0,o.useObservable)(f);if(n.useEffect((()=>{var e;p.value=null!==(e=(0,i.wrapListBoxItems)(null!=t?t:[]))&&void 0!==e?e:[]})),t&&t.length>0)return n.createElement(l.EditableDropdown,{allowFreeform:null==e||e,allowTextSelection:!0,autoSelect:null!=a&&a,className:r,disabled:s,items:p,onValueChange:e=>{e&&(I.value=e.text,m&&m(e.text,e.text!==f))},selectedText:f,minCalloutWidth:180});{const e=d||((null==c?void 0:c.type)===D.FieldType.Double||(null==c?void 0:c.type)===D.FieldType.Integer?"number":"text");return n.createElement(C.TextField,{autoSelect:null!=a&&a,containerClassName:r,className:r,disabled:s,inputType:e,value:I,onChange:(e,t)=>{I.value=t,m&&m(t,t!==f)}})}}}("WorkItemFieldControl")}),["Resources","Constants","NodeTreeItemProvider","NodeUtils","NodeTreeDropdown","AreaPathDropdown","DatePickerDialog","IterationDropdown","NewItemCallout","WorkItemFieldControl"]),document.dispatchEvent(new CustomEvent("scriptLoaded",{cancelable:!1,detail:{id:"ms.vss-work-web.work-item-controls"}}));