"use strict";define("Analytics/Shared/Common",["require","exports","VSS/Core/Util/String","Analytics/Shared/Utils/URLHelper","VSS/Core/Observable","VSS/Platform/Context","VSS/Platform/FPS","Analytics/Common/Utilities/QueryUtilities","Analytics/Shared/Utils/DateSKParser","Analytics/Shared/Utils/DateUtils","Analytics/Shared/Utils/Number","Analytics/Common/Utilities/AnalyticsExceptionUtilities","Analytics/Shared/Visuals/Common/Components/AnalyticsUnavailableMessage","react","VSS/Platform/Layout","VSSUI/Spinner","VSS/Platform/Location","VSSUI/Header","VSSUI/HeaderCommandBar","VSSUI/Page","VSSUI/Surface"],(function(e,i,t,n,s,a,l,r,o,u,c,p,d,P,y,m,D,h,S,g,E){var R,T,b,A,C,v,f,B,V,w;R=i.Resources={},i.Resources.NoOfDaysFormatString="{0} Days",i.Resources.SevenNumberText="7",i.Resources.FourteenNumberText="14",i.Resources.ThirtyDays="30",i.Resources.OneEightyDays="180",i.Resources.AnalyticsNotEnabledMessage="Analytics needs to be enabled to use this feature.",i.Resources.AnalyticsNotEnabledSuggestion="Analytics can be enabled in project collection settings.",i.Resources.AnalyticsSettings="View Analytics Settings",i.Resources.AnalyticsNotEnabledAriaDescription="Analytics is not enabled. Analytics needs to be enabled to use this feature. Enable Analytics here.",i.Resources.AnalyticsText="Analytics",i.Resources.AnalyticsDataNotReadyMessage="Preparing your data",i.Resources.AnalyticsDataNotReadySuggestion="This typically takes few minutes, but can take longer depending on the amount of data in your organization.<br>Please check after some time.",i.Resources.AnalyticsErrorMessage="Yikes! We hit an error while trying to load this page...",i.Constants={},i.Constants.emsServiceInstanceId="00000028-0000-8888-8000-000000000000",i.Constants.gridLineColor="rgba(0,0,0,0.1)",T=i.Types={},(V=i.Types.ContextType||(i.Types.ContextType={}))[V.Build=1]="Build",V[V.Release=2]="Release",(B=i.Types.ViewType||(i.Types.ViewType={}))[B.NoTestDataView=0]="NoTestDataView",B[B.ReportView=1]="ReportView",B[B.TestInsightsReportView=2]="TestInsightsReportView",B[B.ErrorView=3]="ErrorView",B[B.DataNotReadyView=4]="DataNotReadyView",(f=i.Types.TrendBy||(i.Types.TrendBy={}))[f.Hours=0]="Hours",f[f.Days=1]="Days",f[f.Weeks=2]="Weeks",(v=i.Types.Period||(i.Types.Period={}))[v.Days_1=0]="Days_1",v[v.Days_7=1]="Days_7",v[v.Days_14=2]="Days_14",v[v.Days_30=3]="Days_30",v[v.Days_180=4]="Days_180",(C=i.Types.TrendType||(i.Types.TrendType={}))[C.Increased=0]="Increased",C[C.Decreased=1]="Decreased",function(e){i.Definitions={};class n{constructor(e){this._options=[],this._initializeOptions(e)}get options(){return this._options}}i.Definitions.ConfigurationProps=n;i.Definitions.PeriodConfigurationProps=class extends n{constructor(e){super(e)}_initializeOptions(e){e=e||T.Period.Days_30,this._options[T.Period.Days_7]=(0,t.format)(R.NoOfDaysFormatString,R.SevenNumberText),e>T.Period.Days_7&&(this._options[T.Period.Days_14]=(0,t.format)(R.NoOfDaysFormatString,R.FourteenNumberText)),e>T.Period.Days_14&&(this._options[T.Period.Days_30]=(0,t.format)(R.NoOfDaysFormatString,R.ThirtyDays)),e>T.Period.Days_30&&(this._options[T.Period.Days_180]=(0,t.format)(R.NoOfDaysFormatString,R.OneEightyDays))}}}(),i.PipelineEntities={},i.PipelineEntities.Pipelines="BuildPipelines",i.PipelineEntities.Pipeline="BuildPipeline",i.PipelineEntities.PipelineSK="BuildPipelineSK",i.PipelineEntities.PipelineId="BuildPipelineId",i.PipelineEntities.PipelineName="BuildPipelineName",i.PipelineEntities.PipelineVersion="BuildPipelineVersion",i.PipelineEntities.PipelineProcessType="BuildPipelineProcessType",i.PipelineEntities.PipelineRuns="Builds",i.PipelineEntities.PipelineRun="Build",i.PipelineEntities.PipelineRunSK="BuildSK",i.PipelineEntities.PipelineRunId="BuildId",i.PipelineEntities.PipelineRunNumber="BuildNumber",i.PipelineEntities.PipelineRunNumberRevision="BuildNumberRevision",i.PipelineEntities.PipelineRunOutcome="BuildOutcome",i.PipelineEntities.PipelineRunReason="BuildReason",i.PipelineEntities.PipelineRunDurationSeconds="BuildDurationSeconds",i.PipelineEntities.PipelineRunActivityResults="BuildTaskResults",i.PipelineEntities.PipelineRunActivityResult="BuildTaskResult",i.PipelineEntities.PipelineRunTaskResultSK="BuildTaskResultSK",i.PipelineEntities.PipelineRunQueuedDateSK="BuildQueuedDateSK",i.PipelineEntities.PipelineRunQueuedOn="BuildQueuedOn",i.PipelineEntities.PipelineRunStartedDateSK="BuildStartedDateSK",i.PipelineEntities.PipelineRunStartedOn="BuildStartedOn",i.PipelineEntities.PipelineRunCompletedDateSK="BuildCompletedDateSK",i.PipelineEntities.PipelineRunCompletedOn="BuildCompletedOn",i.PipelineEntities.PipelineRunTaskOutcome="BuildTaskOutcome",i.PipelineEntities.PipelineTask="BuildPipelineTask",i.PipelineEntities.PipelineTaskSK="BuildPipelineTaskSK",i.PipelineEntities.switchEntityAndAttributeNames=function(){i.PipelineEntities.Pipelines="Pipelines",i.PipelineEntities.Pipeline="Pipeline",i.PipelineEntities.PipelineSK="PipelineSK",i.PipelineEntities.PipelineId="PipelineId",i.PipelineEntities.PipelineName="PipelineName",i.PipelineEntities.PipelineVersion="PipelineVersion",i.PipelineEntities.PipelineProcessType="PipelineProcessType",i.PipelineEntities.PipelineRuns="PipelineRuns",i.PipelineEntities.PipelineRun="PipelineRun",i.PipelineEntities.PipelineRunSK="PipelineRunSK",i.PipelineEntities.PipelineRunId="PipelineRunId",i.PipelineEntities.PipelineRunNumber="PipelineRunNumber",i.PipelineEntities.PipelineRunNumberRevision="PipelineRunNumberRevision",i.PipelineEntities.PipelineRunOutcome="PipelineRunOutcome",i.PipelineEntities.PipelineRunReason="PipelineRunReason",i.PipelineEntities.PipelineRunDurationSeconds="PipelineRunDurationSeconds",i.PipelineEntities.PipelineRunActivityResults="PipelineRunActivityResults",i.PipelineEntities.PipelineRunActivityResult="PipelineRunActivityResult",i.PipelineEntities.PipelineRunTaskResultSK="PipelineRunTaskResultSK",i.PipelineEntities.PipelineRunQueuedDateSK="PipelineRunQueuedDateSK",i.PipelineEntities.PipelineRunQueuedOn="PipelineRunQueuedOn",i.PipelineEntities.PipelineRunStartedDateSK="PipelineRunStartedDateSK",i.PipelineEntities.PipelineRunStartedOn="PipelineRunStartedOn",i.PipelineEntities.PipelineRunCompletedDateSK="PipelineRunCompletedDateSK",i.PipelineEntities.PipelineRunCompletedOn="PipelineRunCompletedOn",i.PipelineEntities.PipelineRunTaskOutcome="PipelineRunTaskOutcome",i.PipelineEntities.PipelineTask="PipelineTask",i.PipelineEntities.PipelineTaskSK="PipelineTaskSK"},i.PipelineEntities.switchEntityAndAttributesBackToBuild=function(){i.PipelineEntities.Pipelines="BuildPipelines",i.PipelineEntities.Pipeline="BuildPipeline",i.PipelineEntities.PipelineSK="BuildPipelineSK",i.PipelineEntities.PipelineId="BuildPipelineId",i.PipelineEntities.PipelineName="BuildPipelineName",i.PipelineEntities.PipelineVersion="BuildPipelineVersion",i.PipelineEntities.PipelineProcessType="BuildPipelineProcessType",i.PipelineEntities.PipelineRuns="Builds",i.PipelineEntities.PipelineRun="Build",i.PipelineEntities.PipelineRunSK="BuildSK",i.PipelineEntities.PipelineRunId="BuildId",i.PipelineEntities.PipelineRunNumber="BuildNumber",i.PipelineEntities.PipelineRunNumberRevision="BuildNumberRevision",i.PipelineEntities.PipelineRunOutcome="BuildOutcome",i.PipelineEntities.PipelineRunReason="BuildReason",i.PipelineEntities.PipelineRunDurationSeconds="BuildDurationSeconds",i.PipelineEntities.PipelineRunActivityResults="BuildTaskResults",i.PipelineEntities.PipelineRunActivityResult="BuildTaskResult",i.PipelineEntities.PipelineRunTaskResultSK="BuildTaskResultSK",i.PipelineEntities.PipelineRunQueuedDateSK="BuildQueuedDateSK",i.PipelineEntities.PipelineRunQueuedOn="BuildQueuedOn",i.PipelineEntities.PipelineRunStartedDateSK="BuildStartedDateSK",i.PipelineEntities.PipelineRunStartedOn="BuildStartedOn",i.PipelineEntities.PipelineRunCompletedDateSK="BuildCompletedDateSK",i.PipelineEntities.PipelineRunCompletedOn="BuildCompletedOn",i.PipelineEntities.PipelineRunTaskOutcome="BuildTaskOutcome",i.PipelineEntities.PipelineTask="BuildPipelineTask",i.PipelineEntities.PipelineTaskSK="BuildPipelineTaskSK"},i.PipelineEntities.RenameBuildEntitiesFeatureFlag="WebAccess.Pipeline.Analytics.RenameBuildEntities",function(e){i[e]={};class t extends a.VssService{constructor(){super(...arguments),this.items=new s.ObservableArray}getBreadcrumbItems(e){return this.items}async addDefinition(e){(await this._getBreadcrumbItems(e)).forEach((e=>this.items.push(e)))}async _serviceStart(e){super._serviceStart(e);const i=(0,n.getContextTypeFromUrl)(this.pageContext),t=this.pageContext.getService("IVssContributionService");"build"==i?(await t.getContributionAsync("ms.vss-analyticsshared-web.analytics-build-service"),this._analyticsDataService=e.getService("IBuildAnalyticsDataService")):(await t.getContributionAsync("ms.vss-test-analytics-web.release-helper"),this._analyticsDataService=e.getService("IReleaseAnalyticsDataService"))}async _getBreadcrumbItems(e){const i=await this._analyticsDataService.fetchDefinitionName(e),t=this._analyticsDataService.getDefinitionUrl(e),n=this._analyticsDataService.getAnalyticsCardMetricsUrl(e);return[{key:"definition-breadcrumb",href:t,text:i,onClick:e=>{(0,l.onClickFPS)(this.pageContext,t,!0,e)},ariaLabel:i},{key:"definition-analytics-breadcrumb",text:R.AnalyticsText,href:n,onClick:e=>{(0,l.onClickFPS)(this.pageContext,n,!0,e)},ariaLabel:R.AnalyticsText}]}}i[e].AnalyticsHubBreadCrumbService=t,a.Services.add("analytics-hub-breadcrumb-service",{serviceFactory:t})}("ServiceAnalyticsHubBreadCrumbService"),function(e){i[e]={};class t{constructor(e,i,t){this._command=e,this._oDataQueryOptions=i,this.pageContext=t}runQuery(){return this.pageContext.getRestClient("IAnalyticsODataClient").query(this._command,this._oDataQueryOptions)}getKey(){const e=Object.assign({},this._oDataQueryOptions);return e.pageContext=void 0,JSON.stringify(e)}}class n{constructor(e,i,t,n){this._command=e,this._odataQueryUrl=i,this._oDataQueryOptions=t,this.pageContext=n}runQuery(){return this.pageContext.getRestClient("IAnalyticsODataClient").runNextLink(this._command,this._odataQueryUrl,this._oDataQueryOptions)}getKey(){return this._odataQueryUrl}}i[e].AnalyticsODataClientBase=class{constructor(e,i){this._command=e,this.pageContext=i,this._cacheableQueryService=this.pageContext.getService("ICacheableQueryService")}queryOData(e,i){e.oDataVersion=r.latestODataVersion,e.followNextLink=!i,e.batchRequestMode=2,e.pageContext=this.pageContext;const n=new t(this._command,e,this.pageContext);return this._getQueryResult(n)}queryODataByUrl(e){const i={oDataVersion:r.latestODataVersion,batchRequestMode:2,pageContext:this.pageContext},t=new n(this._command,e,i,this.pageContext);return this._getQueryResult(t)}_getProjectId(){const e=this.pageContext.getService("ITfsPageService").getData();if(e&&e.project)return e.project.id;throw new Error("Unable to fetch project details.")}async _getQueryResult(e){const i=this._cacheableQueryService.hasCachedEntry(e),t=await this._cacheableQueryService.getCacheableQueryResult(e);return t.isCachedData=i,t}}}("SourcesAnalyticsODataClientBase"),function(e){function t(e){if(null!=e){let i=2;return i=Math.pow(10,i),Math.floor(e*i)/i}return e}i[e]={},i[e].formatData=function(e){return e.map((e=>t(e)))},i[e].toTwoDecimalPoint=t}("UtilsChartDataConverter"),function(e){i.UtilsDateAdjuster={},i.UtilsDateAdjuster.parseReturnDateIntoDisplayForm=function(e,i){switch(e){case T.TrendBy.Days:return o.DateSKParser.parseDateSKAsDateString(i.CompletedDateSK);case T.TrendBy.Weeks:return o.DateSKParser.convertDateToDateString(new Date(i.Date.WeekStartingDate));default:return""}};function t(e,i){const t=(0,u.shiftToUTC)((0,u.getDate)());let s=t;switch(e){case T.TrendBy.Days:s=(0,u.addDays)(t,1-n(i));break;case T.TrendBy.Weeks:s=(0,u.addDays)(t,-7*n(i)+1);break;case T.TrendBy.Hours:s=(0,u.addDays)((0,u.getDate)(),-n(i))}return s}function n(e){switch(e){case T.Period.Days_1:return 1;case T.Period.Days_7:return 7;case T.Period.Days_14:return 14;case T.Period.Days_30:return 30;case T.Period.Days_180:return 180;default:return 30}}i.UtilsDateAdjuster.getDateFilter=function(e,i,n){let s=t(e,i);return`${n=n||"CompletedDateSK"} ge ${o.DateSKParser.dateStringToDateSK(o.DateSKParser.convertDateToDateString(s))}`},i.UtilsDateAdjuster.getLookBackDate=t,i.UtilsDateAdjuster.adjustDataForAllPeriod=function(e,i,t,s){if(!e||e.length<=0&&null==s)return e;const a={},l={};e.forEach((e=>{a[e.date]||(a[e.date]=e.data,l[e.date]=e.customData)}));let r=0,o=(0,u.getDate)();const c=n(t||T.Period.Days_14);switch(i){case T.TrendBy.Days:r=1,o=(0,u.addDays)((0,u.shiftToUTC)((0,u.getDate)()),r*(1-c),!0);break;case T.TrendBy.Weeks:r=7;const e=(0,u.addDays)((0,u.shiftToUTC)((0,u.getDate)()),r*(1-c),!0);o=(0,u.addDays)(e,-e.getDay(),!0)}const p=[];for(let e=1;e<=c;e++){const e=(0,u.convertDateToDateString)(o);a.hasOwnProperty(e)?p.push({date:(0,u.convertDateToDateString)(o),data:a[e],customData:l[e]}):p.push({date:(0,u.convertDateToDateString)(o),data:s}),o=(0,u.addDays)(o,r)}return p},i.UtilsDateAdjuster.getPeriodValueFromPeriod=n,i.UtilsDateAdjuster.getPeriodStartDate=function(e,i){const t=(0,u.shiftToUTC)((0,u.getDate)());let s=t;switch(e){case T.TrendBy.Days:s=(0,u.addDays)(t,1-n(i));break;case T.TrendBy.Weeks:s=(0,u.addDays)(t,-7*n(i)+1)}return s},i.UtilsDateAdjuster.dateDiffInDays=function(e,i){const t=Date.UTC(e.getFullYear(),e.getMonth(),e.getDate()),n=Date.UTC(i.getFullYear(),i.getMonth(),i.getDate());return Math.floor((n-t)/864e5)}}(),i.UtilsTelemetry={},i.UtilsTelemetry.publishEvent=function(e,i,n,s,a){try{const t=e.getService("IVssTelemetryService");a[T.ContextType[s.contextType]]=s.definitionId,t.publishEvent(i,n,a)}catch(e){console.error(t.format("[TelemetryService.logProperties]: Error in logging Customer Intelligence data. Error: {0}",e.message))}},i[w="UtilsTrendCalculator"]={},i[w].getTrendFromData=function(e,i,t){let n;if(e!=i){let s=T.TrendType.Increased;e>i&&(s=T.TrendType.Decreased);let a=t?Math.abs((0,c.getPercentageVariation)(e,i)):Math.abs(Math.round(100*(i-e))/100);a=Math.round(10*a)/10,n={startValue:e,endValue:i,percentageVariation:a,trendType:s}}return n},function(e){b=i[e]={};class t extends y.VssComponent{constructor(e,i){super(e,i),this.state={}}render(){let e=P.createElement(m.Spinner,{className:"analytics-card-spinner flex-grow flex-column",size:"large"}),i=this.props.getSuggestion?this.props.getSuggestion(this.state.viewType,this.state.errorText):void 0,t=this.props.getMessage?this.props.getMessage(this.state.viewType,this.state.errorText):void 0;return this.state&&(this.state.viewType===T.ViewType.ReportView?e=P.createElement(P.Fragment,null,this.props.children):this.state.viewType===T.ViewType.DataNotReadyView?(t=null==t?R.AnalyticsDataNotReadyMessage:t,i=null==i?R.AnalyticsDataNotReadySuggestion:i,e=P.createElement(d.AnalyticsUnavailableMessage,{imageName:this.props.compactView?"":"data-not-ready.svg",iconName:this.props.compactView?"ExploreData":"",message:t,suggestion:i,ariaDescription:t||i,messageClassName:this.props.compactView?"ax-unavailable-error-message":""})):this.state.viewType===T.ViewType.ErrorView&&(t=null==t?R.AnalyticsErrorMessage:t,i=null==i?this.state.errorText:i,e=P.createElement(d.AnalyticsUnavailableMessage,{imageName:this.props.compactView?"":"ServiceError.svg",message:t,suggestion:i,ariaDescription:t||i}))),e}async componentDidMount(){super.componentDidMount(),await this._validateData()}async _validateData(){if(!this.props.dataValidationPromises||0==this.props.dataValidationPromises.length)return this.setState({viewType:T.ViewType.ReportView}),Promise.resolve();Promise.race(this.props.dataValidationPromises).then((()=>{this.setState({viewType:T.ViewType.ReportView})})).catch((e=>{(0,p.recognizeAnalyticsException)(e)===p.AnalyticsExceptionType.DataNotReady?this.setState({viewType:T.ViewType.DataNotReadyView}):this.setState({viewType:T.ViewType.ErrorView,errorText:(0,p.extractODataError)(e)})}))}}i[e].AnalyticsDataValidator=t}("AnalyticsDataValidator"),function(e){A=i[e]={};class t extends y.VssComponent{constructor(e,i){super(e,i),this._analyticsExtensionStateService=i.pageContext.getService("IAnalyticsExtensionStateService"),this.state={isAnalyticsEnabled:null}}render(){let e=P.createElement(m.Spinner,{className:"analytics-card-spinner flex-grow flex-column",size:"large"});if(this.state&&null!=this.state.isAnalyticsEnabled)if(this.state.isAnalyticsEnabled)e=P.createElement(P.Fragment,null,this.props.children);else{const i="axextension-not-installed.svg",t=(0,D.routeUrl)(this.context.pageContext,"ms.vss-analytics.analytics-management-route");e=P.createElement(d.AnalyticsUnavailableMessage,{imageName:i,message:R.AnalyticsNotEnabledMessage,suggestion:R.AnalyticsNotEnabledSuggestion,buttonText:R.AnalyticsSettings,buttonUrl:t,ariaDescription:R.AnalyticsNotEnabledAriaDescription})}return e}async componentDidMount(){if(super.componentDidMount(),null==this.state.isAnalyticsEnabled){const e=await this._analyticsExtensionStateService.isAnalyticsEnabled();this.props.onAnalyticsEnabled&&e&&this.props.onAnalyticsEnabled(),this.setState({isAnalyticsEnabled:e})}}}i[e].AnalyticsExtensionValidator=t}("AnalyticsExtensionValidator"),function(e){i[e]={};i[e].AnalyticsHeaderComponent=e=>P.createElement(h.CustomHeader,{className:"bolt-header-with-commandbar flex-wrap"},P.createElement(h.HeaderTitleArea,null,P.createElement(h.HeaderTitleRow,null,P.createElement(h.HeaderTitle,{className:"text-ellipsis",titleSize:1},e.title)),e.children),e.showCommandBar&&P.createElement(S.HeaderCommandBar,{className:"analytics-command-bar",items:e.commandBarItems}))}("AnalyticsHeaderComponent"),function(e){i.AnalyticsPage={};class t extends y.VssComponent{constructor(e,i){super(e,i),this._handleAnalyticsEnabled=()=>{this.state.dataValidationPromises&&0!==this.state.dataValidationPromises.length||this.setState({dataValidationPromises:this.props.getDataValidationPromises()})},this.state={dataValidationPromises:[]}}render(){return P.createElement(E.Surface,{background:1},P.createElement(g.Page,{className:"analytics-page flex-grow absolute-fill"},this.props.renderHeader(),P.createElement(A.AnalyticsExtensionValidator,{onAnalyticsEnabled:this._handleAnalyticsEnabled},P.createElement(b.AnalyticsDataValidator,{dataValidationPromises:this.state.dataValidationPromises},P.createElement("div",{className:"page-content page-content-top flex flex-grow"},this.props.children)))))}}i.AnalyticsPage.AnalyticsPage=t}()}),["Resources","Constants","Types","Definitions","PipelineEntities","Service/AnalyticsHubBreadCrumbService","Sources/AnalyticsODataClientBase","Utils/ChartDataConverter","Utils/DateAdjuster","Utils/Telemetry","Utils/TrendCalculator","AnalyticsDataValidator","AnalyticsExtensionValidator","AnalyticsHeaderComponent","AnalyticsPage"]),document.dispatchEvent(new CustomEvent("scriptLoaded",{cancelable:!1,detail:{id:"ms.vss-analyticsshared-web.analytics-shared-common"}}));