"use strict";define("Wit/Common/WorkItemLinksService",["require","exports","VSS/Core/Observable","VSS/Platform/Context","Wit/Common/Utils/WorkItemUtils/LinkTypeFilter","Wit/WorkItemLinksRegistration/Constants","Wit/WorkItemLinksRegistration/LinkUtils","Wit/WorkItemLinksRegistration/resolveArtifacts","Wit/WorkItemModel/WorkItem/Links"],(function(e,t,i,n,r,s,a,o,l){var p;!function(e){p=t.CompositeComparer={};t.CompositeComparer.CompositeComparer=class{constructor(){this._comparers=[]}push(e){this._comparers.push(e)}getComparer(){return(e,t)=>{for(let i of this._comparers){let n=i.compare(e,t);if(0!==n)return n}return 0}}},function(e){e[e.Ascending=1]="Ascending",e[e.Descending=-1]="Descending"}(t.CompositeComparer.SortDirection||(t.CompositeComparer.SortDirection={}));t.CompositeComparer.BaseStringComparer=class{constructor(e,t){this._sortDirection=e,this._stringValueExtractor=t}compare(e,t){return i(this._stringValueExtractor)(e,t)*this._sortDirection}};function i(e){return(t,i)=>{return n=e(t),r=e(i),n||r?n?r?n.localeCompare(r):-1:1:0;var n,r}}function n(e){return(t,i)=>function(e,t){const i=!e&&0!==e,n=!t&&0!==t;return i&&n?0:i?1:n?-1:e-t}(e(t),e(i))}t.CompositeComparer.BaseIntComparer=class{constructor(e,t){this._sortDirection=e,this._numberValueExtractor=t}compare(e,t){return n(this._numberValueExtractor)(e,t)*this._sortDirection}},t.CompositeComparer.sortByStringValue=i,t.CompositeComparer.sortByNumberValue=n;t.CompositeComparer.StateComparer=class{constructor(e,t,i,n){this._sortDirection=e,this._backlogConfig=t,this._workItemTypeService=i,this._applyCondition=n}compare(e,t){if(this._applyCondition){if(!this._applyCondition(e,t))return 0}let n=0;if(this._backlogConfig)n=this._compare(e,t);else{n=i((e=>null==e?void 0:e.state))(e,t)}return n*this._sortDirection}_compare(e,t){if(!e.state&&!t.state)return 0;if(!e.state)return 1;if(!t.state)return-1;if(!this._backlogConfig)return 0;let i=this._workItemTypeService.getStateCompareValue(e.state,e.linkTypeDisplayName,this._backlogConfig),n=this._workItemTypeService.getStateCompareValue(t.state,t.linkTypeDisplayName,this._backlogConfig);return(null!=i?i:0)-(null!=n?n:0)}}}(),function(e){t.WorkItemLinksService={};const d=["System.LinkTypes.Hierarchy-Reverse","System.LinkTypes.Hierarchy-Forward","System.LinkTypes.Dependency-Reverse","System.LinkTypes.Dependency-Forward","System.LinkTypes.Duplicate-Forward","System.LinkTypes.Duplicate-Reverse","System.LinkTypes.Related-Forward"],m=[s.RegisteredLinkTypeNames.Build,s.RegisteredLinkTypeNames.IntegratedInBuild,s.RegisteredLinkTypeNames.PullRequest,s.RegisteredLinkTypeNames.Branch,s.RegisteredLinkTypeNames.Commit,s.RegisteredLinkTypeNames.Changeset,s.RegisteredLinkTypeNames.VersionedItem,s.RegisteredLinkTypeNames.FoundInBuild,s.RegisteredLinkTypeNames.GitHubPullRequestLinkType,s.RegisteredLinkTypeNames.GitHubCommitLinkType];class k extends n.VssService{constructor(){super(...arguments),this.registeredLinkTypes=new Map,this.witLinkTypes=new Map,this.witLinkTypeEnds=new Map,this.resolvedLinkDataObservables=new Map}_serviceStart(e){super._serviceStart(e),this.workItemDataManager=e.getService("IWorkItemDataManager"),this.workItemTypesService=e.getService("IWorkItemTypesService");const t=e.getService("ICommonBacklogContentService");this.backlogConfiguration=t.getBacklogConfigurationSync(),this.initializationPromise=this.workItemDataManager.beginGetLinkTypes().then((e=>{if(!e)throw new Error("Links data not found");for(const t of e.registeredLinkTypes)this.registeredLinkTypes.set(t.name,t);for(const t of e.witLinkTypes)this.witLinkTypes.set(t.referenceName,t),t.forwardEnd.linkType=t,t.reverseEnd.linkType=t,this.witLinkTypeEnds.set(t.forwardEnd.id,t.forwardEnd),this.witLinkTypeEnds.set(t.forwardEnd.immutableName,t.forwardEnd),this.witLinkTypeEnds.set(t.reverseEnd.id,t.reverseEnd),this.witLinkTypeEnds.set(t.reverseEnd.immutableName,t.reverseEnd)}))}getObservableLinkData(e,t){return this.getLinkDataState(e,t).observableDisplayData}getObservableLinkCounts(e,t){return this.getLinkDataState(e,t).hiddenLinkCounts}refreshLinkData(e,t){if(t)this.refreshLinkDataForOptions(e,t);else for(const t of this.getCachedLinkDataOptions(e))this.refreshLinkDataForOptions(e,t)}refreshLinkDataForOptions(e,t){var n;const r=null!==(n=this.getExistingLinkData(e,t))&&void 0!==n?n:{observableDisplayData:new i.ObservableArray(new Array(5).fill(void 0)),hiddenLinkCounts:new i.ObservableValue({shown:0,total:0,notShown:{}})};this.setExistingLinkData(e,t,r),Promise.all([this.getLinkIdentifiers(e,t),this.getLinkIdentifiers(e,Object.assign(Object.assign({},t),{maxLinkCount:Number.MAX_SAFE_INTEGER}))]).then((([i,n])=>{var l;const d=n.filter((e=>!i.find((t=>(0,a.isSameLinkIdentifier)(e,t))))),m={};for(const e of d){const t=this.getLinkTypeName(e),i=null!==(l=m[t])&&void 0!==l?l:0;m[t]=i+1}r.hiddenLinkCounts.value={total:n.length,shown:i.length,notShown:m};let k=new p.CompositeComparer;"Development"===t.zeroDataExperience&&(k.push(new p.StateComparer(p.SortDirection.Ascending,this.backlogConfiguration,this.workItemTypesService,((e,t)=>(null==e?void 0:e.linkTypeDisplayName)===s.RegisteredLinkTypeNames.PullRequest||(null==t?void 0:t.linkTypeDisplayName)===s.RegisteredLinkTypeNames.PullRequest))),k.push(new p.BaseIntComparer(p.SortDirection.Descending,(e=>{var t,i;return null!==(i=null===(t=null==e?void 0:e.updateDate)||void 0===t?void 0:t.getTime())&&void 0!==i?i:0})))),k.push(new p.BaseStringComparer(p.SortDirection.Ascending,(e=>null==e?void 0:e.title))),k.push(new p.BaseStringComparer(p.SortDirection.Ascending,(e=>null==e?void 0:e.id.toString()))),(0,o.observeArtifactResolution)(i,e.id,this.pageContext,r.observableDisplayData,t.ignoreArtifactCache,k.getComparer(),this.witLinkTypeEnds)}))}getLinkDataState(e,t){const i=this.getExistingLinkData(e,t);return i||(this.refreshLinkData(e,t),this.getExistingLinkData(e,t))}makeLinkComparerInternal(){const e=this.makeLinkComparer((e=>{var t,i;const n=this.getWitLinkTypeEndSync(e.linkData.LinkType);return null!==(i=null!==(t=null==n?void 0:n.immutableName)&&void 0!==t?t:e.linkData.OriginalName)&&void 0!==i?i:s.RegisteredLinkTypeNames.Related}));return e.push(new p.BaseIntComparer(p.SortDirection.Descending,(e=>{var t,i,n,r,s;return null!==(s=null!==(n=null===(i=null===(t=null==e?void 0:e.linkData)||void 0===t?void 0:t.LastWriteDate)||void 0===i?void 0:i.getTime())&&void 0!==n?n:null===(r=null==e?void 0:e.linkData["Changed Date"])||void 0===r?void 0:r.getTime())&&void 0!==s?s:0}))),e}async getLinkIdentifiers(e,{linkTypeFilter:t,includeDeleted:i,maxLinkCount:n}){await this.initializationPromise;const r=this.makeLinkComparerInternal();let a=0;return e.getLinks(i).sort(r.getComparer()).filter((e=>{var i;if(e instanceof l.Attachment)return!1;if(!t)return!0;const r=e.getWitLinkTypeEndId(),s=void 0===r||null===(i=this.getWitLinkTypeEndSync(r))||void 0===i?void 0:i.immutableName;return!!t(e.getLinkType(),s)&&!(++a>(null!=n?n:Number.MAX_SAFE_INTEGER))})).map((e=>Object.assign(Object.assign({},e.linkData),{FldID:e.linkData.FldID||s.LinkTypeFieldIds.WorkItem,tool:this.getLinkTypeToolId(e)})))}makeLinkComparer(e){const t=new p.CompositeComparer;return t.push(new p.BaseIntComparer(p.SortDirection.Ascending,(t=>d.indexOf(e(t))))),t.push(new p.BaseIntComparer(p.SortDirection.Ascending,(t=>m.indexOf(e(t))))),t.push(new p.BaseStringComparer(p.SortDirection.Ascending,(t=>{var i;const n=this.getWitLinkTypeEndSync(e(t));return null!==(i=null==n?void 0:n.name)&&void 0!==i?i:(0,a.getLinkTypeDisplayName)(e(t))}))),t}getAttachments(e){return e.getLinks().filter((e=>e instanceof l.Attachment&&!e.isRemoved()))}async getLinkTypes(){return await this.initializationPromise,Array.from(this.registeredLinkTypes.values())}async getWitLinkTypes(){return await this.initializationPromise,Array.from(this.witLinkTypes.values())}async getWitLinkType(e){return await this.initializationPromise,this.witLinkTypes.get(e)}async getWitLinkTypeEnd(e){return await this.initializationPromise,this.getWitLinkTypeEndSync(e)}async getWitLinkTypeEnds(){return await this.initializationPromise,Array.from(this.witLinkTypeEnds.values())}getCachedLinkDataOptions(e){const t=[],i=this.resolvedLinkDataObservables.get(e.id);if(!i)return t;for(const[e,n]of i.entries())for(const[i,r]of n.entries())for(const n of r.keys())t.push({linkTypeFilter:e,maxLinkCount:i,includeDeleted:n});return t}getExistingLinkData(e,{linkTypeFilter:t,includeDeleted:i,maxLinkCount:n}){var s,a,o;return null===(o=null===(a=null===(s=this.resolvedLinkDataObservables.get(e.id))||void 0===s?void 0:s.get(null!=t?t:r.allLinksFilter))||void 0===a?void 0:a.get(null!=n?n:Number.MAX_SAFE_INTEGER))||void 0===o?void 0:o.get(null!=i&&i)}setExistingLinkData(e,{linkTypeFilter:t,includeDeleted:i,maxLinkCount:n},s){this.resolvedLinkDataObservables.has(e.id)||this.resolvedLinkDataObservables.set(e.id,new Map);const a=this.resolvedLinkDataObservables.get(e.id);a.has(null!=t?t:r.allLinksFilter)||a.set(null!=t?t:r.allLinksFilter,new Map);const o=a.get(null!=t?t:r.allLinksFilter);o.has(null!=n?n:Number.MAX_SAFE_INTEGER)||o.set(null!=n?n:Number.MAX_SAFE_INTEGER,new Map);o.get(null!=n?n:Number.MAX_SAFE_INTEGER).set(null!=i&&i,s)}getWitLinkTypeEndSync(e){if(void 0!==e)return this.witLinkTypeEnds.get(e)}getLinkTypeToolId(e){if(e.isRemote())return s.ToolIds.RemoteWorkItemTracking;const t=e.getLinkType();return this.registeredLinkTypes.has(t)?this.registeredLinkTypes.get(t).toolId:s.ToolIds.WorkItemTracking}getLinkTypeName(e){var t,i,n;return e.LinkType?null!==(i=null===(t=this.getWitLinkTypeEndSync(e.LinkType))||void 0===t?void 0:t.name)&&void 0!==i?i:(0,a.getLinkTypeDisplayName)(s.RegisteredLinkTypeNames.Related):(0,a.getLinkTypeDisplayName)(null!==(n=e.OriginalName)&&void 0!==n?n:s.RegisteredLinkTypeNames.Related)}}n.Services.add("IWorkItemLinksService",{serviceFactory:k})}()}),["CompositeComparer","WorkItemLinksService"]),document.dispatchEvent(new CustomEvent("scriptLoaded",{cancelable:!1,detail:{id:"ms.vss-work-web.work-item-links-service"}}));