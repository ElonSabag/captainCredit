"use strict";define("Wit/Common/Utils/WorkItemUtils",["require","exports","Wit/WorkItemModel/OM/index","Wit/WorkItemLinksRegistration/Constants","VSS/Platform/Util/Serialization","react","VSS/Core/Observable","VSS/Core/Util/String","VSS/Features/Markdown/Utils/UrlHelper","VSS/Platform/Layout","VSSUI/TooltipEx","VSSUI/Util","VSSUI/Utils/ClipboardUtils","Wit/Common/BulkUpdateUtils/BulkUpdateInterfaces","Wit/Common/BulkUpdateUtils/BulkUpdateUtils","Wit/Common/Generated/Constants","Wit/Common/QueryUtils/ErrorHandlingUtils","Wit/Common/QueryUtils/QueryUtils","Wit/Common/QueryUtils/RoutingUtils","Wit/Common/WorkItemDialogs/Components/ChangeTypeDialog","Wit/Common/WorkItemDialogs/Components/ConfirmationDialog","Wit/Common/WorkItemDialogs/Components/EmailWorkItemsDialog","Wit/Common/WorkItemDialogs/Components/MoveToPositionDialog","Wit/Common/WorkItemDialogs/Components/MoveToProjectDialog","Wit/Common/WorkItemDialogs/Components/WorkItemFormDialog","Wit/Identity/Utilities/WorkItemIdentityHelper","Wit/WorkItemModel/WorkItem/Links"],(function(e,t,o,n,r,i,s,a,l,m,c,d,u,k,p,y,g,I,f,T,v,C,w,W,L,b,h){var F,R,S;F=t.Resources={},t.Resources.ChangeType="Change type...",t.Resources.CopyWorkItemsAsHtml="Copy as HTML",t.Resources.EmailSelectedWorkItems="Email...",t.Resources.FutureIterations="Future iterations",t.Resources.LinkSelectedItemsToNewWorkItem="Link to a new work item...",t.Resources.LinkToExistingItem="Link to an existing item...",t.Resources.MissingTeamSettingsError="Incomplete team settings.",t.Resources.MoveWorkItemTitle="Move to team project...",t.Resources.MoveToIteration="Move to iteration",t.Resources.MoveToIteration_Backlog="Backlog",t.Resources.MoveToIteration_Current="Current ({0})",t.Resources.MoveToPositionContentMenuItem="Move to position",t.Resources.NewBranch="New branch...",t.Resources.PermanentlyDelete="Permanently delete",t.Resources.PermanentlyDeleteMessage="Are you sure you want to permanently delete the selected work item(s)? Permanently deleted work item(s) cannot be restored.",t.Resources.PermanentlyDeleteTitle="Permanently delete work item(s)",t.Resources.Restore="Restore",t.Resources.RestoreWorkItemTitle="Restore work item(s)",t.Resources.RestoreWorkItemMessage="Are you sure you want to restore the selected work item(s)?",t.Resources.WorkItemCount="{0} work items",t.Resources.WorkItemSubject="Work item {0}",function(e){R=t[e]={};const o=new window.DOMParser,n=["-Forward","-Reverse"];t[e].extractInfoFromControlMetadata=function(e){var t,r,i;const s=o.parseFromString(e,"text/xml"),a="List"===(null===(t=s.querySelector("LinksControlOptions"))||void 0===t?void 0:t.getAttribute("ViewMode")),l=new Set;s.querySelectorAll("ExternalLinkFilter").forEach((e=>{const t=e.getAttribute("Type");t&&l.add(t)}));const m=new Set;s.querySelectorAll("WorkItemLinkFilter").forEach((e=>{const t=e.getAttribute("Type");t&&(l.add("Related Workitem"),m.add(t),n.some((e=>t.endsWith(e)))||n.forEach((e=>m.add(t+e))))}));const c=new Set;s.querySelectorAll("WorkItemTypeFilters").forEach((e=>{e.querySelectorAll("Filter").forEach((e=>{const t=e.getAttribute("WorkItemType");t&&c.add(t)}))}));const d=null!==(i=null===(r=s.querySelector("LinksControlOptions"))||void 0===r?void 0:r.getAttribute("ZeroDataExperience"))&&void 0!==i?i:"RelatedWork",u=[];return s.querySelectorAll("Column").forEach((e=>{const t=e.getAttribute("Name");t&&u.push(t)})),{zeroDataExperience:d,columns:u.length>0?u:void 0,compact:a,allowedLinkTypes:l,allowedWitLinkTypeEnds:m,allowedWorkItemTypes:c}}}("extractInfoFromControlMetadata"),function(e){S=t.LinkTypeFilter={};const i=new Set(["System.LinkTypes.Remote.Dependency-Forward","System.LinkTypes.Remote.Dependency-Reverse","System.LinkTypes.Remote.Related-Forward"]),s=()=>!0;t.LinkTypeFilter.allLinksFilter=s;t.LinkTypeFilter.newLinksFilter=(e,t,r)=>!(!r||r!==n.ToolIds.WorkItemTracking||e===o.RegisteredLinkTypeNames.Hyperlink||t&&i.has(t));t.LinkTypeFilter.parentLinkTypeFilter=(e,t)=>"System.LinkTypes.Hierarchy-Reverse"===t;t.LinkTypeFilter.commitLinkTypeFilter=e=>e===o.RegisteredLinkTypeNames.Commit;t.LinkTypeFilter.pullRequestLinkTypeFilter=e=>e===o.RegisteredLinkTypeNames.PullRequest;t.LinkTypeFilter.branchLinkTypeFilter=e=>e===o.RegisteredLinkTypeNames.Branch;t.LinkTypeFilter.githubCommitLinkTypeFilter=e=>e===o.RegisteredLinkTypeNames.GitHubCommitLinkType;function a(e){const{allowedLinkTypes:o,allowedWitLinkTypeEnds:n}=(0,R.extractInfoFromControlMetadata)(e);return function(e,o){if(0===e.size&&0===o.size)return t.LinkTypeFilter.allLinksFilter;return(t,n,r)=>{const i=0===e.size||e.has(t),s=0===o.size||void 0===n||o.has(n);return i&&s}}(o,n)}function l(e){const t=k(e).map(u).map(d).map(a);return(e,o)=>{for(const n of t)if(!n(e,o))return!1;return!0}}function m(e){return function(e){return 0===e.size?s:t=>e.has(t)}((0,R.extractInfoFromControlMetadata)(e).allowedWorkItemTypes)}function c(e){for(const t of e.pages)if(3===t.pageType)for(const e of t.sections)for(const t of e.groups)for(const e of t.controls)if("LinksControl"===e.controlType)return e.metadata}function d(e){for(const t of e.pages)for(const e of t.sections)for(const t of e.groups)if("Related Work"===t.label)for(const e of t.controls)if("LinksControl"===e.controlType)return e.metadata}function u(e){const t=e.rules.form;if(!t)throw new Error("Work item form layout not found");const o=(0,r.deserializeVssJsonObject)(String(t))||void 0;if(!o)throw new Error("Could not deserialize work item form layout");return o}function k(e){const t=new Map;for(const o of e){const e=o.getTypeData();t.set(e.name,e)}return[...t.values()]}t.LinkTypeFilter.githubPullRequestLinkTypeFilter=e=>e===o.RegisteredLinkTypeNames.GitHubPullRequestLinkType,t.LinkTypeFilter.getLinkTypeFilterForControl=a,t.LinkTypeFilter.getDefaultLinkTypeFilter=function(e){const o=c(u(e.getTypeData()));return o?a(o):t.LinkTypeFilter.allLinksFilter},t.LinkTypeFilter.getRelatedWorkLinkTypeFilter=l,t.LinkTypeFilter.getRelatedWorkNewLinkTypeFilter=function(e){const o=l(e);return(e,n,r)=>o(e,n,r)&&(0,t.LinkTypeFilter.newLinksFilter)(e,n,r)},t.LinkTypeFilter.getLinkableWorkItemTypeFilterForControl=m,t.LinkTypeFilter.getDefaultLinkableWorkItemTypeFilter=function(e){const t=k(e).map(u).map(c).map(m);return e=>{for(const o of t)if(!o(e))return!1;return!0}},t.LinkTypeFilter.getRelatedWorkLinkableWorkItemTypeFilter=function(e){const t=k(e).map(u).map(d).map(m);return e=>{for(const o of t)if(!o(e))return!1;return!0}}}(),function(e){t[e]={},t[e].TestItemTypes=["Test Case","Test Suite","Test Plan","Shared Steps","Shared Parameter"];t[e].getChangeTypeCommandMenuItem=(e,t,n,r,s)=>({disabled:r,rank:11,id:"change-work-item-type",text:F.ChangeType,iconProps:{iconName:"Switch"},groupKey:t,onActivate:()=>{o(e,(e=>i.createElement(T.ChangeTypeDialog,{onDismiss:e,onModifyItems:s,selectedItems:n()})))}});t[e].getCopyAsHTMLCommandMenuItem=(o,n,r,i)=>({rank:20,id:"copy-html",text:F.CopyWorkItemsAsHtml,iconProps:{iconName:"Copy"},groupKey:n,onActivate:()=>{(0,t[e].onCopyHTML)(o,r,i)}});t[e].getEmailCommandMenuItem=(e,t,n,r,s,l)=>{const m=()=>{const e=n();return e.length>1?(0,a.format)(F.WorkItemCount,e.length):(0,a.format)(F.WorkItemSubject,e[0][y.CoreFieldRefNames.Id])};return{rank:71,id:"email-selection",text:F.EmailSelectedWorkItems,iconProps:{iconName:"Mail"},groupKey:null!=s?s:"export",onActivate:()=>{o(e,(e=>i.createElement(C.EmailWorkItemsDialog,{columnFieldNames:t.map((e=>e.text)).filter((e=>e)),referenceFieldNames:t.map((e=>e.name)).filter((e=>e)),onDismiss:e,selectedItems:n(),defaultSubject:null!=l?l:m(),getTempQueryId:r})))}}};t[e].getLinkToExistingCommandMenuItem=(e,t)=>({rank:50,id:"link-to-existing",text:F.LinkToExistingItem,iconProps:{iconName:"Link"},groupKey:"link",onActivate:()=>{const n=e.getService("IWorkItemModelService"),r=t().map((e=>e[y.CoreFieldRefNames.Id]));n.getWorkItems(r).then((t=>{o(e,(o=>i.createElement(m.WrappedComponent,{dependencies:["ms.vss-work-web.work-item-form-view","ms.vss-work-web.work-item-form-dependencies","ms.vss-work-web.new-work-item-form-content"],wrappedType:"add-link-dialog",originWorkItems:t,linkTypeFilter:(0,S.getRelatedWorkLinkTypeFilter)(t),linkableWorkItemTypeFilter:(0,S.getRelatedWorkLinkableWorkItemTypeFilter)(t),onAddLinks:n=>{const r=n.map((e=>h.Link.createFromLinkData(e.linkIdentifier)));for(let e of t)e.addLinks(r);e.getService("IWorkItemSavingService").beginSaveWorkItemsBatch(t,o)},onDismiss:o})))}))}});t[e].getLinkToNewCommandMenuItem=(e,t,n)=>({rank:10,id:"link-to-new",text:F.LinkSelectedItemsToNewWorkItem,iconProps:{iconName:"WorkItem"},groupKey:"link",onActivate:()=>{const r=e.getService("IWorkItemModelService"),s=t().map((e=>e[y.CoreFieldRefNames.Id]));r.getWorkItems(s).then((t=>{o(e,(o=>{const s=e.getService("IVssLayoutManager");return i.createElement(m.WrappedComponent,{dependencies:["ms.vss-work-web.work-item-form-view","ms.vss-work-web.work-item-form-dependencies","ms.vss-work-web.new-work-item-form-content"],wrappedType:"add-link-dialog",originWorkItems:t,linkTypeFilter:(0,S.getRelatedWorkNewLinkTypeFilter)(t),linkableWorkItemTypeFilter:(0,S.getRelatedWorkLinkableWorkItemTypeFilter)(t),onNewLinksAdded:async a=>{if(!n)return;const l=await r.createWorkItem(a.newWorkItemData.typeData,n),m=t.map((t=>h.WorkItemLink.create(e,a.linkTypeName,t.id,a.comment))),c=await Promise.all(m);l.addLinks(c),l.setFieldValueByName(y.CoreFieldRefNames.Title,a.newWorkItemData.title),s.renderCallout((e=>i.createElement(L.WorkItemFormDialog,{workItem:l,onDismiss:()=>{e(),o()}})))},onDismiss:o,isLinkToNewItem:!0})}))}))}});t[e].getMoveToTeamProjectCommandMenuItem=(e,t,n,r)=>({rank:12,id:"move-work-items",text:F.MoveWorkItemTitle,iconProps:{iconName:"Assign"},groupKey:t,onActivate:()=>{o(e,(e=>i.createElement(W.MoveToProjectDialog,{onDismiss:e,onModifyItems:r,selectedItems:n()})))}});t[e].getNewBranchCommandMenuItem=(e,t)=>({rank:80,id:"new-branch",text:F.NewBranch,iconProps:{iconName:"OpenSource"},groupKey:"branch",onActivate:()=>{e.getService("IVssContributionService").executeCommandEx("ms.vss-code-web.tags-version-dialog-actions-command",{dependencies:["ms.vss-code-web.version-dialogs-content","ms.vss-code-web.versioncontrol-viewmodel-data-provider"],serviceName:"IVersionDialogActionsService",methodName:"createBranch"},{initialWorkItemIds:t().map((e=>e[y.CoreFieldRefNames.Id])),allowChangingRepository:!0})}});t[e].getRestoreCommandMenuItem=(e,t,o,n,r,i)=>{var s;return{id:"restore-item",text:F.Restore,iconProps:{iconName:"RevToggleKey"},subtle:!0,disabled:null!==(s=!r)&&void 0!==s?s:0===o.length,onActivate:()=>{(0,v.showConfirmationDialog)(e,F.RestoreWorkItemMessage,F.Restore,F.RestoreWorkItemTitle,(async()=>{const r=e.getRestClient("IWorkItemTrackingRestClient");for(const i of o.value){const o=await r.restoreWorkItem({isDeleted:!1},Number(i),t);if(o.message)return void(0,g.reportError)(e,"restore-work-item",o.message);n&&n()}}))},rank:i}};t[e].getPermanentlyDeleteCommandMenuItem=(e,t,o,n,r,i)=>{var s;return{id:"permanently-delete-item",text:F.PermanentlyDelete,iconProps:{iconName:"Cancel",className:"error-text"},subtle:!0,disabled:null!==(s=!r)&&void 0!==s?s:0===o.length,onActivate:()=>{(0,v.showConfirmationDialog)(e,F.PermanentlyDeleteMessage,F.PermanentlyDelete,F.PermanentlyDeleteTitle,(async()=>{const r=e.getRestClient("IWorkItemTrackingRestClient");for(const e of o.value)await r.destroyWorkItem(Number(e),t),n&&n()}))},rank:i}},t[e].getMoveToPositionDialog=function(e,t,n,r){return{disabled:!1,groupKey:"manage-work-item",id:"move-item-to-position",onActivate:()=>{o(e,(e=>i.createElement(w.MoveToPositionDialog,{items:t,onDismiss:e,onMoveToPosition:n})))},rank:r,subtle:!0,text:F.MoveToPositionContentMenuItem,iconProps:{iconName:"NumberedListText"}}};t[e].onAssignToItemActivated=(e,t,o,n)=>{const r=t(),i=new Map,s=[];s.push({fieldName:y.CoreFieldRefNames.AssignedTo,value:(0,b.convertIIdentityToWorkItemIdentityRef)(e,o)}),i.set(k.BulkUpdateConstants.AllTypes,s);(async(t,o)=>{const r=await(0,p.performBulkUpdate)(e,t,o);n&&n(r)})(r.map((e=>Number(e[y.CoreFieldRefNames.Id]))).filter((e=>e)),i)};function o(e,t){e.getService("IVssLayoutManager").renderCallout((e=>t(e)))}t[e].onCopyHTML=(e,t,o)=>{const n=t(),i=function(){const e=document.createElement("div");return e.classList.add("visually-hidden"),e.setAttribute("aria-hidden","true"),e.setAttribute("role","presentation"),e.setAttribute("style","{color: inherit; background-color: inherit;}"),document.body.appendChild(e),e}();if(0===n.length||0===o.length||1===n.length&&n[0][y.CoreFieldRefNames.Id]<0)return void(0,u.copyToClipboard)(i);const s=r(e,o,n);i.innerHTML=s,(0,u.copyToClipboard)(i),document.body.removeChild(i)};const n=(e,t,o)=>{if(2===e)return i.createElement("div",{id:(0,d.getSafeId)(t.id+"-text"),className:"bolt-menuitem-cell-content bolt-menuitem-cell-text flex-column"},i.createElement(c.Tooltip,{overflowOnly:!0,text:t.text},i.createElement("div",{className:"text-ellipsis"},t.text)),i.createElement(c.Tooltip,{overflowOnly:!0,text:t.data.iterationPath},i.createElement("div",{className:"bolt-menuitem-cell-secondary text-ellipsis"},t.data.iterationPath)))};t[e].setIterationItems=(e,t)=>{const o=new s.ObservableArray;if(e&&e.backlogIteration){if(o.push({id:"backlog-menu-item",data:{index:0,id:e.backlogIteration.nodeId,iterationPath:e.backlogIteration.friendlyPath},groupKey:"backlog-and-current",iconProps:{iconName:"Backlog"},onActivate:()=>{t(0,e.backlogIteration)},renderMenuCell:n,text:F.MoveToIteration_Backlog}),(null==e?void 0:e.currentIteration)&&o.push({id:"current-iteration-menu-item",data:{index:1,id:e.currentIteration.nodeId,iterationPath:e.currentIteration.friendlyPath},groupKey:"backlog-and-current",iconProps:{iconName:"TriangleSolidRight12"},onActivate:()=>{t(1,e.currentIteration)},renderMenuCell:n,text:(0,a.format)(F.MoveToIteration_Current,e.currentIteration.displayText)}),e.futureIterations&&e.futureIterations.length>0){o.push({id:"header-backlog-item",itemType:2,text:F.FutureIterations});for(const[r,i]of e.futureIterations.entries())o.push({id:"future-backlog-item",data:{index:2+r,id:i.nodeId,iterationPath:i.friendlyPath},onActivate:()=>{t(2+r,i)},renderMenuCell:n,text:i.displayText})}}else o.push({id:"backlog-menu-item",text:F.MissingTeamSettingsError,iconProps:{iconName:"icon-warning"}});return o};const r=(e,t,o)=>{const n=t.map((e=>`<th style="${x}">${(0,l.htmlEncode)(e.text)}</th>`)),r=`<thead style="${P}"><tr>${n.join("")}</tr></thead>`,i=o.map(((o,n)=>{const r=t.map(((t,n)=>{var r,i,s,a;let m=o[null!==(r=t.name)&&void 0!==r?r:n];if((null===(i=t.name)||void 0===i?void 0:i.toUpperCase())!==y.CoreFieldRefNames.Id.toUpperCase()&&(null===(s=t.name)||void 0===s?void 0:s.toUpperCase())!==y.CoreFieldRefNames.Parent.toUpperCase())m=(0,l.htmlEncode)((0,I.convertValueToDisplayString)(o[null!==(a=t.name)&&void 0!==a?a:n]));else if(t.isIdentity)m=(0,l.htmlEncode)((0,b.convertPotentialIdentityRefFromFieldValue)(e,m));else{m=`<a href="${(0,f.getWorkItemEditUrl)(e,m).url}" style="color:#106ebe" target="_blank">${m}</a>`}return""===m&&(m="&nbsp"),`<td style="${x}">${m}</td>`}));return`<tr style="${n%2?N:M}">${r.join("")}</tr>`})),s=`<tbody style="${R}">${i.join("")}</tbody>`;return`<div><table border="0" cellpadding="0" cellspacing="0" style="${D}">${r}${s}</table></div>`},R="color: inherit;",M="",N="background-color: rgb(124, 124, 124, 0.5)",x="border: 1px solid white;vertical-align: top;padding: 1.45pt .05in;",P="background-color: #106EBE;color: white;",D="font-family: Calibri, sans-serif;font-size: 11pt;"+R+"border-collapse: collapse;"}("CommonWorkItemActions")}),["Resources","extractInfoFromControlMetadata","LinkTypeFilter","CommonWorkItemActions"]),document.dispatchEvent(new CustomEvent("scriptLoaded",{cancelable:!1,detail:{id:"ms.vss-work-web.work-item-utils"}}));