"use strict";define("Wit/AgileAnalytics",["require","exports","Analytics/Boards/RollupQueries/RollupQuery","VSS/Core/Observable","Analytics/Boards/RollupQueries/Contracts","react","VSS/Core/Util/String","VSSUI/Icon","VSSUI/Observer","VSSUI/TooltipEx","VSSUI/Util"],(function(e,t,r,s,o,a,i,n,l,m,c){var u;u=t.Resources={},t.Resources.CannotFindRollupData="Unable to find rollup data for this work item.",t.Resources.InfoIcon="Information icon",t.Resources.RollupBarTooltip="{0}/{1} completed",function(e){t[e]={};class o{constructor(e,t,r){this.pageSize=200,this.workItemIdToRollupData={},this.workItemIdToPageDataPromise={},this.interactiveMode=!1,this.resolvesByPage=[],this.pageContext=e,this.projectId=r,this.rollupMetric=t,this.requestedPageIndicies=[],this.resolvesByPage=[],this.workItemIds=new Set,this.workItemIdToRollupData={},this.workItemIdToPageDataPromise={}}checkAndUpdateWorkItemIds(e){if(!e)return[];const t=[];return e.forEach((e=>{this.workItemIdToRollupData[e]||t.push(e)})),this._initializeWorkItemIdMaps(t),e.forEach((e=>this.workItemIds.add(e))),[...this.workItemIds]}resetWorkItemList(e){this.requestedPageIndicies=[],this.resolvesByPage=[],this.workItemIdToRollupData={},this.workItemIdToPageDataPromise={},this._initializeWorkItemIdMaps(e)}resetRollupData(e,t){this.workItemIdToRollupData={},this.workItemIdToPageDataPromise={},this.interactiveMode=!0,this.witRecency||(this.witRecency={}),e&&(this.witRecency.workItemsChangedUtcTimestamp=e),t&&(this.witRecency.workItemLinksChangedUtcTimestamp=t),this.timerHandle&&clearTimeout(this.timerHandle),this.requestedPageIndicies=[],this.syncDatesPromise=void 0}getRollupData(e,t){const r=this.workItemIdToRollupData[e];return t&&(this.interactiveMode=!0),e<=0||!r?new s.ObservableValue({completedWorkCount:0,totalWorkCount:0,rollupMetric:this.getRollupMetric().type}):(r.value||this.workItemIdToPageDataPromise[e]||this._loadPageData(e).then((e=>{e&&e.forEach((e=>{this.workItemIdToRollupData[e.WorkItemId]?this.workItemIdToRollupData[e.WorkItemId].value=this._interpretData(e):this.workItemIdToRollupData[e.WorkItemId]=new s.ObservableValue(this._interpretData(e))}))})).catch((e=>{let t=e.message;e.error&&e.error.message&&(t=e.error.message),r.value={completedWorkCount:0,totalWorkCount:0,errorMessage:t}})),this.workItemIdToRollupData[e])}getRollupMetric(){return this.rollupMetric}hasWorkItem(e){return this.workItemIds.has(e)}_interpretData(e){const t=e.Descendants;let r=0,s=0;return t.forEach((e=>{e&&(e.Count||e.Sum)&&(e.isCompleted&&(r+=e.Count||e.Sum||0),s+=e.Count||e.Sum||0)})),{completedWorkCount:Math.round(10*r)/10,totalWorkCount:Math.round(10*s)/10,rollupMetric:this.getRollupMetric().type}}_getPageIndex(e){const t=[...this.workItemIds].indexOf(e);return Math.floor(t/this.pageSize)}_getPageInformation(e){const t=this._getPageIndex(e),r=t*this.pageSize;return{pageIndex:t,workItemIds:[...this.workItemIds].slice(r,r+this.pageSize)}}async getWitRecencyData(e){const t=this.pageContext.getService("IVssContributionService");if(!this.witRecency){const e=await t.getDataAsync("ms.vss-work-web.recency-workitem-data-provider");if(!e)return;const r={workItemsChangedUtcTimestamp:e.workItemsChangedDate?e.workItemsChangedDate.getTime():void 0,workItemLinksChangedUtcTimestamp:e.workItemLinksChangedDate?e.workItemLinksChangedDate.getTime():void 0};this.witRecency=r}return this.witRecency}isAnalyticsCaughtUp(e,t){return!(!e.workItemLinksChangedUtcTimestamp&&t.workItemLinksChangedUtcTimestamp||e.workItemLinksChangedUtcTimestamp&&!t.workItemLinksChangedUtcTimestamp||!e.workItemsChangedUtcTimestamp&&t.workItemsChangedUtcTimestamp||e.workItemsChangedUtcTimestamp&&!t.workItemsChangedUtcTimestamp)&&((e.workItemLinksChangedUtcTimestamp>=t.workItemLinksChangedUtcTimestamp||!e.workItemLinksChangedUtcTimestamp&&!t.workItemLinksChangedUtcTimestamp)&&(e.workItemsChangedUtcTimestamp>=t.workItemsChangedUtcTimestamp||!e.workItemsChangedUtcTimestamp&&!t.workItemsChangedUtcTimestamp))}runQueryDelayed(e,t,r){return new Promise((s=>{setTimeout((()=>{s(this.runQuery(e,t+1,r,!0))}),o.badQualityRetryMs)}))}async runQuery(e,t,s,a){const i=this.getWitRecencyData(e),n=Date.now(),l=this.pageContext,m=i.then((async i=>{if(!i)return;const m=new r.RollupQuery(e,this.rollupMetric,this.projectId,this.backlogFilterWorkItemTypes,[{providerTableName:"WorkItemRevision",ExpectedSyncDate:new Date(i.workItemsChangedUtcTimestamp||new Date)},{providerTableName:"WorkItemLink",ExpectedSyncDate:new Date(i.workItemLinksChangedUtcTimestamp||new Date)}]),c=async(r,a)=>this.isAnalyticsCaughtUp(r.syncDates,i)?(this.axRecency=r.syncDates,r.results):t<o.badQualityRetryAttempts&&a?this.runQueryDelayed(e,t,s||n):void(this.axRecency=r.syncDates);if(a){return c(await m.runQuery(l),!0)}if(this.syncDatesPromise){await this.syncDatesPromise;return c(await m.runQuery(l),!1)}{const e=await m.runQuery(l);return this.syncDatesPromise=c(e,!0),this.syncDatesPromise}})).then((t=>(e.forEach((e=>{delete this.workItemIdToPageDataPromise[e]})),t)));return e.forEach((e=>{this.workItemIdToPageDataPromise[e]=m})),m}_loadPageData(e){const t=this._getPageInformation(e);if(this.interactiveMode){const e=setTimeout((()=>{this.resolvesByPage.forEach((e=>{var t;const r=this.runQuery(e.workItemIds,0);null===(t=e.resolves)||void 0===t||t.forEach((async e=>{e(r)}))})),this.resolvesByPage=[],this.timerHandle=0}),o.debounceTimeGetDataMs);return this.timerHandle&&clearTimeout(this.timerHandle),this.timerHandle=e,new Promise((e=>{var r;this.resolvesByPage[t.pageIndex]||(this.resolvesByPage[t.pageIndex]={workItemIds:t.workItemIds,resolves:[]}),null===(r=this.resolvesByPage[t.pageIndex].resolves)||void 0===r||r.push(e)}))}return-1===this.requestedPageIndicies.indexOf(t.pageIndex)&&this.requestedPageIndicies.push(t.pageIndex),this.runQuery(t.workItemIds,0)}_initializeWorkItemIdMaps(e){e.forEach((e=>{this.workItemIdToRollupData[e]=new s.ObservableValue(void 0),delete this.workItemIdToPageDataPromise[e]}))}}t[e].WorkItemRollupProvider=o,o.debounceTimeRequestCountTelemetryMs=1e3,o.debounceTimeGetDataMs=1e4,o.badQualityRetryMs=1e4,o.badQualityRetryAttempts=4}("WorkItemRollupProvider"),function(e){t[e]={};t[e].WorkItemRollupLabel=({className:e,icon:t,rollupData:r,workItemType:s})=>a.createElement(l.Observer,{rollupData:r},(r=>{var o,i;const n=(null===(o=r.rollupData)||void 0===o?void 0:o.completedWorkCount)||0,l=(null===(i=r.rollupData)||void 0===i?void 0:i.totalWorkCount)||0;return l>0?a.createElement("div",{className:(0,c.css)(e,"flex-row")},t,a.createElement(m.Tooltip,{overflowOnly:!0},a.createElement("span",{className:"secondary-text text-ellipsis"},`${s} ${n}/${l}`))):null}));t[e].WorkItemRollupProgressBar=({className:e,icon:t,progressBarClassName:r,rollupData:s})=>a.createElement(l.Observer,{rollupData:s},(s=>{var l,d,h,p;const I=null===(l=s.rollupData)||void 0===l?void 0:l.completedWorkCount,k=null===(d=s.rollupData)||void 0===d?void 0:d.totalWorkCount,g=null===(h=s.rollupData)||void 0===h?void 0:h.rollupMetric,w=null===(p=s.rollupData)||void 0===p?void 0:p.errorMessage;if(void 0!==I&&void 0!==k){if(w)return a.createElement(n.Icon,{ariaLabel:u.InfoIcon,className:"icon-margin",iconName:"Info",tooltipProps:{text:w}});if(g===o.RollupType.Total)return a.createElement("span",null,k);if(k>0){const s=I/k;return a.createElement("div",{className:"flex-row flex-center work-item-rollup-progress-bar"},t,a.createElement(m.Tooltip,{showOnFocus:!0,text:(0,i.format)(u.RollupBarTooltip,I,k)},a.createElement("span",{className:(0,c.css)(e,"work-item-rollup-progress-bar-container flex-row flex-grow scroll-hidden",!t&&"margin-top-1")},a.createElement("span",{className:(0,c.css)(r,"work-item-rollup-progress-bar-bar",I===k&&"completed"),style:{transform:`scaleX(${s})`}}))),a.createElement("span",{className:(0,c.css)("completion-percentage flex-self-start font-size-s secondary-text",t&&"margin-top-1")},`${Math.round(100*s)}%`))}return null}return a.createElement("div",{className:"shimmer shimmer-line work-item-rollup-progress-bar-shimmer"})}))}("ComponentsWorkItemRollupProgressBar")}),["Resources","WorkItemRollupProvider","Components/WorkItemRollupProgressBar"]),document.dispatchEvent(new CustomEvent("scriptLoaded",{cancelable:!1,detail:{id:"ms.vss-work-web.agile-analytics"}}));