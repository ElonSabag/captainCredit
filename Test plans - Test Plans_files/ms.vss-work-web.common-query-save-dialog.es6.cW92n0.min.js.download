"use strict";define("Wit/Common/QuerySaveDialog",["require","exports","react","VSS/Core/Observable","VSSUI/Dropdown","VSSUI/EditableDropdown","VSSUI/Icon","VSSUI/Spinner","VSSUI/TooltipEx","VSSUI/TreeEx","VSSUI/Util","VSSUI/Utilities/DropdownSelection","VSS/Platform/Layout","VSS/Core/TimerManagement","VSS/Core/Util/String","VSSUI/Dialog","VSSUI/FormItem","VSSUI/Observer","VSSUI/TextField","Wit/Common/QueryUtils/Models"],(function(e,t,r,a,i,o,s,n,l,d,u,c,h,m,p,v,y,g,_,S){var Q,b,f;Q=t.Resources={},t.Resources.Cancel="Cancel",t.Resources.EmptyFolder="No items in this folder.",t.Resources.FolderColumn="Folder",t.Resources.MyQueries="My Queries",t.Resources.SharedQueries="Shared Queries",t.Resources.NameLabel="Name",t.Resources.NameLabel_Watermark="Enter name",t.Resources.NewFolder="New folder",t.Resources.NewQueryCommand="New query",t.Resources.OK="OK",t.Resources.QueryFolderPicker_ErrorMessage_FolderDoesNotExist="Specified folder does not exist.",t.Resources.QueryFolderPicker_ErrorMessage_FolderRequired="Folder selection cannot be empty.",t.Resources.QueryFolderPicker_ErrorMessage_NameExceededLimit="Query name should be less than {0} characters, actual is {1}",t.Resources.QuerySaveDialog_ErrorMessage_NameInvalid='Name cannot contain the following characters: /\\<>*?"|:',t.Resources.QuerySaveDialog_ErrorMessage_NameAlreadyExists="A query or folder with this name already exists in the specified folder.",t.Resources.QuerySaveDialog_ErrorMessage_NameRequired="Name cannot be empty.",t.Resources.RenameQueryFolderTitle="Rename query folder",t.Resources.RenameQueryTitle="Rename query",t.Resources.SaveQueryAsDialogTitle="Save query as",function(e){b=t[e]={};t[e].FolderDropdown=e=>{const{items:t,onSetFolder:s,onToggled:n,onValueChange:l,selectedText:d,disabled:u}=e,m=__rest(e,["items","onSetFolder","onToggled","onValueChange","selectedText","disabled"]),p=h,v=r.useRef(t),y=r.useRef(new Map),g=r.useRef(new c.DropdownSelection),_=r.useRef(),S=e=>{const t=v.current.value.filter((e=>!e.parent||e.parent.expanded)).findIndex((t=>t.text===e));t>-1&&g.current.select(t)},Q=()=>{if(!d)return;const e=a.ObservableLike.getValue(d),r=t.value.find((t=>{var r;return!(null===(r=t.data)||void 0===r?void 0:r.isEmptyFolderContext)&&t.data.path===e}));let i=null==r?void 0:r.parent;for(;i;)i.expanded=!0,y.current.set(i.id,!0),i=i.parent;S(e)},b=()=>{for(const e of t.value){const t=y.current.get(e.id);void 0!==t&&(e.expanded=t)}Q()};return r.useEffect((()=>{const e=t.subscribe(b),r=a.ObservableLike.isObservable(d)&&d.subscribe(Q);return()=>{t.unsubscribe(e),r&&a.ObservableLike.isObservable(d)&&d.unsubscribe(r)}}),[t,d]),r.useEffect(Q,[d]),r.createElement(o.EditableDropdown,Object.assign({allowTextSelection:!0,columns:p,items:v.current,filterItems:()=>({filteredItems:v.current.value,filteredIndexMap:v.current.value.map(((e,t)=>t)),filterMatches:[]}),onExpand:()=>{setTimeout((()=>{var e,t;(null===(e=_.current)||void 0===e?void 0:e.current)&&g.current.value.length&&(null===(t=_.current)||void 0===t||t.current.scrollIntoView(g.current.value[0].beginIndex,{block:"nearest"}))}),0)},onToggle:(e,t)=>{if(t.expanded=!t.expanded,y.current.set(t.id,t.expanded),d){const e=a.ObservableLike.getValue(d);S(e)}n&&n(e,t)},onValueChange:e=>{var t,r;if(s){const a=null!==(r=null===(t=null==e?void 0:e.data)||void 0===t?void 0:t.path)&&void 0!==r?r:"";s(a)}l&&l(e)},renderCallout:e=>(_.current=e.listBoxRef,r.createElement(i.DropdownCallout,Object.assign({},e))),renderExpandable:e=>{const t=Object.assign({autoSelect:!0},e);return r.createElement(i.DropdownExpandableTextField,Object.assign({},t))},selection:g.current,selectedText:d,disabled:u,showTree:!0},m))};const h=[{id:"title",width:new a.ObservableValue(-100),renderCell:function(e,t,a,i){var o,c,h;const m=i.underlyingItem.data;let p;if(null===(o=m.data)||void 0===o?void 0:o.isLoadingContext)p=r.createElement(n.Spinner,{size:"medium"});else if(null===(c=m.data)||void 0===c?void 0:c.isEmptyFolderContext)p=r.createElement("span",{className:"bolt-list-cell-child flex-row flex-center bolt-list-cell-text"},r.createElement("span",{className:"secondary-text text-ellipsis"},Q.EmptyFolder,"Â "));else{const e=null===(h=m.data)||void 0===h?void 0:h.name;p=r.createElement("div",{className:"flex-row flex-grow queries-hub-new-folder-dropdown "},r.createElement("span",{className:"bolt-list-cell-child flex-row flex-center bolt-list-cell-text"},r.createElement(s.Icon,{className:(0,u.css)("margin-right-8","queries-folder-icon"),iconName:"FabricFolderFill"}),r.createElement(l.Tooltip,{overflowOnly:!0},r.createElement("span",{className:"inline-flex-row scroll-hidden"},r.createElement("span",{className:"text-ellipsis"},e)))))}return r.createElement(d.ExpandableTreeCell,{className:(0,u.css)(i.className,a.className),columnIndex:t,key:`title-cell-${e}-${t}`,treeColumn:a,treeItem:i},p)}}]}("ComponentsFolderDropdown"),function(e){f=t[e]={};const i=new a.ObservableArray([]);function o(e,t){var r;const a=[];if(e){const r=e.filter((e=>e.isFolder));r&&r.forEach((e=>{const r={id:e.id,expanded:!t,data:e,parent:t,text:e.path},i=[r];e.hasChildren&&i.push(...o(e.children,r)),a.push(...i)}))}else a.push({id:null!==(r=(0,u.getSafeId)(null==t?void 0:t.id))&&void 0!==r?r:"",data:{isEmptyFolderContext:!0,isLoadingContext:!1},expanded:!1,parent:t});return a}t[e].QueryItemDropdown=e=>{const{items:t,onValueChange:a,projectId:s,disabled:n}=e,l=__rest(e,["items","onValueChange","projectId","disabled"]),{pageContext:d}=(0,h.useComponentContext)(),c=d.getService("IQueryListService");r.useEffect((()=>{s||t||(async()=>{if(c.queryTree&&0!==c.queryTree.length||(s?await c.getSharedQueriesByProjectIDAsync(s):await c.getQueriesAsync()),c.queryTree.length>0){const e=c.queryTree.roots.map((e=>e.data));e&&(i.value=o(e))}})()}),[c.isLoading,c.queryTree]),r.useEffect((()=>{s&&p(s)}),[s]);const m=async e=>{const t=o([await c.getQueryWithChildren(e.data)],e.parent);t[0].expanded=!0,i.splice(i.value.findIndex((t=>t.id==e.id)),2,...t)},p=async e=>{if(await c.getSharedQueriesByProjectIDAsync(e),c.queryTree.length>0){const e=c.queryTree.roots.map((e=>e.data));e&&(i.value=o(e))}};return r.createElement(b.FolderDropdown,Object.assign({items:i,onToggled:(e,t)=>{var r;(null===(r=t.data)||void 0===r?void 0:r.isEmptyFolderContext)||(e=>{var t;const r=e.data;if(e.expanded&&r.hasChildren&&!r.children){const r={id:null!==(t=(0,u.getSafeId)(e.id+"-loading"))&&void 0!==t?t:"",data:{isEmptyFolderContext:!0,isLoadingContext:!0},parent:e};i.splice(i.value.findIndex((t=>t.id===e.id))+1,1,r),e.expanded=!0,m(e)}})(t)},onValueChange:async e=>{a&&a(e)},disabled:n},l))}}("ComponentsQueryItemDropdown"),function(e){t[e]={};const i=/\\/g,o=/[\/]+/g,s=new RegExp(/^[^\/\\<>*?\"|:]*$/),n=/\/+$/;class l extends h.VssComponent{constructor(e,t){var r,i,o;super(e,t),this._name=new a.ObservableValue(""),this._nameValidationMessage=new a.ObservableValue(void 0),this._nameValidationError=new a.ObservableValue(!1),this._path=new a.ObservableValue(""),this._pathValidationMessage=new a.ObservableValue(void 0),this._pathValidationError=new a.ObservableValue(!1),this._onKeyDown=e=>{13===e.keyCode&&(this._nameValidationError.value||this._pathValidationError.value||(this._save(),e.preventDefault(),e.stopPropagation()))},this._performFolderPathValidation=async e=>{if(e=e.trim()){const t=this._listService.queryTree.value.filter((e=>{!e.underlyingItem.data.isEmptyFolderContext&&e.underlyingItem.data.path}));if(t&&0!==t.length)return this._pathValidationMessage.value=void 0,void(this._pathValidationError.value=!1);try{return await this._listService.getQueryByPath(e),this._pathValidationMessage.value=void 0,void(this._pathValidationError.value=!1)}catch(e){return this._pathValidationError.value=!0,void(this._pathValidationMessage.value=Q.QueryFolderPicker_ErrorMessage_FolderDoesNotExist)}}else this._pathValidationMessage.value=Q.QueryFolderPicker_ErrorMessage_FolderRequired,this._pathValidationError.value=!0},this._performQueryNameValidation=async e=>{if(e=e&&e.trim())if(s.test(e)){if(e.length>255)this._nameValidationError.value=!0,this._nameValidationMessage.value=(0,p.format)(Q.QueryFolderPicker_ErrorMessage_NameExceededLimit,255,e.length);else if(!this._pathValidationError.value){const t=`${this._path.value}/${e}`,r=this._listService.queryTree.value.filter((e=>{!e.underlyingItem.data.isEmptyFolderContext&&e.underlyingItem.data.path}));if(!r||0===r.length)try{await this._listService.getQueryByPath(t)}catch(e){return this._nameValidationMessage.value=void 0,void(this._nameValidationError.value=!1)}this._nameValidationError.value=!0,this._nameValidationMessage.value=Q.QuerySaveDialog_ErrorMessage_NameAlreadyExists}}else this._nameValidationError.value=!0,this._nameValidationMessage.value=Q.QuerySaveDialog_ErrorMessage_NameInvalid;else this._nameValidationError.value=!0,this._nameValidationMessage.value=Q.QuerySaveDialog_ErrorMessage_NameRequired},this.props.queryItem&&(this._path.value=null!==(r=this._getQueryParentPath())&&void 0!==r?r:""),this._name.value=this.props.mode===S.QuerySaveDialogMode.NewFolder?"":null!==(o=null===(i=this.props.queryItem)||void 0===i?void 0:i.name)&&void 0!==o?o:"",this._path.value||(this._path.value=Q.MyQueries),this._listService=this.context.pageContext.getService("IQueryListService"),this._timerManagement=new m.TimerManagement,this._debouncedQueryNameValidation=this._timerManagement.debounce(this._performQueryNameValidation,400),this._debouncedQueryFolderValidation=this._timerManagement.debounce(this._performFolderPathValidation,400)}componentDidMount(){this._name.value&&this._debouncedQueryNameValidation(this._name.value)}render(){return r.createElement(g.Observer,{name:this._name,nameHasError:this._nameValidationError,path:this._path,pathHasError:this._pathValidationError},(({name:e,nameHasError:t,path:a,pathHasError:i})=>{var o;const s=`${a}/${e}`;return r.createElement(v.Dialog,{titleProps:{text:this._getTitleFromMode(this.props.mode)},onDismiss:()=>this.onDismiss(),footerButtonProps:[{text:Q.Cancel,onClick:()=>this.onDismiss()},{text:Q.OK,disabled:!e||t||i||(this.props.mode===S.QuerySaveDialogMode.SaveAs||this.props.mode===S.QuerySaveDialogMode.RenameQuery)&&s===(null===(o=this.props.queryItem)||void 0===o?void 0:o.path),onClick:()=>this._save(),primary:!0}]},r.createElement(y.FormItem,{label:Q.NameLabel,message:this._nameValidationMessage,error:this._nameValidationError},r.createElement(_.TextField,{onKeyDown:this._onKeyDown,placeholder:Q.NameLabel_Watermark,value:this._name,onChange:(e,t)=>{this._name.value=t,this._debouncedQueryFolderValidation(this._path.value),this._debouncedQueryNameValidation(t)},required:!0})),r.createElement(y.FormItem,{className:"padding-top-16",label:Q.NewFolder,message:this._pathValidationMessage,error:this._pathValidationError},r.createElement(f.QueryItemDropdown,{onSetFolder:e=>{e&&this._setPath(e)},selectedText:this._path})))}))}onDismiss(){this.props.onDismiss&&this.props.onDismiss()}async _createQuery(e,t){return await this._listService.createQuery(e,t,this.props.navigateToQueryOnSave)}_normalizePath(e){return e.replace(i,"/").replace(o,"/").replace(n,"")}async _save(){var e;const t=this._name.value.trim(),r=this._normalizePath(this._path.value).trim(),a=this.props.queryItem;switch(this.props.mode){case S.QuerySaveDialogMode.NewFolder:case S.QuerySaveDialogMode.NewQuery:case S.QuerySaveDialogMode.SaveAs:const i=this.props.mode===S.QuerySaveDialogMode.NewFolder,o={name:t,wiql:a?a.wiql:void 0,isFolder:a?a.isFolder:i,id:void 0,path:`${r}/${t}`},s=await this._createQuery(o,r);this.props.onSave&&s&&this.props.onSave(s.id);break;case S.QuerySaveDialogMode.RenameFolder:case S.QuerySaveDialogMode.RenameQuery:const n=this._normalizePath(this._getQueryParentPath()).trim();if(n!==r){const e=this._listService.queryTree.value.find((e=>{var t;return!e.underlyingItem.data.isEmptyFolderContext&&e.underlyingItem.data.id===(null===(t=this.props.queryItem)||void 0===t?void 0:t.id)})),a=this._listService.queryTree.value.find((e=>!e.underlyingItem.data.isEmptyFolderContext&&e.underlyingItem.data.path===r));if(e&&a){const r=await this._listService.moveQuery(e,a,t);this.props.onRename&&this.props.onRename(r)}}else{const r=Object.assign(Object.assign({},a),{name:t,path:`${n}/${t}`});let i=null===(e=this._listService.queryFolderItem.value)||void 0===e?void 0:e.children.findIndex((e=>e.id===(null==a?void 0:a.id)));void 0!==i&&this._listService.queryFolderItem.value&&(this._listService.queryFolderItem.value.children[i]=r);const o=this._listService.queryTree.value.find((e=>{var t;return!e.underlyingItem.data.isEmptyFolderContext&&e.underlyingItem.data.id===(null===(t=this.props.queryItem)||void 0===t?void 0:t.id)}));await this._listService.updateQuery(r,o),this.props.onRename&&this.props.onRename(r)}}this.onDismiss()}_setPath(e){const t=e||"";this._path.value=e,this._debouncedQueryFolderValidation(t),this._name&&this._debouncedQueryNameValidation(this._name.value)}_getTitleFromMode(e){switch(e){case S.QuerySaveDialogMode.NewFolder:return Q.NewFolder;case S.QuerySaveDialogMode.NewQuery:return Q.NewQueryCommand;case S.QuerySaveDialogMode.RenameQuery:return Q.RenameQueryTitle;case S.QuerySaveDialogMode.RenameFolder:return Q.RenameQueryFolderTitle;case S.QuerySaveDialogMode.SaveAs:return Q.SaveQueryAsDialogTitle}}_getQueryParentPath(){var e,t,r;return this.props.mode===S.QuerySaveDialogMode.RenameQuery||this.props.mode===S.QuerySaveDialogMode.RenameFolder||this.props.mode===S.QuerySaveDialogMode.SaveAs?null===(e=this.props.queryItem)||void 0===e?void 0:e.path.slice(0,null===(t=this.props.queryItem)||void 0===t?void 0:t.path.lastIndexOf("/")):null===(r=this.props.queryItem)||void 0===r?void 0:r.path}}t[e].QuerySaveDialog=l}("ComponentsQuerySaveDialog"),function(e){t[e]={};class i extends h.VssComponent{constructor(e,t){var r;super(e,t),this._path=new a.ObservableValue(""),this.props.queryItem&&(this._path.value=null!==(r=this._getQueryParentPath())&&void 0!==r?r:""),this._path.value||(this._path.value=Q.SharedQueries),this._listService=this.context.pageContext.getService("IQueryListService")}componentDidUpdate(e,t,r){this.props.projectId!==e.projectId&&this._setPath(Q.SharedQueries)}render(){return r.createElement(f.QueryItemDropdown,{onSetFolder:e=>{e&&this._setPath(e)},selectedText:this._path,projectId:this.props.projectId,disabled:this.props.disabled})}async _setPath(e){const t=e||"";this._path.value=e;try{this.props.projectId&&(this.QueryID=await this._listService.getQueryByPath(t,this.props.projectId));let e=this.QueryID;e&&this.props.onQueriesChanged(e.id)}catch(e){}}_getQueryParentPath(){var e,t,r;return this.props.mode===S.QuerySaveDialogMode.RenameQuery||this.props.mode===S.QuerySaveDialogMode.RenameFolder||this.props.mode===S.QuerySaveDialogMode.SaveAs?null===(e=this.props.queryItem)||void 0===e?void 0:e.path.slice(0,null===(t=this.props.queryItem)||void 0===t?void 0:t.path.lastIndexOf("/")):null===(r=this.props.queryItem)||void 0===r?void 0:r.path}}t[e].FolderDropdownGeneral=i,h.VssComponent.register("FolderDropdownGeneral",i)}("ComponentsFolderDropdownGeneral")}),["Resources","Components/FolderDropdown","Components/QueryItemDropdown","Components/QuerySaveDialog","Components/FolderDropdownGeneral"]),document.dispatchEvent(new CustomEvent("scriptLoaded",{cancelable:!1,detail:{id:"ms.vss-work-web.common-query-save-dialog"}}));